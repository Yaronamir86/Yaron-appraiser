<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××¢×¨×›×ª ×—×•×•×ª ×“×¢×ª â€“ ×™×¨×•×Ÿ ×××™×¨ ×©×××™ ×¨×›×•×©</title>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=Frank+Ruhl+Libre:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1419;
    --surface: #161d27;
    --card: #1c2534;
    --card-hover: #212d40;
    --border: #2a3a50;
    --border-light: #334155;
    --accent: #d4a853;
    --accent-dark: #b8892f;
    --accent-glow: rgba(212,168,83,0.15);
    --text-primary: #e8edf3;
    --text-secondary: #8fa3bc;
    --text-muted: #5a7090;
    --success: #22c55e;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    --fire: #f97316;
    --water: #06b6d4;
    --break: #a855f7;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --shadow-lg: 0 8px 48px rgba(0,0,0,0.6);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    min-height: 100vh;
    direction: rtl;
  }

  /* ====== HEADER ====== */
  .header {
    background: linear-gradient(135deg, #0a0f15 0%, #111827 50%, #0d1520 100%);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.5);
  }
  .header-inner {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 70px;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  .logo-text {
    font-family: 'Frank Ruhl Libre', serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  .logo-sub {
    font-size: 0.7rem;
    color: var(--text-muted);
    display: block;
    margin-top: -2px;
    font-weight: 300;
  }
  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* ====== BUTTONS ====== */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 9px 20px;
    border-radius: var(--radius-sm);
    font-family: 'Heebo', sans-serif;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    text-decoration: none;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    color: #0f1419;
    font-weight: 700;
  }
  .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(212,168,83,0.4); }
  .btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { background: var(--card); color: var(--text-primary); }
  .btn-danger {
    background: rgba(239,68,68,0.15);
    color: #ef4444;
    border: 1px solid rgba(239,68,68,0.3);
  }
  .btn-danger:hover { background: rgba(239,68,68,0.25); }
  .btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    font-weight: 700;
  }
  .btn-success:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-lg { padding: 14px 32px; font-size: 1rem; }

  /* ====== LAYOUT ====== */
  .main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* ====== PROGRESS BAR ====== */
  .progress-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .progress-label { font-size: 0.85rem; color: var(--text-muted); min-width: 80px; }
  .progress-bar-outer {
    flex: 1;
    height: 6px;
    background: var(--border);
    border-radius: 99px;
    overflow: hidden;
  }
  .progress-bar-inner {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 99px;
    transition: width 0.5s ease;
  }
  .progress-pct { font-size: 0.85rem; color: var(--accent); font-weight: 600; min-width: 40px; text-align: left; }

  /* ====== STEP TITLE ====== */
  .step-header {
    margin-bottom: 1.5rem;
  }
  .step-header h2 {
    font-family: 'Frank Ruhl Libre', serif;
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.35rem;
  }
  .step-header p {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  /* ====== CARDS ====== */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .card:hover { border-color: var(--border-light); }
  .card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.02);
  }
  .card-header-icon {
    width: 32px; height: 32px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .card-header h3 {
    font-size: 0.95rem;
    font-weight: 600;
    flex: 1;
  }
  .card-header .badge {
    font-size: 0.7rem;
    padding: 3px 10px;
    border-radius: 99px;
    font-weight: 600;
  }
  .badge-required { background: rgba(239,68,68,0.15); color: #ef4444; }
  .badge-optional { background: rgba(100,116,139,0.2); color: var(--text-muted); }
  .card-body { padding: 1.25rem; }

  /* ====== EVENT TYPE SELECTOR ====== */
  .event-types {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .event-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem 1rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }
  .event-card::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.25s;
  }
  .event-card:hover { transform: translateY(-3px); }
  .event-card.active { border-width: 2px; transform: translateY(-3px); }
  .event-card .icon { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }
  .event-card h3 { font-size: 1.05rem; font-weight: 700; margin-bottom: 0.3rem; }
  .event-card p { font-size: 0.78rem; color: var(--text-secondary); }

  .event-card.fire { --ec: var(--fire); }
  .event-card.water { --ec: var(--water); }
  .event-card.break-in { --ec: var(--break); }
  .event-card.earthquake { --ec: #f59e0b; }
  .event-card.other { --ec: var(--text-muted); }

  .event-card:hover { border-color: var(--ec, var(--accent)); box-shadow: 0 0 24px rgba(var(--ec-raw,212,168,83),0.15); }
  .event-card.active { border-color: var(--ec, var(--accent)); background: color-mix(in srgb, var(--ec,var(--accent)) 8%, var(--surface)); box-shadow: 0 0 32px color-mix(in srgb, var(--ec,var(--accent)) 20%, transparent); }
  .event-card.active .check { display: flex !important; }
  .check {
    display: none;
    position: absolute;
    top: 10px;
    left: 10px;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--ec, var(--accent));
    color: white;
    font-size: 12px;
    align-items: center;
    justify-content: center;
  }

  /* ====== FORM ELEMENTS ====== */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-grid.cols-1 { grid-template-columns: 1fr; }

  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }

  label {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.02em;
  }
  label .req { color: var(--accent); margin-right: 3px; }

  input[type="text"], input[type="number"], input[type="date"],
  select, textarea {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    color: var(--text-primary);
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    width: 100%;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
    direction: rtl;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  input::placeholder, textarea::placeholder { color: var(--text-muted); }
  textarea { resize: vertical; min-height: 90px; }
  select option { background: var(--card); }

  /* ====== CHECKBOXES / TOGGLES ====== */
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }
  .checkbox-item:hover { border-color: var(--border-light); background: var(--card); }
  .checkbox-item.checked { border-color: var(--accent); background: var(--accent-glow); }
  .checkbox-item input[type="checkbox"] { display: none; }
  .cb-box {
    width: 20px; height: 20px;
    border: 2px solid var(--border-light);
    border-radius: 5px;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    font-size: 12px;
    color: transparent;
  }
  .checkbox-item.checked .cb-box {
    background: var(--accent);
    border-color: var(--accent);
    color: #0f1419;
  }
  .cb-label { font-size: 0.88rem; font-weight: 500; flex: 1; }
  .cb-sub { font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 1px; }

  /* ====== RADIO GROUPS ====== */
  .radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .radio-btn {
    padding: 8px 16px;
    border: 1.5px solid var(--border);
    border-radius: 99px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    user-select: none;
    color: var(--text-secondary);
    background: var(--surface);
  }
  .radio-btn:hover { border-color: var(--border-light); color: var(--text-primary); }
  .radio-btn.active { border-color: var(--accent); background: var(--accent-glow); color: var(--accent); }

  /* ====== SECTION EXPANDER ====== */
  .section {
    margin-bottom: 1rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .section.has-content { border-color: var(--border-light); }
  .section-trigger {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 1rem 1.25rem;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }
  .section-trigger:hover { background: rgba(255,255,255,0.03); }
  .section-number {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.78rem;
    font-weight: 700;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .section.has-content .section-number { background: var(--accent); color: #0f1419; }
  .section-trigger h3 { font-size: 0.95rem; font-weight: 600; flex: 1; }
  .section-arrow { color: var(--text-muted); transition: transform 0.25s; font-size: 1rem; }
  .section.open .section-arrow { transform: rotate(180deg); }
  .section-content {
    padding: 0 1.25rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.3s;
  }
  .section.open .section-content { max-height: 2000px; padding: 0 1.25rem 1.25rem; }
  .section-divider { border: none; border-top: 1px solid var(--border); margin-bottom: 1rem; }

  /* ====== DAMAGE ITEMS ====== */
  .damage-items { display: flex; flex-direction: column; gap: 8px; margin-bottom: 1rem; }
  .damage-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 10px;
    align-items: center;
    animation: slideIn 0.25s ease;
    transition: border-color 0.2s, opacity 0.2s;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  .damage-item input { margin: 0; }
  .damage-item .remove-btn {
    background: transparent;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 1.1rem;
    padding: 4px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  .damage-item .remove-btn:hover { background: rgba(239,68,68,0.15); }
  .damage-total {
    text-align: left;
    font-size: 0.9rem;
    color: var(--text-secondary);
    padding: 8px 0;
    border-top: 1px solid var(--border);
    margin-top: 4px;
  }
  .damage-total span { color: var(--accent); font-weight: 700; font-size: 1.05rem; }

  /* ====== IMAGE UPLOAD ====== */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
  }
  .upload-zone:hover { border-color: var(--accent); background: var(--accent-glow); }
  .upload-zone .up-icon { font-size: 2rem; margin-bottom: 0.5rem; }
  .upload-zone p { font-size: 0.88rem; color: var(--text-secondary); }
  .upload-zone strong { color: var(--accent); }

  .photo-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 1rem;
  }
  .photo-thumb {
    aspect-ratio: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    position: relative;
    cursor: pointer;
  }
  .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
  .photo-thumb .rm-photo {
    position: absolute; top: 4px; left: 4px;
    background: rgba(0,0,0,0.7);
    border: none; border-radius: 50%;
    color: white; width: 22px; height: 22px;
    font-size: 12px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  .photo-thumb:hover .rm-photo { opacity: 1; }
  .photo-thumb .caption-input {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: rgba(0,0,0,0.75);
    border: none; border-radius: 0;
    color: white; font-size: 0.7rem;
    padding: 4px 8px;
    display: none;
  }
  .photo-thumb:hover .caption-input { display: block; }

  /* ====== STEPS ====== */
  .steps-nav {
    display: flex;
    gap: 4px;
    margin-bottom: 1.5rem;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 4px;
    /* Hide scrollbar but keep functionality */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
  }
  .steps-nav::-webkit-scrollbar {
    display: none; /* Chrome/Safari/Opera */
  }
  .step-pill {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 7px 14px;
    border-radius: 99px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
    border: 1.5px solid var(--border);
    color: var(--text-muted);
    background: transparent;
  }
  .step-pill.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
  .step-pill.done { border-color: var(--success); color: var(--success); background: rgba(34,197,94,0.1); }
  .step-pill .sp-num {
    width: 20px; height: 20px;
    border-radius: 50%;
    background: currentColor;
    color: var(--bg);
    font-size: 0.7rem;
    display: flex; align-items: center; justify-content: center;
    opacity: 0.9;
  }

  /* ====== CONCLUSION CARD ====== */
  .conclusion-box {
    background: linear-gradient(135deg, rgba(212,168,83,0.08), rgba(212,168,83,0.03));
    border: 1.5px solid rgba(212,168,83,0.3);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-top: 1.5rem;
  }
  .conclusion-box h3 {
    font-family: 'Frank Ruhl Libre', serif;
    font-size: 1.15rem;
    color: var(--accent);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .amount-display {
    font-size: 2rem;
    font-weight: 800;
    color: var(--accent);
    font-family: 'Frank Ruhl Libre', serif;
    margin: 0.5rem 0;
  }

  /* ====== PREVIEW / REPORT ====== */
  .report-preview {
    background: #ffffff;
    color: #1a1a2e;
    border-radius: var(--radius);
    padding: 3rem;
    direction: rtl;
    font-family: 'Heebo', sans-serif;
    line-height: 1.7;
    box-shadow: var(--shadow-lg);
    min-height: 400px;
  }
  .report-preview .rp-header {
    text-align: center;
    border-bottom: 3px solid #d4a853;
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
  }
  .report-preview .rp-logo { font-size: 2.5rem; margin-bottom: 0.5rem; }
  .report-preview .rp-title {
    font-family: 'Frank Ruhl Libre', serif;
    font-size: 1.8rem;
    font-weight: 900;
    color: #0f1419;
    margin-bottom: 0.3rem;
  }
  .report-preview .rp-sub { font-size: 0.9rem; color: #64748b; }
  .report-preview .rp-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem 2rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    font-size: 0.88rem;
  }
  .report-preview .rp-meta dt { color: #64748b; font-weight: 600; }
  .report-preview .rp-meta dd { color: #1a1a2e; font-weight: 500; }
  .report-preview h2 {
    font-family: 'Frank Ruhl Libre', serif;
    font-size: 1.1rem;
    color: #0f1419;
    border-right: 4px solid #d4a853;
    padding-right: 10px;
    margin: 1.5rem 0 0.75rem;
  }
  .report-preview p, .report-preview li {
    font-size: 0.9rem;
    color: #334155;
    margin-bottom: 0.4rem;
  }
  .report-preview table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.75rem 0;
    font-size: 0.88rem;
  }
  .report-preview th {
    background: #0f1419;
    color: white;
    padding: 8px 12px;
    text-align: right;
    font-weight: 600;
  }
  .report-preview td {
    padding: 8px 12px;
    border-bottom: 1px solid #e2e8f0;
    color: #334155;
  }
  .report-preview tr:nth-child(even) td { background: #f8fafc; }
  .report-preview .rp-total {
    background: #d4a853;
    color: white;
    padding: 10px 14px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    margin-top: 4px;
  }
  .report-preview .rp-signature {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: #64748b;
  }
  .report-preview .sig-box {
    width: 180px;
    border-top: 1px solid #94a3b8;
    padding-top: 6px;
    text-align: center;
  }

  /* ====== TOAST ====== */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--card);
    border: 1px solid var(--border-light);
    border-radius: 99px;
    padding: 12px 24px;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 999;
    box-shadow: var(--shadow-lg);
    transition: transform 0.35s cubic-bezier(.34,1.56,.64,1);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--success); color: var(--success); }
  .toast.error { border-color: var(--danger); color: var(--danger); }

  /* ====== POLICY TYPE CARDS ====== */
  .policy-type-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 1rem 0.75rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    user-select: none;
  }
  .policy-type-card:hover { border-color: var(--border-light); transform: translateY(-2px); }
  .policy-type-card.active {
    border-color: var(--accent);
    background: var(--accent-glow);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(212,168,83,0.2);
  }
  .pt-icon { font-size: 1.6rem; margin-bottom: 0.35rem; }
  .pt-title { font-size: 0.85rem; font-weight: 700; color: var(--text-primary); }
  .pt-sub { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
  .policy-type-card.active .pt-title { color: var(--accent); }

  /* ====== ADEQUACY BOXES ====== */
  .adequacy-box {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .adequacy-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    text-align: center;
  }
  .adequacy-item .ai-label { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 4px; }
  .adequacy-item .ai-value { font-size: 1.05rem; font-weight: 700; }
  .adequacy-item.danger { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.05); }
  .adequacy-item.warning { border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.05); }
  .adequacy-item.success { border-color: rgba(34,197,94,0.4); background: rgba(34,197,94,0.05); }
  .adequacy-item.danger .ai-value { color: var(--danger); }
  .adequacy-item.warning .ai-value { color: var(--warning); }
  .adequacy-item.success .ai-value { color: var(--success); }

  /* UNDERINSURANCE RULE box */
  .underins-rule {
    background: var(--surface);
    border-right: 4px solid var(--accent);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    padding: 12px 16px;
    font-size: 0.87rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }
  .underins-rule strong { color: var(--text-primary); display: block; margin-bottom: 4px; }

  /* COVERAGE TAG badges */
  .coverage-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 99px;
    font-size: 0.78rem;
    font-weight: 600;
    margin: 2px;
  }
  .coverage-tag.covered { background: rgba(34,197,94,0.15); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
  .coverage-tag.excluded { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); text-decoration: line-through; opacity:0.8; }
  .coverage-tag.partial { background: rgba(245,158,11,0.12); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }

  /* DAMAGE CATEGORY TAG in table */
  .dmg-cat {
    display: inline-block;
    font-size: 0.68rem;
    padding: 2px 7px;
    border-radius: 99px;
    font-weight: 600;
    margin-right: 4px;
  }
  .dmg-cat.structure { background: rgba(59,130,246,0.15); color: #3b82f6; }
  .dmg-cat.contents { background: rgba(168,85,247,0.15); color: #a855f7; }
  .dmg-cat.excluded-tag { background: rgba(239,68,68,0.1); color: #ef4444; }

  /* ====== BOQ â€“ BILL OF QUANTITIES ====== */
  .boq-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 1rem;
    overflow: hidden;
    animation: slideIn 0.25s ease;
  }
  .boq-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.9rem 1.1rem;
    background: rgba(255,255,255,0.025);
    border-bottom: 1px solid var(--border);
  }
  .boq-section-num {
    background: var(--accent);
    color: #0f1419;
    font-size: 0.75rem;
    font-weight: 800;
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .boq-section-title {
    flex: 1;
    font-size: 0.92rem;
    font-weight: 700;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-family: 'Heebo', sans-serif;
    outline: none;
    padding: 4px 6px;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .boq-section-title:focus { background: rgba(255,255,255,0.05); }
  .boq-section-total { font-size: 0.88rem; font-weight: 700; color: var(--accent); white-space: nowrap; }
  .boq-delete-section { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 4px 6px; border-radius: 6px; transition: all 0.15s; }
  .boq-delete-section:hover { background: rgba(239,68,68,0.15); color: var(--danger); }

  .boq-table { width: 100%; border-collapse: collapse; }
  .boq-table thead tr { background: rgba(255,255,255,0.03); }
  .boq-table th { padding: 7px 10px; font-size: 0.72rem; font-weight: 700; color: var(--text-muted); text-align: right; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .boq-table th.num-col { width: 52px; text-align: center; }
  .boq-table th.unit-col { width: 75px; }
  .boq-table th.qty-col { width: 75px; }
  .boq-table th.price-col { width: 95px; }
  .boq-table th.total-col { width: 110px; text-align: left; }
  .boq-table th.act-col { width: 32px; }
  .boq-table td { padding: 5px 10px; border-bottom: 1px solid rgba(42,58,80,0.5); vertical-align: middle; }
  .boq-table td.num-col { font-size: 0.73rem; color: var(--text-muted); text-align: center; font-weight: 600; }
  .boq-table input[type="text"], .boq-table input[type="number"], .boq-table select { background: transparent; border: 1px solid transparent; border-radius: 4px; padding: 5px 7px; color: var(--text-primary); font-family: 'Heebo', sans-serif; font-size: 0.84rem; width: 100%; transition: border-color 0.15s, background 0.15s; outline: none; }
  .boq-table input:hover, .boq-table select:hover { border-color: var(--border-light); background: rgba(255,255,255,0.03); }
  .boq-table input:focus, .boq-table select:focus { border-color: var(--accent); background: rgba(212,168,83,0.06); }
  .boq-table .total-cell { font-weight: 700; color: var(--text-primary); font-size: 0.87rem; text-align: left; }
  .boq-table .del-row { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; padding: 3px 5px; border-radius: 4px; transition: all 0.15s; display: block; margin: auto; }
  .boq-table .del-row:hover { background: rgba(239,68,68,0.15); color: var(--danger); }

  .boq-add-row { display: flex; align-items: center; gap: 8px; padding: 0.6rem 1rem; border-top: 1px dashed var(--border); background: rgba(255,255,255,0.01); }
  .boq-add-row select { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 7px 12px; color: var(--text-secondary); font-family: 'Heebo', sans-serif; font-size: 0.84rem; outline: none; }
  .boq-add-row select:focus { border-color: var(--accent); color: var(--text-primary); }

  .boq-suggestion-tag { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 99px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1.5px solid var(--border); color: var(--text-secondary); background: var(--surface); transition: all 0.18s; user-select: none; }
  .boq-suggestion-tag:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
  .boq-suggestion-tag.added { border-color: var(--success); color: var(--success); background: rgba(34,197,94,0.08); cursor: default; }

  .boq-sum-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-radius: var(--radius-sm); background: var(--surface); border: 1px solid var(--border); margin-bottom: 6px; font-size: 0.88rem; }
  .boq-sum-row .sr-label { color: var(--text-secondary); }
  .boq-sum-row .sr-amount { font-weight: 700; color: var(--text-primary); }
  .boq-sum-row.grand { background: rgba(212,168,83,0.08); border-color: rgba(212,168,83,0.3); }
  .boq-sum-row.grand .sr-label { color: var(--accent); font-weight: 700; }
  .boq-sum-row.grand .sr-amount { color: var(--accent); font-size: 1rem; }

  /* ====== DAMAGE ASSESSMENT TABS ====== */
  .damage-tabs { display: flex; gap: 6px; margin-bottom: 1.25rem; flex-wrap: wrap; }
  .damage-tab {
    padding: 10px 18px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    background: var(--surface);
    color: var(--text-secondary);
    font-size: 0.87rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }
  .damage-tab:hover { border-color: var(--border-light); background: var(--card); }
  .damage-tab.active {
    background: var(--card);
    border-color: var(--accent);
    color: var(--accent);
    border-bottom-color: var(--card);
  }
  .damage-tab-content { background: var(--card); border: 1.5px solid var(--border); border-radius: 0 var(--radius-sm) var(--radius-sm) var(--radius-sm); padding: 1.25rem; min-height: 200px; }
  .damage-tab-panel { display: none; }
  .damage-tab-panel.active { display: block; }
  
  .damage-detail-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 0.75rem;
    overflow: hidden;
  }
  .damage-detail-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    cursor: pointer;
    background: rgba(255,255,255,0.02);
    transition: background 0.15s;
  }
  .damage-detail-header:hover { background: rgba(255,255,255,0.04); }
  .damage-detail-header .icon { font-size: 1.1rem; }
  .damage-detail-header .label { flex: 1; font-size: 0.88rem; font-weight: 600; }
  .damage-detail-header .toggle { font-size: 0.75rem; color: var(--text-muted); transition: transform 0.2s; }
  .damage-detail-section.open .toggle { transform: rotate(180deg); }
  .damage-detail-body {
    padding: 12px 14px;
    border-top: 1px solid var(--border);
    display: none;
  }
  .damage-detail-section.open .damage-detail-body { display: block; }
  .damage-sub-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    margin: 3px 0;
    border-radius: 6px;
    font-size: 0.84rem;
    cursor: pointer;
    transition: background 0.15s;
  }
  .damage-sub-checkbox:hover { background: rgba(255,255,255,0.03); }
  .damage-sub-checkbox input[type="checkbox"] { cursor: pointer; }

  .contents-item {
    display: grid;
    grid-template-columns: 2fr 2fr 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 8px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
  }
  .contents-item input, .contents-item textarea {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 6px 8px;
    color: var(--text-primary);
    font-family: 'Heebo', sans-serif;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.15s, background 0.15s;
  }
  .contents-item input:hover, .contents-item textarea:hover { border-color: var(--border-light); background: rgba(255,255,255,0.02); }
  .contents-item input:focus, .contents-item textarea:focus { border-color: var(--accent); background: rgba(212,168,83,0.05); }
  .contents-item textarea { resize: vertical; min-height: 36px; }
  .contents-item .del-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 1rem;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.15s;
  }
  .contents-item .del-btn:hover { background: rgba(239,68,68,0.15); color: var(--danger); }

  .hidden { display: none !important; }
  .flex { display: flex; }
  .items-center { align-items: center; }
  .justify-between { justify-content: space-between; }
  .gap-2 { gap: 0.5rem; }
  .gap-3 { gap: 0.75rem; }
  .mb-3 { margin-bottom: 0.75rem; }
  .mb-4 { margin-bottom: 1rem; }
  .mt-4 { margin-top: 1rem; }
  .text-sm { font-size: 0.85rem; }
  .text-muted { color: var(--text-muted); }
  .divider { border: none; border-top: 1px solid var(--border); margin: 1.25rem 0; }

  /* ====== RESPONSIVE ====== */
  @media (max-width: 768px) {
    .event-types { grid-template-columns: 1fr 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .form-grid.cols-3 { grid-template-columns: 1fr 1fr; }
    .damage-item { grid-template-columns: 1fr 1fr; }
    .photo-grid { grid-template-columns: repeat(3, 1fr); }
    .main { padding: 1rem; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon" style="background:linear-gradient(135deg, #d4a853, #b8892f);width:42px;height:42px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Frank Ruhl Libre',serif;font-weight:900;font-size:18px;color:#0f1419;box-shadow:0 2px 12px rgba(212,168,83,0.25)">×™×´×</div>
      <div>
        <div class="logo-text">×™×¨×•×Ÿ ×××™×¨</div>
        <span class="logo-sub">×©×××™ ×¨×›×•×© ××•×¡××š</span>
      </div>
    </div>
    <div class="header-actions">
      <div id="saveStatus" style="display:flex;align-items:center;gap:8px;margin-left:1rem;font-size:0.85rem;color:var(--text-secondary)">
        <span style="color:#22c55e">ğŸ’¾</span>
        <span>×©×•××¨ ××•×˜×•××˜×™×ª...</span>
      </div>
      <button class="btn btn-ghost" onclick="manualSave()" title="×©××•×¨ ×¢×›×©×™×•">ğŸ’¾</button>
      <button class="btn btn-ghost" onclick="showDraftMenu()" title="×˜×™×•×˜××•×ª">ğŸ“‚</button>
      <button class="btn btn-ghost" onclick="resetAll()">ğŸ”„ ××™×¤×•×¡</button>
      <button class="btn btn-primary" onclick="goToStep(currentStep+1)" id="headerNextBtn">×”××©×š â†’</button>
    </div>
  </div>
</div>

<div class="main">

  <!-- STEPS NAV -->
  <div class="steps-nav" id="stepsNav">
    <div class="step-pill active" onclick="goToStep(1)" data-step="1">
      <span class="sp-num">1</span> ×¤×¨×˜×™ ×”××‘×•×˜×—
    </div>
    <div class="step-pill" onclick="goToStep(2)" data-step="2">
      <span class="sp-num">2</span> ×¡×•×’ ×”××™×¨×•×¢
    </div>
    <div class="step-pill" onclick="goToStep(3)" data-step="3">
      <span class="sp-num">3</span> ×¤×¨×˜×™ ×”× ×›×¡
    </div>
    <div class="step-pill" onclick="goToStep(4)" data-step="4">
      <span class="sp-num">4</span> ×¤×¨×˜×™ ×”×¤×•×œ×™×¡×”
    </div>
    <div class="step-pill" onclick="goToStep(5)" data-step="5">
      <span class="sp-num">5</span> ×ª×™××•×¨ ×”× ×–×§
    </div>
    <div class="step-pill" onclick="goToStep(6)" data-step="6">
      <span class="sp-num">6</span> ×›×ª×‘ ×›××•×™×•×ª
    </div>
    <div class="step-pill" onclick="goToStep(7)" data-step="7">
      <span class="sp-num">7</span> ×ª××•× ×•×ª ×•××¡××›×™×
    </div>
    <div class="step-pill" onclick="goToStep(8)" data-step="8">
      <span class="sp-num">8</span> ××¡×§× ×•×ª
    </div>
    <div class="step-pill" onclick="goToStep(9)" data-step="9">
      <span class="sp-num">9</span> ×ª×¦×•×’×” ××§×“×™××”
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="progress-wrap">
    <span class="progress-label" id="progLabel">×©×œ×‘ 1 ××ª×•×š 9</span>
    <div class="progress-bar-outer">
      <div class="progress-bar-inner" id="progBar" style="width:11%"></div>
    </div>
    <span class="progress-pct" id="progPct">13%</span>
  </div>

  <!-- ============ STEP 1: CHAPTER A â€“ ALL BASIC DETAILS ============ -->
  <div id="step1" class="step-content">
    <div class="step-header">
      <h2>ğŸ“ ×¤×¨×§ ××³ â€“ ×¤×¨×˜×™ ×”×¤×¨×•×™×§×˜</h2>
      <p>××œ× ××ª ×›×œ ×”× ×ª×•× ×™× ×”×‘×¡×™×¡×™×™× â€” ×”× ×™×–×¨××• ××•×˜×•××˜×™×ª ×œ×›×œ ×©××¨ ×”×˜×•×¤×¡ ×•×”×“×•×—.</p>
    </div>

    <!-- â•â•â• 1. INSURED â•â•â• -->
    <div class="card">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(168,85,247,0.15)">ğŸ‘¤</div>
        <h3>×¤×¨×˜×™ ×”××‘×•×˜×—</h3>
        <span class="badge badge-required">×—×•×‘×”</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-group">
            <label>×©× ××œ× <span class="req">*</span></label>
            <input type="text" id="insuredName" placeholder="×©× ××œ×" oninput="chapterALive()">
          </div>
          <div class="form-group">
            <label>××¡×¤×¨ ×ª.×–. / ×—.×¤. <span class="req">*</span></label>
            <input type="text" id="insuredId" placeholder="×ª.×–. / ×—.×¤." oninput="chapterALive()">
          </div>
          <div class="form-group">
            <label>×˜×œ×¤×•×Ÿ</label>
            <input type="text" id="insuredPhone" placeholder="050-0000000" inputmode="tel">
          </div>
          <div class="form-group">
            <label>×“×•×"×œ</label>
            <input type="text" id="insuredEmail" placeholder="name@email.com" inputmode="email" style="direction:ltr;text-align:right" dir="ltr">
          </div>
          <div class="form-group">
            <label>×›×ª×•×‘×ª ×”× ×›×¡ <span class="req">*</span></label>
            <input type="text" id="propAddress" placeholder="×¨×—×•×‘, ××¡×¤×¨, ×¢×™×¨" oninput="chapterALive()">
          </div>
          <div class="form-group">
            <label>×§×©×¨ ×œ× ×›×¡</label>
            <select id="insuredRelation">
              <option value="">×‘×—×¨...</option>
              <option>×‘×¢×œ×™×</option>
              <option>×©×•×›×¨</option>
              <option>××•×¨×©×” / ××™×•×¤×” ×›×•×—</option>
              <option>×™×¨×•×©×”</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• 2. POLICY â•â•â• -->
    <div class="card" style="margin-top:1rem">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(212,168,83,0.15)">ğŸ›¡ï¸</div>
        <h3>×¤×¨×˜×™ ×”×¤×•×œ×™×¡×”</h3>
        <span class="badge badge-required">×—×•×‘×”</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-group">
            <label>×—×‘×¨×ª ×‘×™×˜×•×— <span class="req">*</span></label>
            <select id="insuranceCompany" onchange="chapterALive()">
              <option value="">×‘×—×¨...</option>
              <option>×”×¤× ×™×§×¡</option>
              <option>×›×œ×œ ×‘×™×˜×•×—</option>
              <option>××’×“×œ</option>
              <option>×”×¨××œ</option>
              <option>×× ×•×¨×” ××‘×˜×—×™×</option>
              <option>××™×™×œ×•×Ÿ</option>
              <option>AIG</option>
              <option>×©×™×¨×‘×™×˜</option>
              <option>×”×›×©×¨×”</option>
              <option>××—×¨</option>
            </select>
          </div>
          <div class="form-group">
            <label>××¡×¤×¨ ×¤×•×œ×™×¡×” <span class="req">*</span></label>
            <input type="text" id="policyNum" placeholder="××¡×¤×¨ ×¤×•×œ×™×¡×”" oninput="chapterALive()">
          </div>
          <div class="form-group">
            <label>××¡×¤×¨ ×ª×‘×™×¢×”</label>
            <input type="text" id="claimNum" placeholder="××¡×¤×¨ ×ª×‘×™×¢×”">
          </div>
          <div class="form-group">
            <label>×©×××™ ×××•× ×” ××˜×¢× ×—×‘×¨×”</label>
            <input type="text" id="adjustorName" placeholder="×©× ×”×©×××™">
          </div>
        </div>

        <hr class="divider" style="margin:1rem 0">

        <div style="font-size:0.82rem;font-weight:700;color:var(--text-muted);margin-bottom:0.75rem;letter-spacing:0.03em">ğŸ“… ×ª×§×•×¤×ª ×”×‘×™×˜×•×—</div>
        <div class="form-grid">
          <div class="form-group">
            <label>××ª××¨×™×š</label>
            <input type="date" id="policyFrom">
          </div>
          <div class="form-group">
            <label>×¢×“ ×ª××¨×™×š</label>
            <input type="date" id="policyTo">
          </div>
        </div>

        <hr class="divider" style="margin:1rem 0">

        <div style="font-size:0.82rem;font-weight:700;color:var(--text-muted);margin-bottom:0.75rem;letter-spacing:0.03em">ğŸ’° ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª</div>
        <div class="form-grid">
          <div class="form-group">
            <label>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª â€“ ××‘× ×” (â‚ª)</label>
            <input type="number" id="deductible" placeholder="0" min="0" oninput="updateBoqTotal()">
          </div>
          <div class="form-group">
            <label>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª â€“ ×ª×›×•×œ×” (â‚ª)</label>
            <input type="number" id="deductibleContents" placeholder="0" min="0" oninput="updateBoqTotal()">
          </div>
          <div class="form-group">
            <label>×¡×•×’ ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª</label>
            <select id="deductibleType">
              <option value="">â€”</option>
              <option>×¡×›×•× ×§×‘×•×¢</option>
              <option>××—×•×– ××”× ×–×§</option>
              <option>×”×’×‘×•×” ××‘×™× ×™×”×</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• 3. KEY DATES â•â•â• -->
    <div class="card" style="margin-top:1rem;border-color:rgba(59,130,246,0.3)">
      <div class="card-header" style="background:rgba(59,130,246,0.04)">
        <div class="card-header-icon" style="background:rgba(59,130,246,0.15)">ğŸ“…</div>
        <h3>×ª××¨×™×›×™× ××¨×›×–×™×™×</h3>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-group">
            <label>×ª××¨×™×š ×§×¨×•×ª ×”××§×¨×” <span class="req">*</span></label>
            <input type="date" id="eventDate" oninput="chapterALive();updateDateConstraints()">
          </div>
          <div class="form-group">
            <label>×ª××¨×™×š ×‘×™×§×•×¨ ×‘× ×›×¡ <span class="req">*</span></label>
            <input type="date" id="visitDate" oninput="chapterALive();refreshDeclaration();updateDateConstraints()">
          </div>
          <div class="form-group">
            <label>×ª××¨×™×š ×§×‘×œ×ª ××¡××š ××—×¨×•×Ÿ</label>
            <input type="date" id="lastDocDate" oninput="updateDateConstraints()">
            <span class="text-sm text-muted" style="margin-top:4px;display:block">××¡××š ××—×¨×•×Ÿ ×©×”×ª×§×‘×œ ××—×‘×¨×ª ×”×‘×™×˜×•×—</span>
          </div>
          <div class="form-group">
            <label>×ª××¨×™×š ×™×¦×™×¨×ª ×”×“×•×—</label>
            <input type="date" id="reportDate" oninput="updateDateConstraints()">
            <span class="text-sm text-muted" style="margin-top:4px;display:block">×‘×¨×™×¨×ª ××—×“×œ: ×ª××¨×™×š ×”×™×•×</span>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• 4. APPRAISER â•â•â• -->
    <div class="card" style="margin-top:1rem;border-color:rgba(212,168,83,0.3)">
      <div class="card-header" style="background:rgba(212,168,83,0.04)">
        <div class="card-header-icon" style="background:rgba(212,168,83,0.15)">ğŸ›ï¸</div>
        <h3>×¤×¨×˜×™ ×”×©×××™ ×”××“×•×•×—</h3>
        <span class="badge" style="background:rgba(212,168,83,0.15);color:var(--accent)">ğŸ”’ ×§×‘×•×¢</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-group">
            <label>×©× ×”×©×××™</label>
            <input type="text" id="appraisalName" value="×™×¨×•×Ÿ ×××™×¨"
              style="opacity:0.75;cursor:default;background:rgba(212,168,83,0.05);border-color:rgba(212,168,83,0.3)">
          </div>
          <div class="form-group">
            <label>××¡×¤×¨ ×¨×™×©×™×•×Ÿ</label>
            <input type="text" id="appraisalLicense" placeholder="××¡×³ ×¨×™×©×™×•×Ÿ" style="direction:ltr">
          </div>
          <div class="form-group">
            <label>×©× ×—×‘×¨×ª ×”×©×××•×ª</label>
            <input type="text" id="appraisalFirm" placeholder="×—×‘×¨×ª ×©×××•×ª">
          </div>
          <div class="form-group">
            <label>×˜×œ×¤×•×Ÿ ××©×¨×“</label>
            <input type="text" id="appraisalPhone" placeholder="03-0000000" inputmode="tel">
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• LIVE SUMMARY â•â•â• -->
    <div id="chapterASummary" style="margin-top:1.25rem;background:rgba(212,168,83,0.06);border:1px solid rgba(212,168,83,0.25);border-radius:var(--radius);padding:1rem 1.25rem">
      <div style="font-size:0.8rem;font-weight:700;color:var(--accent);margin-bottom:0.6rem;letter-spacing:0.04em">ğŸ“‹ ×ª×¦×•×’×” ××§×“×™××” â€“ ×¤×¨×§ ××³</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 1.5rem;font-size:0.82rem;color:var(--text-secondary);line-height:1.8" id="chapterAGrid">
        <div>ğŸ‘¤ ××‘×•×˜×—: <strong id="s_name" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸªª ×ª.×–: <strong id="s_id" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ  × ×›×¡: <strong id="s_addr" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ›¡ï¸ ×—×‘×¨×”: <strong id="s_company" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ“„ ×¤×•×œ×™×¡×”: <strong id="s_policy" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ“‹ ×ª×‘×™×¢×”: <strong id="s_claim" style="color:var(--text-primary)">â€”</strong></div>
        <div>âš¡ ×ª××¨×™×š ××™×¨×•×¢: <strong id="s_event" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ” ×ª××¨×™×š ×‘×™×§×•×¨: <strong id="s_visit" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ“… ×ª×§×•×¤×ª ×‘×™×˜×•×—: <strong id="s_period" style="color:var(--text-primary)">â€”</strong></div>
        <div>ğŸ’° ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª: <strong id="s_ded" style="color:var(--text-primary)">â€”</strong></div>
      </div>
    </div>

  </div>

  <!-- ============ STEP 2: EVENT TYPE ============ -->
  <div id="step2" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ¯ ×¡×•×’ ×”××™×¨×•×¢</h2>
      <p>×‘×—×¨ ××ª ×¡×•×’ ×”××™×¨×•×¢ ×©×’×¨× ×œ× ×–×§. ×”×‘×—×™×¨×” ×ª×§×‘×¢ ××ª ×©××œ×•×ª ×”×¤×¨×§ ×”×¨×œ×•×•× ×˜×™×•×ª.</p>
    </div>

    <div class="event-types">
      <div class="event-card fire" onclick="selectEvent('fire',this)">
        <div class="check">âœ“</div>
        <span class="icon">ğŸ”¥</span>
        <h3>×©×¨×™×¤×”</h3>
        <p>× ×–×§×™ ××©, ×¢×©×Ÿ ×•×¤×™×—</p>
      </div>
      <div class="event-card water" onclick="selectEvent('water',this)">
        <div class="check">âœ“</div>
        <span class="icon">ğŸ’§</span>
        <h3>× ×–×§×™ ××™×</h3>
        <p>×”×¦×¤×”, × ×–×™×œ×”, ×¤×¨×™×¦×ª ×¦× ×¨×ª</p>
      </div>
      <div class="event-card break-in" onclick="selectEvent('break_in',this)">
        <div class="check">âœ“</div>
        <span class="icon">ğŸ”“</span>
        <h3>×¤×¨×™×¦×”</h3>
        <p>×’× ×™×‘×”, ×©×‘×™×¨×”, ×•× ×“×œ×™×–×</p>
      </div>
      <div class="event-card earthquake" onclick="selectEvent('earthquake',this)">
        <div class="check">âœ“</div>
        <span class="icon">ğŸŒ</span>
        <h3>×¨×¢×™×“×ª ××“××”</h3>
        <p>× ×–×§×™× ××¨×¢×™×“×ª ××“××”</p>
      </div>
      <div class="event-card other" onclick="selectEvent('other',this)">
        <div class="check">âœ“</div>
        <span class="icon">ğŸ“‹</span>
        <h3>××—×¨</h3>
        <p>×¡×•×¤×”, ×‘×¨×“, × ×–×§ ×©×•× ×”</p>
      </div>
    </div>

    <div id="eventTypeDetails" class="hidden">
      <div class="card mt-4">
        <div class="card-header">
          <div class="card-header-icon" id="evDetailIcon">ğŸ”</div>
          <h3 id="evDetailTitle">×¤×¨×˜×™ ×”××™×¨×•×¢</h3>
          <span class="badge badge-required">×—×•×‘×”</span>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label>×ª××¨×™×š ×”××™×¨×•×¢</label>
              <input type="date" id="eventDate_display" readonly
                style="opacity:0.65;cursor:default;background:rgba(59,130,246,0.05);border-color:rgba(59,130,246,0.3)"
                title="×ª××¨×™×š ××•×–×Ÿ ×‘×¤×¨×§ ××³">
              <span class="text-sm text-muted" style="display:block;margin-top:3px">â¬… ××•×–×Ÿ ×‘×¤×¨×§ ××³ â€” <a href="#" onclick="goToStep(1);return false" style="color:var(--accent)">×œ×¢×“×›×•×Ÿ</a></span>
            </div>
            <div class="form-group">
              <label>×©×¢×ª ×”××™×¨×•×¢</label>
              <input type="text" id="eventTime" placeholder="×œ×“×•×’××”: 14:30">
            </div>
            <div class="form-group">
              <label>×›×™×¦×“ × ×ª×’×œ×” ×”××™×¨×•×¢ <span class="req">*</span></label>
              <select id="discoveryMethod">
                <option value="">×‘×—×¨...</option>
                <option>×¢×œ ×™×“×™ ×‘×¢×œ ×”× ×›×¡</option>
                <option>×¢×œ ×™×“×™ ×©×›×Ÿ</option>
                <option>×¢×œ ×™×“×™ ×¢×•×‘×“ / ×©×•×›×¨</option>
                <option>×¢×œ ×™×“×™ ×›×•×—×•×ª ×”×‘×™×˜×—×•×Ÿ</option>
                <option>×¢×œ ×™×“×™ ××›×‘×™ ××© / ×—×™×¨×•×</option>
                <option>××—×¨</option>
              </select>
            </div>
            <div class="form-group">
              <label>×”×× ×“×•×•×— ×œ××©×˜×¨×” / ×¨×©×•×™×•×ª</label>
              <div class="radio-group" id="reportedToAuth">
                <div class="radio-btn" onclick="selectRadio(this,'reportedToAuth')">×›×Ÿ</div>
                <div class="radio-btn" onclick="selectRadio(this,'reportedToAuth')">×œ×</div>
                <div class="radio-btn" onclick="selectRadio(this,'reportedToAuth')">×œ× ×¨×œ×•×•× ×˜×™</div>
              </div>
            </div>
          </div>
          <div class="form-group mt-4" style="margin-top:1rem">
            <label>×ª×™××•×¨ ×”××™×¨×•×¢ ×‘×§×¦×¨×” <span class="req">*</span></label>
            <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;gap:8px">
              ğŸ”’ ×××•×œ× ××•×˜×•××˜×™×ª ×œ×¤×™ ×¤×¨×˜×™ ×”××‘×•×˜×— ×•×ª××¨×™×š ×”××™×¨×•×¢
              <button type="button" onclick="autoFillFromInsured()" style="background:rgba(212,168,83,0.15);border:1px solid rgba(212,168,83,0.3);color:var(--accent);border-radius:99px;padding:2px 10px;font-size:0.72rem;cursor:pointer;font-family:inherit">â†º ×¨×¢× ×Ÿ</button>
            </div>
            <textarea id="eventBrief" style="min-height:90px"></textarea>
          </div>

          <!-- FIRE SPECIFIC -->
          <div id="fireSpecific" class="event-specific hidden">
            <hr class="divider">
            <p class="text-sm text-muted mb-3">ğŸ”¥ ×©××œ×•×ª ×™×™×—×•×“×™×•×ª ×œ× ×–×§×™ ×©×¨×™×¤×”</p>
            <div class="form-grid">
              <div class="form-group">
                <label>××§×•×¨ ×”×“×œ×§×”</label>
                <select id="fireCause">
                  <option value="">×‘×—×¨...</option>
                  <option>×§×¦×¨ ×—×©××œ×™</option>
                  <option>×©×™××•×© ×‘× ×¨ / ×’×¤×¨×•×¨×™×</option>
                  <option>×¦×™×•×“ ×—×©××œ×™ ×ª×§×•×œ</option>
                  <option>×”×¦×ª×” ××›×•×•× ×ª</option>
                  <option>×—×•× ×—×™×¦×•× ×™</option>
                  <option>×œ× ×™×“×•×¢</option>
                  <option>××—×¨</option>
                </select>
              </div>
              <div class="form-group">
                <label>×”×™×§×£ ×”×©×¨×™×¤×”</label>
                <div class="radio-group" id="fireScope">
                  <div class="radio-btn" onclick="selectRadio(this,'fireScope')">×—×“×¨ ××—×“</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireScope')">××¡×¤×¨ ×—×“×¨×™×</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireScope')">×›×œ ×”× ×›×¡</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireScope')">××¢×‘×¨ ×œ× ×›×¡</div>
                </div>
              </div>
              <div class="form-group">
                <label>× ×–×§×™ ×¢×©×Ÿ ×•×¤×™×—</label>
                <div class="radio-group" id="smokeScope">
                  <div class="radio-btn" onclick="selectRadio(this,'smokeScope')">××™×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'smokeScope')">×§×œ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'smokeScope')">×‘×™× ×•× ×™</div>
                  <div class="radio-btn" onclick="selectRadio(this,'smokeScope')">×—××•×¨</div>
                </div>
              </div>
              <div class="form-group">
                <label>×”×× ×”×•×¤×¢×œ ××˜×£/×¡×¤×¨×™× ×§×œ×¨</label>
                <div class="radio-group" id="fireExtinguisher">
                  <div class="radio-btn" onclick="selectRadio(this,'fireExtinguisher')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireExtinguisher')">×œ×</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireExtinguisher')">××™×Ÿ</div>
                </div>
              </div>
            </div>
            <div class="form-group" style="margin-top:1rem">
              <label>×”×× ××›×‘×™ ××© ×”×’×™×¢×• ×œ×–×™×¨×”?</label>
              <div class="radio-group" id="fireFighters">
                <div class="radio-btn" onclick="selectRadio(this,'fireFighters')">×›×Ÿ</div>
                <div class="radio-btn" onclick="selectRadio(this,'fireFighters')">×œ×</div>
              </div>
            </div>
            
            <!-- PROFESSIONAL CHECKS -->
            <hr class="divider">
            <p class="text-sm text-muted mb-3" style="font-weight:600;color:var(--accent)">ğŸ” ×‘×“×™×§×•×ª ××§×¦×•×¢×™×•×ª ×•×’×•×¨××™× ××¢×•×¨×‘×™×</p>
            <div class="form-grid">
              <div class="form-group">
                <label>×”×× ×”×•×–××Ÿ ×—×•×§×¨ ×©×¨×™×¤×•×ª?</label>
                <div class="radio-group" id="fireInvestigatorOrdered">
                  <div class="radio-btn" onclick="selectRadio(this,'fireInvestigatorOrdered')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireInvestigatorOrdered')">×œ×</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireInvestigatorOrdered')">×‘×ª×”×œ×™×š</div>
                </div>
              </div>
              <div class="form-group">
                <label>×©× ×”×—×•×§×¨ / ×—×‘×¨×”</label>
                <input type="text" id="fireInvestigatorName" placeholder="×©× ×”×—×•×§×¨ ××• ×”×—×‘×¨×”">
              </div>
              <div class="form-group">
                <label>×”×× ×”×•×’×© ×“×•×— ×—×•×§×¨?</label>
                <div class="radio-group" id="fireInvestigatorReport">
                  <div class="radio-btn" onclick="selectRadio(this,'fireInvestigatorReport')">×›×Ÿ - ×”×•×’×©</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireInvestigatorReport')">×‘×ª×”×œ×™×š</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireInvestigatorReport')">×œ×</div>
                </div>
              </div>
              <div class="form-group">
                <label>×”×× × ×“×¨×© ×§×•× ×¡×˜×¨×•×§×˜×•×¨?</label>
                <div class="radio-group" id="fireConstructorNeeded">
                  <div class="radio-btn" onclick="selectRadio(this,'fireConstructorNeeded')">×›×Ÿ - × ×“×¨×©</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireConstructorNeeded')">×œ× × ×“×¨×©</div>
                  <div class="radio-btn" onclick="selectRadio(this,'fireConstructorNeeded')">×œ× ×‘×¨×•×¨ ×¢×“×™×™×Ÿ</div>
                </div>
              </div>
              <div class="form-group">
                <label>×©× ×§×•× ×¡×˜×¨×•×§×˜×•×¨ (×× ×”×•×–××Ÿ)</label>
                <input type="text" id="fireConstructorName" placeholder="×©× ×”××”× ×“×¡">
              </div>
            </div>
          </div>

          <!-- WATER SPECIFIC -->
          <div id="waterSpecific" class="event-specific hidden">
            <hr class="divider">
            <p class="text-sm text-muted mb-3">ğŸ’§ ×©××œ×•×ª ×™×™×—×•×“×™×•×ª ×œ× ×–×§×™ ××™×</p>
            <div class="form-grid">
              <div class="form-group">
                <label>××§×•×¨ ×”× ×–×™×œ×” / ×”×¦×¤×”</label>
                <select id="waterSource">
                  <option value="">×‘×—×¨...</option>
                  <option>×¦× ×¨×ª ×¤× ×™××™×ª</option>
                  <option>×××‘×˜×™×” / ××§×œ×—×ª</option>
                  <option>××›×•× ×ª ×›×‘×™×¡×” / ××“×™×—</option>
                  <option>×’×’ / ×¨×¢×¤×™×</option>
                  <option>×©×›×Ÿ ××œ××¢×œ×”</option>
                  <option>×”×¦×¤×” ×—×™×¦×•× ×™×ª</option>
                  <option>×œ× ×™×“×•×¢</option>
                  <option>××—×¨</option>
                </select>
              </div>
              <div class="form-group">
                <label>××©×š ×”× ×–×™×œ×”</label>
                <select id="waterDuration" onchange="toggleWaterDurationOther(this)">
                  <option value="">×‘×—×¨...</option>
                  <option>×¤×—×•×ª ××©×¢×”</option>
                  <option>××¡×¤×¨ ×©×¢×•×ª</option>
                  <option>×™×××”</option>
                  <option>××¡×¤×¨ ×™××™×</option>
                  <option>×œ× ×™×“×•×¢</option>
                  <option value="other">××—×¨</option>
                </select>
              </div>
              <div class="form-group" id="waterDurationOtherGroup" style="display:none">
                <label>×¤×¨×˜ ××©×š × ×–×™×œ×”</label>
                <input type="text" id="waterDurationOther" placeholder="×ª××¨ ××ª ××©×š ×”× ×–×™×œ×”...">
              </div>
              <div class="form-group">
                <label>×’×•×‘×” ×”××™× (×‘×§×™×¨×•×‘)</label>
                <input type="text" id="waterLevel" placeholder="×œ×“×•×’××”: 5 ×¡×´×">
              </div>
              <div class="form-group">
                <label>×”×× ×”×¦× ×¨×ª ×ª×•×§× ×”</label>
                <div class="radio-group" id="waterFixed">
                  <div class="radio-btn" onclick="selectRadio(this,'waterFixed')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'waterFixed')">×œ×</div>
                  <div class="radio-btn" onclick="selectRadio(this,'waterFixed')">×‘×ª×”×œ×™×š</div>
                </div>
              </div>
              <div class="form-group">
                <label>×”×× ×™×© ×¢×•×‘×© / ×œ×—×•×ª</label>
                <div class="radio-group" id="moldPresent">
                  <div class="radio-btn" onclick="selectRadio(this,'moldPresent')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'moldPresent')">×œ×</div>
                </div>
              </div>
              <div class="form-group">
                <label>×§×•××ª ×”× ×›×¡ ×©× ×¤×’×¢</label>
                <input type="text" id="waterFloor" placeholder="×œ×“×•×’××”: ×§×•××” 3">
              </div>
            </div>
            
            <!-- PROFESSIONAL CHECKS -->
            <hr class="divider">
            <p class="text-sm text-muted mb-3" style="font-weight:600;color:var(--accent)">ğŸ” ×‘×“×™×§×•×ª ××§×¦×•×¢×™×•×ª ×•×’×•×¨××™× ××¢×•×¨×‘×™×</p>
            <div class="form-grid">
              <div class="form-group">
                <label>×”×× ×”×•×–××Ÿ ×××ª×¨ × ×–×™×œ×•×ª?</label>
                <div class="radio-group" id="leakDetectorOrdered">
                  <div class="radio-btn" onclick="selectRadio(this,'leakDetectorOrdered')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'leakDetectorOrdered')">×œ×</div>
                  <div class="radio-btn" onclick="selectRadio(this,'leakDetectorOrdered')">×‘×ª×”×œ×™×š</div>
                </div>
              </div>
              <div class="form-group">
                <label>×©× ×—×‘×¨×ª ××™×ª×•×¨</label>
                <input type="text" id="leakDetectorCompany" placeholder="×©× ×”×—×‘×¨×”">
              </div>
              <div class="form-group">
                <label>×”×× ×”×•×’×© ×“×•×— ××™×ª×•×¨?</label>
                <div class="radio-group" id="leakDetectorReport">
                  <div class="radio-btn" onclick="selectRadio(this,'leakDetectorReport')">×›×Ÿ - ×”×•×’×©</div>
                  <div class="radio-btn" onclick="selectRadio(this,'leakDetectorReport')">×‘×ª×”×œ×™×š</div>
                  <div class="radio-btn" onclick="selectRadio(this,'leakDetectorReport')">×œ×</div>
                </div>
              </div>
              <div class="form-group">
                <label>×©×¨×‘×¨×‘ ×©×˜×™×¤×œ ×‘×ª×™×§×•×Ÿ</label>
                <div class="radio-group" id="plumberType">
                  <div class="radio-btn" onclick="selectRadio(this,'plumberType')">×”×¡×“×¨</div>
                  <div class="radio-btn" onclick="selectRadio(this,'plumberType')">×¤×¨×˜×™</div>
                  <div class="radio-btn" onclick="selectRadio(this,'plumberType')">×˜×¨× ×”×•×–××Ÿ</div>
                </div>
              </div>
              <div class="form-group">
                <label>×©× ×”×©×¨×‘×¨×‘ / ×—×‘×¨×”</label>
                <input type="text" id="plumberName" placeholder="×©× ×”×©×¨×‘×¨×‘">
              </div>
            </div>
          </div>

          <!-- BREAK-IN SPECIFIC -->
          <div id="break_inSpecific" class="event-specific hidden">
            <hr class="divider">
            <p class="text-sm text-muted mb-3">ğŸ”“ ×©××œ×•×ª ×™×™×—×•×“×™×•×ª ×œ××™×¨×•×¢ ×¤×¨×™×¦×”</p>
            <div class="form-grid">
              <div class="form-group">
                <label>× ×§×•×“×ª ×”×›× ×™×¡×”</label>
                <select id="entryPoint">
                  <option value="">×‘×—×¨...</option>
                  <option>×“×œ×ª ×¨××©×™×ª</option>
                  <option>×“×œ×ª ××—×•×¨×™×ª</option>
                  <option>×—×œ×•×Ÿ</option>
                  <option>××"×“ / ××¨×¤×¡×ª</option>
                  <option>××¤×ª×— ×›×¤×•×œ</option>
                  <option>×œ× ×™×“×•×¢</option>
                  <option>××—×¨</option>
                </select>
              </div>
              <div class="form-group">
                <label>×”×× ×”×™×™×ª×” ××¢×¨×›×ª ××–×¢×§×”</label>
                <div class="radio-group" id="alarmSystem">
                  <div class="radio-btn" onclick="selectRadio(this,'alarmSystem')">×›×Ÿ, ×¤×¢×™×œ×”</div>
                  <div class="radio-btn" onclick="selectRadio(this,'alarmSystem')">×›×Ÿ, ×œ× ×¤×¢×™×œ×”</div>
                  <div class="radio-btn" onclick="selectRadio(this,'alarmSystem')">××™×Ÿ</div>
                </div>
              </div>
              <div class="form-group">
                <label>×”×× ×”×™×™×ª×” ××¦×œ××•×ª ××‘×˜×—×”</label>
                <div class="radio-group" id="cctv">
                  <div class="radio-btn" onclick="selectRadio(this,'cctv')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'cctv')">×œ×</div>
                </div>
              </div>
              <div class="form-group">
                <label>××¡×¤×¨ ×ª×™×§ ××©×˜×¨×”</label>
                <input type="text" id="policeCase" placeholder="××¡×¤×¨ ×ª×™×§">
              </div>
              <div class="form-group">
                <label>×”×× ×”×›× ×™×¡×” × ×¤×¨×¦×” ×‘×›×•×—</label>
                <div class="radio-group" id="forcedEntry">
                  <div class="radio-btn" onclick="selectRadio(this,'forcedEntry')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'forcedEntry')">×œ×</div>
                </div>
              </div>
              <div class="form-group">
                <label>× ×™×–×§×™ ×•× ×“×œ×™×–×</label>
                <div class="radio-group" id="vandalism">
                  <div class="radio-btn" onclick="selectRadio(this,'vandalism')">×›×Ÿ</div>
                  <div class="radio-btn" onclick="selectRadio(this,'vandalism')">×œ×</div>
                </div>
              </div>
            </div>
          </div>

          <!-- EARTHQUAKE SPECIFIC -->
          <div id="earthquakeSpecific" class="event-specific hidden">
            <hr class="divider">
            <p class="text-sm text-muted mb-3">ğŸŒ ×©××œ×•×ª ×™×™×—×•×“×™×•×ª ×œ×¨×¢×™×“×ª ××“××”</p>
            <div class="form-grid">
              <div class="form-group">
                <label>×¢×•×¦××ª ×”×¨×¢×™×“×” (×¨×™×›×˜×¨)</label>
                <input type="number" id="richter" placeholder="×œ×“×•×’××”: 4.5" step="0.1" min="0" max="10">
              </div>
              <div class="form-group">
                <label>×¡×•×’ ×”× ×–×§ ×”××‘× ×™</label>
                <div class="checkbox-group" id="quakeDamage">
                  <label class="checkbox-item">
                    <input type="checkbox"><div class="cb-box">âœ“</div>
                    <span class="cb-label">×¡×“×§×™× ×‘×§×™×¨×•×ª</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox"><div class="cb-box">âœ“</div>
                    <span class="cb-label">× ×–×§ ×œ×ª×§×¨×”</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox"><div class="cb-box">âœ“</div>
                    <span class="cb-label">×¤×’×™×¢×” ×‘×™×¡×•×“×•×ª</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- OTHER SPECIFIC -->
          <div id="otherSpecific" class="event-specific hidden">
            <hr class="divider">
            <p class="text-sm text-muted mb-3">ğŸ“‹ ×ª×™××•×¨ ××™×¨×•×¢ ×›×œ×œ×™</p>
            <div class="form-group">
              <label>×¡×•×’ ×”××™×¨×•×¢ / ×’×•×¨× ×”× ×–×§ <span class="req">*</span></label>
              <input type="text" id="otherEventType" placeholder="×ª××¨ ××ª ×¡×•×’ ×”××™×¨×•×¢ (×¡×•×¤×”, ×‘×¨×“, ×”×ª× ×’×©×•×ª, ...)">
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ============ STEP 2: PROPERTY DETAILS ============ -->
  <div id="step3" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ  ×¤×¨×˜×™ ×”× ×›×¡</h2>
      <p>××œ× ××ª ×¤×¨×˜×™ ×”× ×›×¡ ×”× ×™×–×•×§ ×œ×¦×•×¨×š ×–×™×”×•×™ ×•×ª×™×¢×•×“ ××“×•×™×§.</p>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(59,130,246,0.15)">ğŸ“</div>
        <h3>××™×§×•× ×”× ×›×¡</h3>
        <span class="badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">××¤×¨×§ ××³</span>
      </div>
      <div class="card-body">
        <div style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.2);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:1rem;font-size:0.84rem;color:#60a5fa">
          ğŸ’¡ ×©× ×”××‘×•×˜×— ×•×”×›×ª×•×‘×ª ×××•×œ××™× ××•×˜×•××˜×™×ª ××¤×¨×§ ××³. <a href="#" onclick="goToStep(1);return false" style="color:#3b82f6;text-decoration:underline">×œ×—×¥ ×›××Ÿ ×œ×¢×“×›×•×Ÿ</a>
        </div>
        <div class="form-grid cols-2" style="margin-bottom:1rem">
          <div class="form-group">
            <label>×©× ×”××‘×•×˜×— (××¤×¨×§ ××³)</label>
            <input type="text" id="propOwnerDisplay" readonly style="opacity:0.65;cursor:default;background:rgba(59,130,246,0.05);border-color:rgba(59,130,246,0.3)">
          </div>
          <div class="form-group">
            <label>×›×ª×•×‘×ª (××¤×¨×§ ××³)</label>
            <input type="text" id="propAddressDisplay" readonly style="opacity:0.65;cursor:default;background:rgba(59,130,246,0.05);border-color:rgba(59,130,246,0.3)">
          </div>
        </div>
        <div class="form-grid cols-3">
          <div class="form-group">
            <label>×¨×—×•×‘ <span class="req">*</span></label>
            <input type="text" id="propStreet" placeholder="×¨×—×•×‘">
          </div>
          <div class="form-group">
            <label>××¡×¤×¨ ×‘×™×ª</label>
            <input type="text" id="propNum" placeholder="××¡×³">
          </div>
          <div class="form-group">
            <label>×“×™×¨×”</label>
            <input type="text" id="propApt" placeholder="×“×™×¨×”">
          </div>
          <div class="form-group">
            <label>×¢×™×¨ / ×™×™×©×•×‘ <span class="req">*</span></label>
            <input type="text" id="propCity" placeholder="×¢×™×¨">
          </div>
          <div class="form-group">
            <label>×§×•×“ ×“×™×¨×” / ×’×•×© ×—×œ×§×”</label>
            <input type="text" id="propParcel" placeholder="×’×•×© / ×—×œ×§×”">
          </div>
          <div class="form-group">
            <label>×§×•××”</label>
            <input type="text" id="propFloor" placeholder="×§×•××”">
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-4" style="margin-top:1rem">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(34,197,94,0.15)">ğŸ—ï¸</div>
        <h3>×××¤×™×™× ×™ ×”× ×›×¡</h3>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="form-group">
            <label>×¡×•×’ ×”× ×›×¡ <span class="req">*</span></label>
            <select id="propType">
              <option value="">×‘×—×¨...</option>
              <option>×“×™×¨×ª ××’×•×¨×™×</option>
              <option>×‘×™×ª ×¤×¨×˜×™ / ×§×•×˜×’×³</option>
              <option>× ×›×¡ ××¡×—×¨×™</option>
              <option>××©×¨×“</option>
              <option>××—×¡×Ÿ / ××¤×¢×œ</option>
              <option>××‘× ×” ×—×§×œ××™</option>
              <option>××—×¨</option>
            </select>
          </div>
          <div class="form-group">
            <label>×©× ×ª ×‘× ×™×™×” (××©×•×¢×¨×ª)</label>
            <input type="number" id="propYear" placeholder="×©× ×ª ×‘× ×™×™×”" min="1900" max="2025">
          </div>
          <div class="form-group">
            <label>×©×˜×— ×”× ×›×¡ (×"×¨)</label>
            <input type="number" id="propArea" placeholder="××´×¨">
          </div>
          <div class="form-group">
            <label>×—×•××¨ ×”×‘× ×™×™×”</label>
            <select id="propMaterial">
              <option value="">×‘×—×¨...</option>
              <option>×‘× ×™×™×” ×§×•× ×‘× ×¦×™×•× ×œ×™×ª - ×‘×œ×•×§×™× ×•×‘×˜×•×Ÿ</option>
              <option>×‘×˜×•×Ÿ ×•×‘×¨×–×œ</option>
              <option>×œ×‘× ×” ××¡×•×¨×ª×™×ª</option>
              <option>×¢×¥</option>
              <option>×¤×œ×“×ª ××¡×’×¨×ª</option>
              <option>××‘× ×” ×™×™×—×•×“×™</option>
              <option>××—×¨</option>
            </select>
          </div>
          <div class="form-group">
            <label>××¦×‘ ×”× ×›×¡ ×œ×¤× ×™ ×”××™×¨×•×¢</label>
            <select id="propConditionBefore">
              <option value="">×‘×—×¨...</option>
              <option>×—×“×© / ××¦×•×™×™×Ÿ</option>
              <option>×˜×•×‘</option>
              <option>×¡×‘×™×¨</option>
              <option>×™×©×Ÿ / ×“×¨×•×© ×©×™×¤×•×¥</option>
            </select>
          </div>
          <div class="form-group">
            <label>×©×™××•×© ×‘× ×›×¡</label>
            <div class="radio-group" id="propUsage">
              <div class="radio-btn" onclick="selectRadio(this,'propUsage')">××’×•×¨×™×</div>
              <div class="radio-btn" onclick="selectRadio(this,'propUsage')">×¢×¡×§×™</div>
              <div class="radio-btn" onclick="selectRadio(this,'propUsage')">××¢×•×¨×‘</div>
              <div class="radio-btn" onclick="selectRadio(this,'propUsage')">×¨×™×§</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ STEP 4: POLICY DETAILS ============ -->
  <div id="step4" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ›¡ï¸ ×¤×¨×˜×™ ×”×¤×•×œ×™×¡×”</h2>
      <p>×¤×¨×˜×™ ×—×‘×¨×ª ×”×‘×™×˜×•×—, ×”×¤×•×œ×™×¡×” ×•×’×‘×•×œ×•×ª ×”×›×™×¡×•×™.</p>
    </div>

    <!-- POLICY TYPE CARD -->
    <div class="card mt-4" style="margin-top:1rem;border-color:rgba(212,168,83,0.35)">
      <div class="card-header" style="background:rgba(212,168,83,0.05)">
        <div class="card-header-icon" style="background:rgba(212,168,83,0.2)">ğŸ“‹</div>
        <h3>×¡×•×’ ×¤×•×œ×™×¡×” ×•×’×‘×•×œ×•×ª ×›×™×¡×•×™</h3>
        <span class="badge badge-required">×—×•×‘×”</span>
      </div>
      <div class="card-body">

        <!-- POLICY TYPE SELECTOR -->
        <label style="margin-bottom:8px;display:block">×¡×•×’ ×”×¤×•×œ×™×¡×” <span class="req">*</span></label>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:1.25rem" id="policyTypeGrid">
          <div class="policy-type-card" data-type="structure_mortgage" onclick="selectPolicyType(this)">
            <div class="pt-icon">ğŸ¦</div>
            <div class="pt-title">××‘× ×” â€“ ××©×›× ×ª×</div>
            <div class="pt-sub">×“×¨×š ×”×‘× ×§ / ××œ×•×•×”</div>
          </div>
          <div class="policy-type-card" data-type="structure_only" onclick="selectPolicyType(this)">
            <div class="pt-icon">ğŸ—ï¸</div>
            <div class="pt-title">××‘× ×” ×‘×œ×‘×“</div>
            <div class="pt-sub">×‘×™×˜×•×— ××‘× ×” ×¢×¦×××™</div>
          </div>
          <div class="policy-type-card" data-type="structure_contents" onclick="selectPolicyType(this)">
            <div class="pt-icon">ğŸ </div>
            <div class="pt-title">××‘× ×” + ×ª×›×•×œ×”</div>
            <div class="pt-sub">×›×™×¡×•×™ ××œ×</div>
          </div>
          <div class="policy-type-card" data-type="contents_only" onclick="selectPolicyType(this)">
            <div class="pt-icon">ğŸ“¦</div>
            <div class="pt-title">×ª×›×•×œ×” ×‘×œ×‘×“</div>
            <div class="pt-sub">×¦×™×•×“ ×•×¨×›×•×© ××™×©×™</div>
          </div>
          <div class="policy-type-card" data-type="comprehensive" onclick="selectPolicyType(this)">
            <div class="pt-icon">â­</div>
            <div class="pt-title">×›×œ ×”×¡×™×›×•× ×™×</div>
            <div class="pt-sub">×¤×•×œ×™×¡×” ××•×¨×—×‘×ª</div>
          </div>
          <div class="policy-type-card" data-type="other_policy" onclick="selectPolicyType(this)">
            <div class="pt-icon">ğŸ“</div>
            <div class="pt-title">××—×¨</div>
            <div class="pt-sub">×¤×•×œ×™×¡×” ××™×•×—×“×ª</div>
          </div>
        </div>

        <!-- POLICY ALERT - shows based on type -->
        <div id="policyAlert" style="display:none;border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:1.25rem;font-size:0.87rem;font-weight:500;display:none;align-items:center;gap:10px"></div>

        <!-- STRUCTURE COVERAGE -->
        <div id="structureCoverageSection" style="display:none">
          <hr class="divider">
          <p style="font-size:0.83rem;font-weight:700;color:var(--text-muted);letter-spacing:0.05em;margin-bottom:0.75rem">ğŸ—ï¸ ×›×™×¡×•×™ ××‘× ×”</p>
          <div class="form-grid cols-3">
            <div class="form-group">
              <label>×’×‘×•×œ ×›×™×¡×•×™ ××‘× ×” (â‚ª) <span class="req">*</span></label>
              <input type="text" id="structureCoverageLimit" placeholder="×œ×“×•×’××”: 1,500,000" oninput="formatCurrency(this);calcInsuranceAdequacy()" inputmode="numeric">
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ××‘× ×” ×œ×”×¢×¨×›×ª ×©×××™ (â‚ª)</label>
              <input type="text" id="structureAppraisedValue" placeholder="×©×•×•×™ ×©×××™" oninput="formatCurrency(this);calcInsuranceAdequacy()" inputmode="numeric">
            </div>
            <div class="form-group">
              <label>×¢×œ×•×ª ×‘× ×™×™×” ×œ×"×¨ (â‚ª)</label>
              <input type="text" id="buildingCostPerSqm" placeholder="×œ×“×•×’××”: 12,000" oninput="formatCurrency(this);calcBuildingCost()" inputmode="numeric">
            </div>
          </div>
          <div id="structureAdequacyBox" style="display:none;margin-top:0.75rem"></div>
        </div>

        <!-- CONTENTS COVERAGE -->
        <div id="contentsCoverageSection" style="display:none">
          <hr class="divider">
          <p style="font-size:0.83rem;font-weight:700;color:var(--text-muted);letter-spacing:0.05em;margin-bottom:0.75rem">ğŸ“¦ ×›×™×¡×•×™ ×ª×›×•×œ×”</p>
          <div class="form-grid cols-3">
            <div class="form-group">
              <label>×’×‘×•×œ ×›×™×¡×•×™ ×ª×›×•×œ×” (â‚ª) <span class="req">*</span></label>
              <input type="text" id="contentsCoverageLimit" placeholder="×œ×“×•×’××”: 200,000" oninput="formatCurrency(this);calcInsuranceAdequacy()" inputmode="numeric">
            </div>
            <div class="form-group">
              <label>×©×•×•×™ ×ª×›×•×œ×” ××•×¢×¨×š (â‚ª)</label>
              <input type="text" id="contentsAppraisedValue" placeholder="×©×•×•×™ ××•×¢×¨×š" oninput="formatCurrency(this);calcInsuranceAdequacy()" inputmode="numeric">
            </div>
            <div class="form-group">
              <label>×‘×¡×™×¡ ×¤×™×¦×•×™ ×ª×›×•×œ×”</label>
              <select id="contentsCompensationBasis">
                <option value="">×‘×—×¨...</option>
                <option value="replacement">×¢×¨×š ×›×™× ×•×Ÿ (×—×“×© ×ª×—×ª ×™×©×Ÿ)</option>
                <option value="actual">×¢×¨×š ×‘×¤×•×¢×œ (×‘× ×™×›×•×™ ×¤×—×ª)</option>
                <option value="agreed">×¢×¨×š ××•×¡×›×</option>
              </select>
            </div>
          </div>
          <div id="contentsAdequacyBox" style="display:none;margin-top:0.75rem"></div>
        </div>

        <!-- EXTENSIONS -->
        <div id="extensionsSection" style="display:none">
          <hr class="divider">
          <p style="font-size:0.83rem;font-weight:700;color:var(--text-muted);letter-spacing:0.05em;margin-bottom:0.75rem">ğŸ”§ ×”×¨×—×‘×•×ª ×œ×¤×•×œ×™×¡×”</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="extensionsGrid">
            <label class="checkbox-item">
              <input type="checkbox" value="×¦×“ ×’'"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×¦×“ ×’'</span><span class="cb-sub">××—×¨×™×•×ª ×›×œ×¤×™ ×¦×“ ×©×œ×™×©×™</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×©×›"×“ ×—×œ×•×¤×™"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×©×›"×“ ×—×œ×•×¤×™</span><span class="cb-sub">×“××™ ×©×›×™×¨×•×ª ×‘×–××Ÿ ×©×™×§×•×</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="× ×–×§×™ ××™×"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×”×¨×—×‘×ª × ×–×§×™ ××™×</span><span class="cb-sub">× ×–×™×œ×•×ª, ×”×¦×¤×•×ª, ×¦× ×¨×ª</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×¤×¨×™×¦×” ×•×’× ×™×‘×”"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×¤×¨×™×¦×” ×•×’× ×™×‘×”</span><span class="cb-sub">×›×œ×•×œ ×‘×¤×•×œ×™×¡×”</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×¨×¢×™×“×ª ××“××”"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×¨×¢×™×“×ª ××“××”</span><span class="cb-sub">×”×¨×—×‘×” ××™×•×—×“×ª</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×¡×™×™×‘×¨"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×¡×™×™×‘×¨ / ×’× ×™×‘×ª ×–×”×•×ª</span><span class="cb-sub">×”×’× ×” ×“×™×’×™×˜×œ×™×ª</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×¦×™×•×“ ×—×©××œ×™"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×¦×™×•×“ ×—×©××œ×™ ×•××œ×§×˜×¨×•× ×™</span><span class="cb-sub">××›×©×™×¨×™× ×•××œ×§×˜×¨×•× ×™×§×”</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×›×œ×™ ×¢×‘×•×“×” ×•×¦×™×•×“ ××§×¦×•×¢×™"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×›×œ×™ ×¢×‘×•×“×” / ×¦×™×•×“ ××§×¦×•×¢×™</span><span class="cb-sub">×œ× ×›×¡×™× ×¢×¡×§×™×™×</span></div>
            </label>
          </div>
          <div class="form-group" style="margin-top:1rem">
            <label>×”×¨×—×‘×•×ª × ×•×¡×¤×•×ª (×™×“× ×™)</label>
            <input type="text" id="extraExtensions" placeholder="×”×¨×—×‘×•×ª ×©××™× ×Ÿ ×‘×¨×©×™××”...">
          </div>
        </div>

        <!-- DEDUCTIBLES PER POLICY -->
        <div id="policyDeductiblesSection" style="display:none">
          <hr class="divider">
          <p style="font-size:0.83rem;font-weight:700;color:var(--text-muted);letter-spacing:0.05em;margin-bottom:0.75rem">ğŸ’³ ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª ×œ×¤×™ ×¤×•×œ×™×¡×”</p>
          <div class="form-grid cols-3">
            <div class="form-group">
              <label>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª ××‘× ×” (â‚ª / %)</label>
              <input type="text" id="policyDeductibleStructure" placeholder="×œ×“×•×’××”: 1,500 ××• 1%">
            </div>
            <div class="form-group" id="contentsDeductibleGroup">
              <label>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª ×ª×›×•×œ×” (â‚ª / %)</label>
              <input type="text" id="policyDeductibleContents" placeholder="×œ×“×•×’××”: 500">
            </div>
            <div class="form-group">
              <label>×”×¨×—×‘×•×ª â€“ ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª</label>
              <input type="text" id="policyDeductibleExtensions" placeholder="×œ×“×•×’××”: 2,500 × ×–×§×™ ××™×">
            </div>
          </div>
        </div>

        <!-- UNDERINSURANCE SUMMARY -->
        <div id="underinsuranceSummary" style="display:none;margin-top:1rem">
          <hr class="divider">
          <p style="font-size:0.83rem;font-weight:700;color:var(--text-muted);letter-spacing:0.05em;margin-bottom:0.75rem">âš–ï¸ × ×™×ª×•×— ×”×œ×™××•×ª ×‘×™×˜×•×— / ×ª×ª-×‘×™×˜×•×—</p>
          <div id="underinsuranceContent"></div>
          <div class="form-group" style="margin-top:1rem">
            <label>×”×¢×¨×•×ª ×”×œ×™××•×ª ×‘×™×˜×•×—</label>
            <textarea id="underinsuranceNotes" placeholder="×”×¡×‘×¨ ××§×¦×•×¢×™ ×œ×’×‘×™ ××¦×‘ ×”×›×™×¡×•×™, ×ª×ª-×‘×™×˜×•×—, ×•×”×©×œ×›×•×ª ×œ×ª×‘×™×¢×”..."></textarea>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- ============ STEP 4: DAMAGE DESCRIPTION ============ -->
  <div id="step5" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ“‹ ×ª×™××•×¨ ×”× ×–×§</h2>
      <p>×ª××¨ ×‘×¤×™×¨×•×˜ ××ª ××–×•×¨×™ ×”× ×›×¡ ×©× ×¤×’×¢×• ×•××ª ××”×•×ª ×”× ×–×§ ×‘×›×œ ××–×•×¨.</p>
    </div>

    <!-- AREAS AFFECTED -->
    <div class="card mb-4" style="margin-bottom:1rem">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(239,68,68,0.15)">ğŸ—ºï¸</div>
        <h3>××–×•×¨×™× ×©× ×¤×’×¢×•</h3>
        <span class="badge badge-required">×¡××Ÿ ××ª ×›×œ ×”××–×•×¨×™×</span>
      </div>
      <div class="card-body">
        <div class="form-grid">
          <div class="checkbox-group" id="damagedAreas">
            <label class="checkbox-item">
              <input type="checkbox" value="×¡×œ×•×Ÿ / ××’×•×¨×™×"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×¡×œ×•×Ÿ / ××’×•×¨×™×</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×—×“×¨ ×©×™× ×” ×¨××©×™"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×—×“×¨ ×©×™× ×” ×¨××©×™</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×—×“×¨×™ ×©×™× ×” × ×•×¡×¤×™×"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×—×“×¨×™ ×©×™× ×” × ×•×¡×¤×™×</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="××˜×‘×—"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">××˜×‘×—</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×—×“×¨ ×××‘×˜×™×”"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×—×“×¨ ×××‘×˜×™×”</span></div>
            </label>
          </div>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" value="××¨×¤×¡×ª"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">××¨×¤×¡×ª</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="××—×¡×Ÿ"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">××—×¡×Ÿ</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×—× ×™×”"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×—× ×™×”</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×’×’ / ×¢×œ×™×™×ª ×’×’"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×’×’ / ×¢×œ×™×™×ª ×’×’</span></div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="×›×œ ×”× ×›×¡"><div class="cb-box">âœ“</div>
              <div><span class="cb-label">×›×œ ×”× ×›×¡</span></div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- DAMAGE TYPE DETAILS -->
    <div class="card">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(245,158,11,0.15)">ğŸ”</div>
        <h3>×¡×•×’×™ × ×–×§</h3>
      </div>
      <div class="card-body">
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ××‘× ×™"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ××‘× ×™</span><span class="cb-sub">×§×™×¨×•×ª, ×¢××•×“×™×, ×’×’, ×ª×§×¨×”, ×™×¡×•×“×•×ª</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ×œ×¨×™×¦×•×£ ×•××¨×™×—×™×"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ×œ×¨×™×¦×•×£ ×•××¨×™×—×™×</span><span class="cb-sub">×©×‘×™×¨×”, ×”×¨××”, ×›×ª××™×</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ×œ×—×™×¤×•×™×™ ×§×™×¨"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ×œ×—×™×¤×•×™×™ ×§×™×¨</span><span class="cb-sub">×˜×™×—, ×¦×‘×¢, ×˜×¤×˜×™×, ×¤×× ×œ×™×</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ×œ× ×’×¨×™×™×” ×•×¦×™×¨×•×¤×™×"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ×œ× ×’×¨×™×™×” ×•×¦×™×¨×•×¤×™×</span><span class="cb-sub">×“×œ×ª×•×ª, ×—×œ×•× ×•×ª, ××¨×•× ×•×ª</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ×œ××¢×¨×›×•×ª ×—×©××œ"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ×œ××¢×¨×›×•×ª ×—×©××œ</span><span class="cb-sub">×œ×•×— ×—×©××œ, ×›×‘×œ×™×, ×©×§×¢×™×</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ×œ××™× ×¡×˜×œ×¦×™×”"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ×œ××™× ×¡×˜×œ×¦×™×”</span><span class="cb-sub">×¦× ×¨×ª, ×‘×¨×–×™×, ×‘×™×•×‘</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="× ×–×§ ×œ×ª×›×•×œ×” ×•×¨×”×™×˜×™×"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×–×§ ×œ×ª×›×•×œ×” ×•×¨×”×™×˜×™×</span><span class="cb-sub">×¨×”×™×˜×™×, ××›×©×™×¨×™ ×—×©××œ, ×¦×™×•×“</span></div>
          </label>
        </div>

        <div class="form-group mt-4" style="margin-top:1rem">
          <label>×ª×™××•×¨ ×”× ×–×§ ×”××¤×•×¨×˜</label>
          <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;gap:8px">
            <span>ğŸ“ × ×•×¡×— ×¤×ª×™×—×” ××•×˜×•××˜×™ â€” × ×™×ª×Ÿ ×œ×¢×¨×•×š</span>
            <button type="button" onclick="refreshDamageTemplate()" style="background:rgba(212,168,83,0.15);border:1px solid rgba(212,168,83,0.3);color:var(--accent);border-radius:99px;padding:2px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit">â†º ×¨×¢× ×Ÿ</button>
          </div>
          <textarea id="damageDescription" style="min-height:130px"></textarea>
        </div>

        <div class="form-grid mt-4" style="margin-top:1rem">
          <div class="form-group">
            <label>×—×•××¨×ª ×”× ×–×§ ×”×›×•×œ×œ×ª</label>
            <div class="radio-group" id="damageSeverity">
              <div class="radio-btn" onclick="selectRadio(this,'damageSeverity')">×§×œ</div>
              <div class="radio-btn" onclick="selectRadio(this,'damageSeverity')">×‘×™× ×•× ×™</div>
              <div class="radio-btn" onclick="selectRadio(this,'damageSeverity')">×—××•×¨</div>
              <div class="radio-btn" onclick="selectRadio(this,'damageSeverity')">×”×¨×¡× ×™</div>
            </div>
          </div>
          <div class="form-group">
            <label>×”×× ×”× ×›×¡ × ×™×ª×Ÿ ×œ×“×™×•×¨ / ×©×™××•×©</label>
            <div class="radio-group" id="propUsable">
              <div class="radio-btn" onclick="selectRadio(this,'propUsable')">×›×Ÿ</div>
              <div class="radio-btn" onclick="selectRadio(this,'propUsable')">×—×œ×§×™×ª</div>
              <div class="radio-btn" onclick="selectRadio(this,'propUsable')">×œ×</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ STEP 5: BILL OF QUANTITIES ============ -->
  <div id="step6" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ“‹ ×›×ª×‘ ×›××•×™×•×ª ×•×ª××—×•×¨</h2>
      <p>×‘×—×¨ ×¡×¢×™×¤×™ ×¢×‘×•×“×”, ×”×’×“×¨ ×›××•×™×•×ª ×•×¢×“×›×Ÿ ××—×™×¨×™× ×œ×¤×™ ×”×¦×¢×•×ª ×©×”×ª×§×‘×œ×•.</p>
    </div>

    <!-- SMART SUGGESTION BAR -->
    <div id="boqSuggestionBar" style="background:rgba(212,168,83,0.07);border:1px solid rgba(212,168,83,0.25);border-radius:var(--radius);padding:1rem 1.25rem;margin-bottom:1rem;display:none">
      <div style="font-size:0.82rem;font-weight:700;color:var(--accent);margin-bottom:0.6rem;display:flex;align-items:center;gap:8px">
        ğŸ’¡ ×¡×¢×™×¤×™× ××•××œ×¦×™× ×œ×¤×™ ×¡×•×’ ×”× ×–×§ ×©×¡×•××Ÿ
        <button onclick="applyAllSuggested()" class="btn btn-primary" style="padding:4px 14px;font-size:0.78rem">+ ×”×•×¡×£ ×”×›×œ</button>
      </div>
      <div id="boqSuggestionTags" style="display:flex;flex-wrap:wrap;gap:6px"></div>
    </div>

    <!-- SECTIONS CONTAINER -->
    <div id="boqSections"></div>

    <!-- ADD SECTION BUTTON -->
    <button class="btn btn-ghost" style="width:100%;justify-content:center;border-style:dashed;margin-top:0.5rem" onclick="addBoqSection()">
      + ×”×•×¡×£ ×¤×¨×§ ×—×“×©
    </button>

    <!-- SUMMARY -->
    <div class="card" style="margin-top:1.5rem;border-color:rgba(212,168,83,0.4)">
      <div class="card-header" style="background:rgba(212,168,83,0.05)">
        <div class="card-header-icon" style="background:rgba(212,168,83,0.2)">ğŸ’°</div>
        <h3>×¡×™×›×•× ×›×ª×‘ ×›××•×™×•×ª</h3>
      </div>
      <div class="card-body">
        <div id="boqSummaryRows" style="margin-bottom:1rem"></div>

        <hr class="divider">

        <div class="form-grid">
          <div class="form-group">
            <label>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª (â‚ª)</label>
            <input type="number" id="deductible_display" placeholder="××•×–×Ÿ ×‘×¤×¨×§ ××³" readonly style="opacity:0.6;cursor:default" onclick="goToStep(1)" title="×¢×¨×š ××•×–×Ÿ ×‘×¤×¨×§ ××³">
          </div>
          <div class="form-group">
            <label>×™×¨×™×“×ª ×¢×¨×š (â‚ª)</label>
            <input type="number" id="depreciation" placeholder="0" oninput="updateBoqTotal()">
          </div>
          <div class="form-group">
            <label>×”×•×¦××•×ª ××—×¨×•×ª (â‚ª)</label>
            <input type="number" id="extraCosts" placeholder="0" oninput="updateBoqTotal()">
          </div>
          <div class="form-group">
            <label>××¢"×</label>
            <div class="radio-group" id="vatCalc">
              <div class="radio-btn active" onclick="selectRadio(this,'vatCalc');updateBoqTotal()">×›×•×œ×œ ××¢"× (18%)</div>
              <div class="radio-btn" onclick="selectRadio(this,'vatCalc');updateBoqTotal()">×œ×œ× ××¢"×</div>
            </div>
          </div>
        </div>

        <div class="conclusion-box" style="margin-top:1rem">
          <h3>ğŸ’ ×¡×™×›×•× ×”×¢×¨×›×ª × ×–×§</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem">
            <div>
              <p class="text-sm text-muted">×¡×”"×› ×œ×¤× ×™ ××¢"×</p>
              <div class="amount-display" id="totalBeforeVat">â‚ª0</div>
            </div>
            <div>
              <p class="text-sm text-muted">×¡×”"×› × ×–×§ (×›×•×œ×œ ××¢"×)</p>
              <div class="amount-display" id="totalGross">â‚ª0</div>
            </div>
            <div>
              <p class="text-sm text-muted">×¡×›×•× ×œ×ª×©×œ×•× ××•×¦×¢</p>
              <div class="amount-display" id="totalNet" style="color:var(--success)">â‚ª0</div>
            </div>
          </div>
        </div>

        <div class="form-group mt-4" style="margin-top:1rem">
          <label>×”×¢×¨×•×ª ×œ×¡×›×•×</label>
          <textarea id="amountNotes" placeholder="×”×¡×‘×¨×™×, ×”×’×‘×œ×•×ª, ×”× ×—×•×ª ×©× ×œ×§×—×• ×‘×—×©×‘×•×Ÿ..."></textarea>
        </div>
      </div>
    </div>

    <!-- RENTAL COMPENSATION - shows when property is uninhabitable -->
    <div class="card mt-4" id="rentalCompCard" style="margin-top:1rem;border-color:rgba(59,130,246,0.4);display:none">
      <div class="card-header" style="background:rgba(59,130,246,0.05)">
        <div class="card-header-icon" style="background:rgba(59,130,246,0.2)">ğŸ˜ï¸</div>
        <h3>×¤×™×¦×•×™ ×¢×‘×•×¨ ×©×›×™×¨×•×ª ×—×œ×•×¤×™×ª</h3>
        <span class="badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">××•×¤×¢×œ ××•×˜×•××˜×™×ª â€“ × ×›×¡ ×œ× ×¨××•×™ ×œ××’×•×¨×™×</span>
      </div>
      <div class="card-body">
        <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:1rem;font-size:0.84rem;color:#93c5fd">
          â„¹ï¸ ×¡×¢×™×£ ×–×” ×”×•×¤×¢×œ ×›×™×•×•×Ÿ ×©×¡×•××Ÿ ×©×”× ×›×¡ ××™× ×• ×¨××•×™ ×œ××’×•×¨×™×. ×”×–×Ÿ ××ª ×¤×¨×˜×™ ×“××™ ×”×©×›×™×¨×•×ª ×”×—×œ×•×¤×™×™×.
        </div>
        <div class="form-grid cols-3">
          <div class="form-group">
            <label>×©×›×¨ ×“×™×¨×” ×—×•×“×©×™ ××©×•×¢×¨ (â‚ª)</label>
            <input type="number" id="rentalMonthly" placeholder="×œ×“×•×’××”: 4500" oninput="updateRentalTotal()">
          </div>
          <div class="form-group">
            <label>××¡×¤×¨ ×—×•×“×©×™× ××©×•×¢×¨×™×</label>
            <input type="number" id="rentalMonths" placeholder="×œ×“×•×’××”: 3" min="0" step="0.5" oninput="updateRentalTotal()">
          </div>
          <div class="form-group">
            <label>×¡×”"×› ×¤×™×¦×•×™ ×©×›×™×¨×•×ª (â‚ª)</label>
            <input type="number" id="rentalTotal" placeholder="×—×™×©×•×‘ ××•×˜×•××˜×™" readonly style="opacity:0.7;background:rgba(59,130,246,0.05);border-color:rgba(59,130,246,0.3)">
          </div>
        </div>
        <div class="form-grid" style="margin-top:1rem">
          <div class="form-group">
            <label>×‘×¡×™×¡ ×”×”×¢×¨×›×”</label>
            <select id="rentalBasis">
              <option value="">×‘×—×¨...</option>
              <option>×©×›×¨ ×“×™×¨×” ×××•×¦×¢ ×‘××–×•×¨</option>
              <option>×—×•×–×” ×©×›×™×¨×•×ª ×§×™×™×</option>
              <option>×”×¢×¨×›×ª ×©×××™</option>
              <option>×”×¦×¢×ª ××—×™×¨ ×××¤×™×™×Ÿ</option>
            </select>
          </div>
          <div class="form-group">
            <label>×”×× ×›×‘×¨ ×©×•×œ× ×¤×™×¦×•×™ ×‘×™× ×™×™×</label>
            <div class="radio-group" id="rentalPaidAlready">
              <div class="radio-btn" onclick="selectRadio(this,'rentalPaidAlready')">×›×Ÿ</div>
              <div class="radio-btn" onclick="selectRadio(this,'rentalPaidAlready')">×œ×</div>
            </div>
          </div>
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>×”×¢×¨×•×ª ×œ×¤×™×¦×•×™ ×”×©×›×™×¨×•×ª</label>
          <textarea id="rentalNotes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× ×œ×’×‘×™ ×”×¤×™×¦×•×™ ×”××•×¦×¢..."></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- ============ STEP 6: PHOTOS ============ -->
  <div id="step7" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ“¸ ×ª××•× ×•×ª ×•××¡××›×™×</h2>
      <p>×¦×¨×£ ×ª××•× ×•×ª ×©×œ ×”× ×–×§ ×•××¡××›×™× ×¨×œ×•×•× ×˜×™×™×.</p>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(59,130,246,0.15)">ğŸ“·</div>
        <h3>×ª××•× ×•×ª ×”× ×–×§</h3>
        <span class="badge badge-optional">××•×¤×¦×™×•× ×œ×™</span>
      </div>
      <div class="card-body">
        <div class="upload-zone" onclick="document.getElementById('photoInput').click()">
          <div class="up-icon">ğŸ“‚</div>
          <p><strong>×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××•× ×•×ª</strong> ××• ×’×¨×•×¨ ×œ×›××Ÿ</p>
          <p style="margin-top:4px;font-size:0.78rem">JPG, PNG, WEBP - ×¢×“ 10 MB ×œ×§×•×‘×¥</p>
        </div>
        <input type="file" id="photoInput" multiple accept="image/*" class="hidden" onchange="handlePhotos(this)">
        <div class="photo-grid" id="photoGrid"></div>
      </div>
    </div>

    <div class="card mt-4" style="margin-top:1rem">
      <div class="card-header">
        <div class="card-header-icon" style="background:rgba(212,168,83,0.15)">ğŸ“„</div>
        <h3>××¡××›×™× ×•××¡××›×ª××•×ª</h3>
      </div>
      <div class="card-body">
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">×”×¢×ª×§ ×¤×•×œ×™×¡×ª ×‘×™×˜×•×—</span><span class="cb-sub">×¦×•×¨×£ / ×™×¦×•×¨×£</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">×ª×™×§ ××©×˜×¨×” / ××™×©×•×¨</span><span class="cb-sub">×œ××™×¨×•×¢×™ ×¤×¨×™×¦×” / ×’× ×™×‘×”</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">××™×©×•×¨ ××›×‘×™ ××©</span><span class="cb-sub">×œ××™×¨×•×¢×™ ×©×¨×™×¤×”</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">×—×©×‘×•× ×™×•×ª ×ª×™×§×•×Ÿ ×¨××©×•× ×™</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">×”×¦×¢×•×ª ××—×™×¨ ×©×”×ª×§×‘×œ×•</span></div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox"><div class="cb-box">âœ“</div>
            <div><span class="cb-label">× ×¡×— ×˜××‘×• / ×‘×¢×œ×•×ª</span></div>
          </label>
        </div>
        <div class="form-group mt-4" style="margin-top:1rem">
          <label>××¡××›×™× × ×•×¡×¤×™× ×©×¦×•×¨×¤×•</label>
          <textarea id="additionalDocs" placeholder="×¨×©×•× ××¡××›×™× × ×•×¡×¤×™×..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ STEP 7: CONCLUSIONS ============ -->
  <div id="step8" class="step-content hidden">
    <div class="step-header">
      <h2>âš–ï¸ ××¡×§× ×•×ª ×•×©×™×§×•×œ×™×</h2>
      <p>×”×•×¡×£ ××¡×§× ×•×ª ××§×¦×•×¢×™×•×ª, ×”××œ×¦×•×ª ×•×©×™×§×•×œ×™× ×œ×“×•×—.</p>
    </div>

    <div class="section open" id="sec-responsibility">
      <div class="section-trigger" onclick="toggleSection(this)">
        <div class="section-number">1</div>
        <h3>×§×‘×™×¢×ª ××—×¨×™×•×ª ×•×›×™×¡×•×™</h3>
        <span class="section-arrow">â–¼</span>
      </div>
      <div class="section-content">
        <hr class="section-divider">
        <div class="form-grid">
          <div class="form-group">
            <label>×§×‘×™×¢×ª ×¡×™×‘×ª ×”× ×–×§</label>
            <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;gap:8px">
              <span>ğŸ¤– ×˜×§×¡×˜ ××•×˜×•××˜×™ ×œ×¤×™ ×¡×•×’ ××™×¨×•×¢ ×•× ×–×§×™×</span>
              <button type="button" onclick="generateCauseText()" style="background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#3b82f6;border-radius:99px;padding:2px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit">â†º ×¦×•×¨ ×˜×§×¡×˜</button>
            </div>
            <textarea id="causeConclusion" placeholder="×œ×—×¥ ×¢×œ '×¦×•×¨ ×˜×§×¡×˜' ×œ××™×œ×•×™ ××•×˜×•××˜×™, ××• ×›×ª×•×‘ ×™×“× ×™×ª..." style="min-height:120px"></textarea>
          </div>
          <div class="form-group">
            <label>× ×¡×™×‘×•×ª ××—××™×¨×•×ª / ××§×œ×•×ª</label>
            <textarea id="circumstances" placeholder="×’×•×¨××™× × ×•×¡×¤×™× ×©×”×©×¤×™×¢×• ×¢×œ ×”×™×§×£ ×”× ×–×§..."></textarea>
          </div>
        </div>
        <div class="form-group mt-4" style="margin-top:1rem">
          <label>×”×× ×”× ×–×§ ××›×•×¡×” ×‘×¤×•×œ×™×¡×”</label>
          <div class="radio-group" id="coverageDecision">
            <div class="radio-btn" onclick="selectRadio(this,'coverageDecision')">×›×Ÿ, ××›×•×¡×” ×‘××œ×•××•</div>
            <div class="radio-btn" onclick="selectRadio(this,'coverageDecision')">××›×•×¡×” ×—×œ×§×™×ª</div>
            <div class="radio-btn" onclick="selectRadio(this,'coverageDecision')">××™× ×• ××›×•×¡×”</div>
            <div class="radio-btn" onclick="selectRadio(this,'coverageDecision')">×××ª×™×Ÿ ×œ×‘×“×™×§×”</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="sec-recommendations">
      <div class="section-trigger" onclick="toggleSection(this)">
        <div class="section-number">2</div>
        <h3>×”××œ×¦×•×ª ×œ×©×™×§×•×</h3>
        <span class="section-arrow">â–¼</span>
      </div>
      <div class="section-content">
        <hr class="section-divider">
        <div class="form-group">
          <label>×¡×“×¨ ×¢×“×™×¤×•×™×•×ª ×œ×ª×™×§×•×Ÿ</label>
          <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;gap:8px">
            <span>ğŸ¤– ×”××œ×¦×•×ª ××•×˜×•××˜×™×•×ª ×œ×¤×™ ×›×ª×‘ ×”×›××•×™×•×ª</span>
            <button type="button" onclick="generateRecommendations()" style="background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#22c55e;border-radius:99px;padding:2px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit">â†º ×¦×•×¨ ×”××œ×¦×•×ª</button>
          </div>
          <textarea id="repairPriority" style="min-height:100px" placeholder="×œ×—×¥ ×¢×œ '×¦×•×¨ ×”××œ×¦×•×ª' ×œ××™×œ×•×™ ××•×˜×•××˜×™, ××• ×›×ª×•×‘ ×™×“× ×™×ª..."></textarea>
        </div>
        <div class="form-group mt-4" style="margin-top:1rem">
          <label>×–××Ÿ ×©×™×§×•× ××©×•×¢×¨</label>
          <div class="radio-group" id="repairTime">
            <div class="radio-btn" onclick="selectRadio(this,'repairTime')">×¢×“ ×©×‘×•×¢</div>
            <div class="radio-btn" onclick="selectRadio(this,'repairTime')">2-4 ×©×‘×•×¢×•×ª</div>
            <div class="radio-btn" onclick="selectRadio(this,'repairTime')">1-3 ×—×•×“×©×™×</div>
            <div class="radio-btn" onclick="selectRadio(this,'repairTime')">××¢×œ 3 ×—×•×“×©×™×</div>
          </div>
        </div>
        <div class="form-group mt-4" style="margin-top:1rem">
          <label>×”×× × ×“×¨×© ××•××—×” × ×•×¡×£</label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox"><div class="cb-box">âœ“</div>
              <span class="cb-label">××”× ×“×¡ ×§×•× ×¡×˜×¨×•×§×¦×™×”</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox"><div class="cb-box">âœ“</div>
              <span class="cb-label">×—×•×§×¨ ×©×¨×™×¤×•×ª</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox"><div class="cb-box">âœ“</div>
              <span class="cb-label">××”× ×“×¡ ×—×©××œ</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox"><div class="cb-box">âœ“</div>
              <span class="cb-label">××™× ×¡×˜×œ×˜×•×¨ / ×”×™×“×¨×•×œ×•×’</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="sec-notes">
      <div class="section-trigger" onclick="toggleSection(this)">
        <div class="section-number">3</div>
        <h3>×¤×¨×§ 5 â€“ ×”×¡×‘×¨×™× ×œ×”×¢×¨×›×”</h3>
        <span class="section-arrow">â–¼</span>
      </div>
      <div class="section-content">
        <hr class="section-divider">

        <div style="background:rgba(212,168,83,0.06);border:1px solid rgba(212,168,83,0.2);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:1rem;font-size:0.84rem;color:var(--text-secondary);line-height:1.7">
          ğŸ“Œ <strong style="color:var(--accent)">× ×•×¡×— ×‘×¨×™×¨×ª ××—×“×œ ×œ×¤×¨×§ ×”×”×¡×‘×¨×™×</strong> â€” × ×™×ª×Ÿ ×œ×¢×¨×•×š / ×œ×”×•×¡×™×£ / ×œ×”×©××™×˜ ×©×•×¨×•×ª
        </div>

        <div class="form-group">
          <label>×¤×¨×§ 5 â€“ ×”×¡×‘×¨×™× ×œ×”×¢×¨×›×”</label>
          <textarea id="evaluationExplanation" style="min-height:220px;line-height:1.8;font-size:0.88rem">×”×¢×¨×›×ª ×”× ×–×§ × ×§×‘×¢×” ×‘×”×ª×× ×œ×××¦××™× ×©× ×¦×¤×• ×‘××•×¢×“ ×”×‘×™×§×•×¨ ×‘× ×›×¡ ×•×‘×”×ª×× ×œ"×“×•×— / ×”×¢×¨×›×” / ×˜×•×¤×¡ ×ª×œ×•× ×”".
××“×•×‘×¨ ×‘×“×™×¨×ª ××’×•×¨×™×, ×•×œ×¤×™×›×š ×”×”×¢×¨×›×” ×›×•×œ×œ×ª ××¢"×.
×”××—×™×¨×™× ××‘×•×¡×¡×™× ×¢×œ ×”×¦×¢×•×ª ××—×™×¨ ×©×”×ª×§×‘×œ×• ×•×¢×œ ××—×™×¨×•×Ÿ ×“×§×œ ×©×™×¤×•×¦×™× ×‘×”×ª×× ×œ××§×•×‘×œ ×‘×©×•×§.
×›×œ ×”×××•×¨ ×‘×“×•"×— ×–×” × ×›×•×Ÿ ×œ×™×•× ×”×‘×™×§×•×¨ ×‘× ×›×¡.
×™×™×ª×›×Ÿ ×›×™ ×‘××”×œ×š ×‘×™×¦×•×¢ ×”×¢×‘×•×“×•×ª ×™×ª×’×œ×• ×œ×™×§×•×™×™× × ×•×¡×¤×™× ×©×œ× ×”×™×• ×’×œ×•×™×™× ×œ×¢×™×Ÿ ×‘××•×¢×“ ×”×‘×“×™×§×”, ×•×‘××§×¨×” ×–×” ×ª×¢×•×“×›×Ÿ ×”×”×¢×¨×›×” ×‘×”×ª××.</textarea>
        </div>

        <div class="form-group mt-4" style="margin-top:1.25rem">
          <label>×”×¢×¨×•×ª ×›×œ×œ×™×•×ª ×•/××• ×”×¡×ª×™×™×’×•×™×•×ª × ×•×¡×¤×•×ª</label>
          <textarea id="generalNotes" style="min-height:100px" placeholder="×”×¢×¨×•×ª ×©×××™×•×ª × ×•×¡×¤×•×ª, ×”×¡×ª×™×™×’×•×™×•×ª, ××™×“×¢ ×—×¡×¨ ×©×™×© ×œ×”×©×œ×™×..."></textarea>
        </div>
      </div>
    </div>

    <!-- DECLARATION SECTION -->
    <div class="section open" id="sec-declaration" style="margin-top:1rem">
      <div class="section-trigger" onclick="toggleSection(this)">
        <div class="section-number">4</div>
        <h3>×”×¦×”×¨×ª ×©×××™</h3>
        <span class="badge" style="background:rgba(212,168,83,0.15);color:var(--accent);font-size:0.7rem;padding:3px 10px;border-radius:99px;font-weight:600">×§×‘×•×¢ â€¢ × ×™×ª×Ÿ ×œ×¢×¨×™×›×”</span>
        <span class="section-arrow">â–¼</span>
      </div>
      <div class="section-content">
        <hr class="section-divider">
        <div style="background:rgba(212,168,83,0.06);border:1px solid rgba(212,168,83,0.2);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:1rem;font-size:0.84rem;color:var(--text-secondary);line-height:1.7">
          ğŸ”’ × ×•×¡×— ×”×”×¦×”×¨×” ×§×‘×•×¢ ×•××§×¦×•×¢×™ â€” × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ×¤×™ ×”×¦×•×¨×š.
        </div>
        <div class="form-group">
          <textarea id="appraisalDeclaration" style="min-height:120px;line-height:1.8;font-size:0.88rem"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ STEP 8: PREVIEW ============ -->
  <div id="step9" class="step-content hidden">
    <div class="step-header">
      <h2>ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”×“×•×—</h2>
      <p>×‘×“×•×§ ××ª ×”×“×•×— ×œ×¤× ×™ ×™×™×¦×•× ×•×©×œ×™×—×”.</p>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:1.5rem;flex-wrap:wrap">
      <button class="btn btn-success btn-lg" onclick="printReport()">ğŸ–¨ï¸ ×”×“×¤×¡×” / ×©××™×¨×” ×›-PDF</button>
      <button class="btn btn-primary btn-lg" onclick="openEmailModal()">ğŸ“§ ×©×œ×™×—×” ×‘××™×™×œ</button>
      <button class="btn btn-ghost" onclick="goToStep(1)">âœï¸ ×¢×¨×•×š ××—×“×©</button>
    </div>
    <div class="report-preview" id="reportOutput"></div>
  </div>

  <!-- EMAIL MODAL -->
  <div id="emailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;max-width:480px;width:90%;position:relative;box-shadow:var(--shadow-lg)">
      <button onclick="closeEmailModal()" style="position:absolute;top:12px;left:16px;background:none;border:none;color:var(--text-muted);font-size:1.3rem;cursor:pointer">âœ•</button>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:1.5rem">
        <div style="background:rgba(212,168,83,0.15);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:1.3rem">ğŸ“§</div>
        <div>
          <h3 style="margin:0;font-size:1.05rem">×©×œ×™×—×ª ×—×•×•×ª ×”×“×¢×ª ×‘××™×™×œ</h3>
          <p style="margin:0;font-size:0.82rem;color:var(--text-muted)">×”×“×•×— ×™×™×©×œ×— ×›×§×•×‘×¥ HTML ×œ×›×ª×•×‘×ª ×©×ª×‘×—×¨</p>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:1rem">
        <label>×›×ª×•×‘×ª ××™×™×œ ×©×œ ×”××‘×•×˜×—</label>
        <input type="email" id="emailInsured" placeholder="insured@example.com" style="direction:ltr">
      </div>
      <div class="form-group" style="margin-bottom:1rem">
        <label>×›×ª×•×‘×ª ××™×™×œ × ×•×¡×¤×ª (CC â€“ ×—×‘×¨×ª ×‘×™×˜×•×— / ×©×××™ ×××•× ×”)</label>
        <input type="email" id="emailCC" placeholder="company@insurance.co.il" style="direction:ltr">
      </div>
      <div class="form-group" style="margin-bottom:1.25rem">
        <label>× ×•×©× ×”××™×™×œ</label>
        <input type="text" id="emailSubject" value="×—×•×•×ª ×“×¢×ª ×©×××™ ×¨×›×•×© â€“ ×™×¨×•×Ÿ ×××™×¨">
      </div>
      <div class="form-group" style="margin-bottom:1.5rem">
        <label>×”×•×“×¢×” × ×œ×•×•×™×ª (××•×¤×¦×™×•× ×œ×™)</label>
        <textarea id="emailBody" style="min-height:80px" placeholder="×œ×›×‘×•×“...&#10;××¦×•×¨×¤×ª ×—×•×•×ª ×”×“×¢×ª ×”×©×××™×ª ×‘×’×™×Ÿ..."></textarea>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-primary" style="flex:1" onclick="sendByEmail()">ğŸ“¤ ×©×œ×— ××™×™×œ</button>
        <button class="btn btn-ghost" onclick="downloadHtmlReport()">ğŸ’¾ ×”×•×¨×“ ×›×§×•×‘×¥</button>
      </div>
      <p style="margin-top:1rem;font-size:0.77rem;color:var(--text-muted);text-align:center">
        * ×”×©×œ×™×—×” ××ª×‘×¦×¢×ª ×“×¨×š ×ª×•×›× ×ª ×”××™×™×œ ×”××•×’×“×¨×ª ×‘××—×©×‘ ×©×œ×š (mailto).<br>
        ×œ×©×œ×™×—×” ×™×©×™×¨×” ××”××¢×¨×›×ª, × ×™×ª×Ÿ ×œ×”×©×ª××© ×‘"×”×•×¨×“ ×›×§×•×‘×¥" ×•×œ×¦×¨×¤×• ×™×“× ×™×ª.
      </p>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div style="display:flex;justify-content:space-between;margin-top:2rem">
    <button class="btn btn-ghost" id="prevBtn" onclick="goToStep(currentStep-1)">â† ×”×§×•×“×</button>
    <button class="btn btn-primary btn-lg" id="nextBtn" onclick="goToStep(currentStep+1)">×”××©×š â†’</button>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Firebase SDK - MUST load before our code -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyAepqvT-NRxTiVemkaxNJWpyAQ9ibxrkcw",
  authDomain: "yaron-appraiser.firebaseapp.com",
  projectId: "yaron-appraiser",
  storageBucket: "yaron-appraiser.firebasestorage.app",
  messagingSenderId: "179370141848",
  appId: "1:179370141848:web:d5843d9641dce3adabc8ed",
  measurementId: "G-F5Y3LT9H7F"
};

// Initialize Firebase
let firebaseApp = null;
let db = null;
try {
  firebaseApp = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  console.log('âœ… Firebase initialized');
} catch (err) {
  console.error('âŒ Firebase init failed:', err);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOSAVE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AUTOSAVE_CONFIG = {
  localInterval: 30000,      // 30 seconds
  cloudInterval: 300000,     // 5 minutes (first sync after 60s)
  enabled: true,
  projectId: null
};

let autosaveTimer = null;
let cloudSyncTimer = null;
let lastLocalSave = null;
let lastCloudSync = null;
let hasUnsavedChanges = false;
let cloudSyncInProgress = false;

function generateProjectId() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 9);
  return `proj_${timestamp}_${random}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXISTING CODE STARTS HERE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentStep = 1;
const totalSteps = 9;
let selectedEvent = null;
let photos = [];

// ====== CHAPTER A â€“ LIVE SUMMARY & AUTO-FILL ======
function chapterALive() {
  const get  = id => document.getElementById(id)?.value?.trim() || '';
  const fmtD = v  => v ? new Date(v).toLocaleDateString('he-IL', {day:'2-digit',month:'2-digit',year:'numeric'}) : 'â€”';
  const fmtN = v  => v ? 'â‚ª' + parseInt(v).toLocaleString('he-IL') : '';

  const name    = get('insuredName');
  const idNum   = get('insuredId');
  const addr    = get('propAddress');
  const company = get('insuranceCompany');
  const policy  = get('policyNum');
  const claim   = get('claimNum');
  const evDate  = get('eventDate');
  const visit   = get('visitDate');
  const pfrom   = get('policyFrom');
  const pto     = get('policyTo');
  const ded     = get('deductible');
  const dedC    = get('deductibleContents');

  // Update live summary grid
  const s = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val || 'â€”'; };
  s('s_name',    name);
  s('s_id',      idNum);
  s('s_addr',    addr);
  s('s_company', company);
  s('s_policy',  policy);
  s('s_claim',   claim);
  s('s_event',   fmtD(evDate));
  s('s_visit',   fmtD(visit));
  s('s_period',  pfrom && pto ? fmtD(pfrom) + ' â€“ ' + fmtD(pto) : pfrom ? '×-' + fmtD(pfrom) : pto ? '×¢×“ ' + fmtD(pto) : 'â€”');
  s('s_ded',
    ded || dedC
      ? [ded  ? '××‘× ×”: '  + fmtN(ded)  : '',
         dedC ? '×ª×›×•×œ×”: ' + fmtN(dedC) : '']
          .filter(Boolean).join(' | ')
      : 'â€”');

  // Update step 3 readonly displays
  const d = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
  d('propOwnerDisplay', name);
  d('propAddressDisplay', addr);
  d('eventDate_display', evDate); // Sync step 2 event date display

  // Auto-fill eventBrief (step 2)
  const ta = document.getElementById('eventBrief');
  if (ta) {
    const tpl = `××Ÿ ×”×¤×¨×˜×™× ××•×ª× ×§×™×‘×œ× ×• ××¤×™ ×”××‘×•×˜×— ××¨ ${name || '___________'}, ×ª.×– ${idNum || '___________'}. ×¢×•×œ×” ×›×™ ×‘×ª××¨×™×š ${evDate ? new Date(evDate).toLocaleDateString('he-IL') : '___________'}.`;
    if (!ta.value || ta.value.startsWith('××Ÿ ×”×¤×¨×˜×™× ××•×ª× ×§×™×‘×œ× ×•')) ta.value = tpl;
  }
}

// Legacy alias used in some places
function autoFillFromInsured() { chapterALive(); }

// ====== DATE CONSTRAINTS ======
function updateDateConstraints() {
  const eventDate = document.getElementById('eventDate')?.value;
  const visitDate = document.getElementById('visitDate');
  const lastDocDate = document.getElementById('lastDocDate');
  const reportDate = document.getElementById('reportDate');
  
  if (eventDate) {
    if (visitDate) visitDate.min = eventDate;
    if (lastDocDate) lastDocDate.min = eventDate;
    if (reportDate) reportDate.min = eventDate;
  }
  
  const vDate = visitDate?.value;
  if (vDate && lastDocDate) lastDocDate.min = vDate;
  
  const lDate = lastDocDate?.value || vDate;
  if (lDate && reportDate) reportDate.min = lDate;
}

function toggleWaterDurationOther(select) {
  const otherGroup = document.getElementById('waterDurationOtherGroup');
  if (select.value === 'other') {
    otherGroup.style.display = 'block';
  } else {
    otherGroup.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOSAVE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getAllFormData() {
  return {
    chapterA: {
      insuredName: val('insuredName'),
      insuredId: val('insuredId'),
      insuredPhone: val('insuredPhone'),
      insuredEmail: val('insuredEmail'),
      insuredRelation: val('insuredRelation'),
      propAddress: val('propAddress'),
      insuranceCompany: val('insuranceCompany'),
      policyNum: val('policyNum'),
      claimNum: val('claimNum'),
      adjustorName: val('adjustorName'),
      policyFrom: val('policyFrom'),
      policyTo: val('policyTo'),
      deductible: val('deductible'),
      eventDate: val('eventDate'),
      visitDate: val('visitDate'),
      lastDocDate: val('lastDocDate'),
      reportDate: val('reportDate'),
      appraisalLicense: val('appraisalLicense'),
      appraisalFirm: val('appraisalFirm'),
      appraisalPhone: val('appraisalPhone')
    },
    selectedEvent: selectedEvent,
    eventBrief: val('eventBrief'),
    property: {
      street: val('propStreet'),
      num: val('propNum'),
      apt: val('propApt'),
      city: val('propCity'),
      type: val('propType'),
      year: val('propYear'),
      area: val('propArea'),
      material: val('propMaterial')
    },
    policy: {
      type: selectedPolicyType,
      structureLimit: val('structureCoverageLimit'),
      contentsLimit: val('contentsCoverageLimit')
    },
    damage: {
      description: val('damageDescription')
    },
    boq: boqSections,
    conclusions: {
      cause: val('causeConclusion'),
      repairPriority: val('repairPriority')
    },
    metadata: {
      version: '1.0',
      lastModified: new Date().toISOString(),
      currentStep: currentStep
    }
  };
}

function saveToLocal() {
  if (!AUTOSAVE_CONFIG.enabled) return;
  
  try {
    const data = getAllFormData();
    const snapshot = {
      projectId: AUTOSAVE_CONFIG.projectId,
      timestamp: Date.now(),
      data: data
    };
    
    localStorage.setItem('draft_latest', JSON.stringify(snapshot));
    localStorage.setItem(`draft_${AUTOSAVE_CONFIG.projectId}`, JSON.stringify(snapshot));
    
    lastLocalSave = Date.now();
    hasUnsavedChanges = false;
    updateSaveStatus();
    
    console.log('ğŸ’¾ Saved locally');
  } catch (err) {
    console.error('Local save failed:', err);
  }
}

async function syncToCloud() {
  if (!AUTOSAVE_CONFIG.enabled || !db || cloudSyncInProgress) return;
  if (!navigator.onLine) {
    console.log('ğŸ“´ Offline - skipping cloud sync');
    return;
  }
  
  cloudSyncInProgress = true;
  updateSaveStatus('syncing');
  
  try {
    const data = getAllFormData();
    
    await db.collection('drafts').doc(AUTOSAVE_CONFIG.projectId).set({
      data: data,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      device: navigator.userAgent.substr(0, 100),
      version: '1.0'
    }, { merge: true });
    
    lastCloudSync = Date.now();
    updateSaveStatus('synced');
    console.log('â˜ï¸ Synced to cloud');
  } catch (err) {
    console.error('Cloud sync failed:', err);
    updateSaveStatus('syncError');
  } finally {
    cloudSyncInProgress = false;
  }
}

function updateSaveStatus(status) {
  const indicator = document.getElementById('saveStatus');
  if (!indicator) return;
  
  const now = Date.now();
  const localAge = lastLocalSave ? Math.floor((now - lastLocalSave) / 1000) : null;
  const cloudAge = lastCloudSync ? Math.floor((now - lastCloudSync) / 60000) : null;
  
  let icon = 'ğŸ’¾';
  let text = '';
  let color = 'var(--text-secondary)';
  
  if (status === 'syncing') {
    icon = '<span class="spin" style="display:inline-block">âŸ³</span>';
    text = '××¡× ×›×¨×Ÿ...';
    color = '#3b82f6';
  } else if (status === 'synced') {
    icon = 'â˜ï¸';
    text = '××¡×•× ×›×¨×Ÿ ×œ×¢× ×Ÿ';
    color = '#22c55e';
  } else if (status === 'syncError') {
    icon = 'âš ï¸';
    text = '×©×’×™××” - × ×©××¨ ××§×•××™×ª';
    color = '#f59e0b';
  } else if (localAge !== null) {
    if (localAge < 60) {
      text = `× ×©××¨ ×œ×¤× ×™ ${localAge}s`;
    } else {
      text = `× ×©××¨ ×œ×¤× ×™ ${Math.floor(localAge/60)}m`;
    }
    if (cloudAge !== null && cloudAge < 10) {
      icon = 'â˜ï¸';
      color = '#22c55e';
    }
  } else {
    text = '×˜×¨× × ×©××¨';
  }
  
  indicator.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;font-size:0.85rem;color:${color}">
      <span>${icon}</span>
      <span>${text}</span>
    </div>
  `;
}

function startAutosave() {
  if (!AUTOSAVE_CONFIG.projectId) {
    AUTOSAVE_CONFIG.projectId = generateProjectId();
    console.log('ğŸ†” Project ID:', AUTOSAVE_CONFIG.projectId);
  }
  
  // Local save every 30 seconds
  autosaveTimer = setInterval(() => {
    if (hasUnsavedChanges) {
      saveToLocal();
    } else {
      updateSaveStatus(); // Update time display
    }
  }, AUTOSAVE_CONFIG.localInterval);
  
  // Cloud sync: first after 60s, then every 5 minutes
  setTimeout(() => {
    syncToCloud();
    cloudSyncTimer = setInterval(() => {
      syncToCloud();
    }, AUTOSAVE_CONFIG.cloudInterval);
  }, 60000);
  
  console.log('ğŸš€ Autosave started');
}

function markAsChanged() {
  hasUnsavedChanges = true;
}

function manualSave() {
  saveToLocal();
  syncToCloud();
}

function loadFromLocal(projectId) {
  try {
    const key = projectId ? `draft_${projectId}` : 'draft_latest';
    const stored = localStorage.getItem(key);
    if (!stored) return null;
    return JSON.parse(stored);
  } catch (err) {
    console.error('Load failed:', err);
    return null;
  }
}

function restoreDraft(snapshot) {
  if (!snapshot || !snapshot.data) return;
  
  const data = snapshot.data;
  
  // Restore all fields
  Object.keys(data.chapterA || {}).forEach(key => {
    const el = document.getElementById(key);
    if (el) el.value = data.chapterA[key] || '';
  });
  
  if (data.selectedEvent) selectedEvent = data.selectedEvent;
  if (data.boq) { boqSections = data.boq; renderBoq(); }
  
  AUTOSAVE_CONFIG.projectId = snapshot.projectId;
  chapterALive(); // Refresh displays
  console.log('âœ… Draft restored');
}

function exportToJSON() {
  const data = getAllFormData();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `yaron_backup_${AUTOSAVE_CONFIG.projectId}_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function showDraftMenu() {
  // TODO: UI for loading drafts
  const draft = loadFromLocal();
  if (draft) {
    const age = Math.floor((Date.now() - draft.timestamp) / 60000);
    if (confirm(`× ××¦××” ×˜×™×•×˜×” ××œ×¤× ×™ ${age} ×“×§×•×ª. ×œ×©×—×–×¨?`)) {
      restoreDraft(draft);
    }
  } else {
    alert('×œ× × ××¦××• ×˜×™×•×˜××•×ª ×©××•×¨×•×ª');
  }
}

// Mark changes on any input
document.addEventListener('input', markAsChanged);
document.addEventListener('change', markAsChanged);

// Prevent accidental close
window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges) {
    saveToLocal();
    e.preventDefault();
    e.returnValue = '×™×© ×©×™× ×•×™×™× ×©×œ× × ×©××¨×•';
  }
});

// ====== INIT ======
window.onload = async () => {
  // Set today's date as default for reportDate
  const today = new Date().toISOString().split('T')[0];
  const rd = document.getElementById('reportDate');
  if (rd && !rd.value) rd.value = today;

  updateNav();
  initCheckboxes();
  refreshDeclaration();
  chapterALive(); // init summary bar
  
  // Initialize autosave system
  await initIndexedDB();
  startAutoSave();
  
  // Check for existing draft
  const draft = loadFromLocalStorage();
  if (draft && draft.data) {
    const minutesAgo = Math.round((Date.now() - draft.timestamp) / 60000);
    if (minutesAgo < 1440) { // Less than 24 hours
      showRecoveryModal(draft, minutesAgo);
    }
  }
};

// ====== CHECKBOX SYSTEM â€“ FIXED ======
// ====== CHECKBOX SYSTEM â€“ CLEAN ======
// The issue: <label> wrapping <input> causes double-fire (label click + input change).
// Solution: remove reliance on native checkbox change, handle everything via click on .checkbox-item.
function initCheckboxes() {
  document.addEventListener('click', function(e) {
    const item = e.target.closest('.checkbox-item');
    if (!item) return;
    // Prevent the label from also triggering the hidden input and causing double-toggle
    e.preventDefault();
    e.stopPropagation();
    const cb = item.querySelector('input[type="checkbox"]');
    if (cb) {
      cb.checked = !cb.checked;
    }
    item.classList.toggle('checked');
  }, true); // use capture phase so we catch it before label's default behavior
}

function toggleCheck(el) {
  el.classList.toggle('checked');
  const cb = el.querySelector('input[type="checkbox"]');
  if (cb) cb.checked = el.classList.contains('checked');
}

// ====== DAMAGE TEMPLATE ======
function refreshDamageTemplate() {
  const name = document.getElementById('insuredName')?.value?.trim() || '___________';
  const id = document.getElementById('insuredId')?.value?.trim() || '___________';
  const eventDate = document.getElementById('eventDate')?.value;
  const dateStr = eventDate ? new Date(eventDate).toLocaleDateString('he-IL') : '___________';
  
  const ta = document.getElementById('damageDescription');
  if (!ta) return;
  const current = ta.value;
  const prefix = `××Ÿ ×”×¤×¨×˜×™× ××•×ª× ×§×™×‘×œ× ×• ××¤×™ ×”××‘×•×˜×— ××¨ ${name}, ×ª.×– ${id}. ×¢×•×œ×” ×›×™ ×‘×ª××¨×™×š ${dateStr}.\n\n`;
  
  const wasEmpty = current === '' || current.startsWith('××Ÿ ×”×¤×¨×˜×™× ××•×ª× ×§×™×‘×œ× ×•');
  if (wasEmpty) {
    ta.value = prefix;
    ta.setSelectionRange(ta.value.length, ta.value.length);
    ta.focus();
  }
}

// ====== DECLARATION TEMPLATE ======
function refreshDeclaration() {
  const text = `×× ×™ ×”×—"× ××¦×”×™×¨ ×›×™ ×—×•×•×ª ×“×¢×ª ×–×• × ×¢×¨×›×” ×¢×œ ×™×“×™ ×‘××•×¤×Ÿ ××§×¦×•×¢×™, ×¢×¦×××™ ×•×‘×œ×ª×™ ×ª×œ×•×™, ×‘×”×ª×× ×œ×××¦××™× ×©× ×¦×¤×• ×‘×‘×™×§×•×¨ ×‘× ×›×¡ ×•×œ× ×ª×•× ×™× ×©×¢××“×• ×‘×¤× ×™×™ ×‘××•×¢×“ ×¢×¨×™×›×ª ×”×“×•"×—.
×”×”×¢×¨×›×” ×‘×•×¦×¢×” ×‘×”×ª×× ×œ×›×œ×œ×™× ×”××§×•×‘×œ×™× ×‘×ª×—×•× ×©×××•×ª ×”×¨×›×•×© ×•×¢×œ ×‘×¡×™×¡ × ×™×¡×™×•×Ÿ ××§×¦×•×¢×™ ×•××§×•×¨×•×ª ×ª××—×•×¨ ××§×•×‘×œ×™×.
×—×•×•×ª ×“×¢×ª ×–×• ××™×•×¢×“×ª ×œ×”×¢×¨×›×ª ×”× ×–×§ × ×©×•× ×”××™×¨×•×¢ ×‘×œ×‘×“.`;

  const ta = document.getElementById('appraisalDeclaration');
  if (ta) ta.value = text;
}

// ====== PROPUSABLE TRIGGER for rental ======
function checkRentalVisibility() {
  const active = document.querySelector('#propUsable .radio-btn.active');
  const card = document.getElementById('rentalCompCard');
  if (!card) return;
  if (active && active.textContent.trim() === '×œ×') {
    card.style.display = 'block';
    card.scrollIntoView({behavior:'smooth', block:'nearest'});
  } else {
    card.style.display = 'none';
  }
}

// ====== RENTAL TOTAL ======
function updateRentalTotal() {
  const monthly = parseFloat(document.getElementById('rentalMonthly')?.value) || 0;
  const months = parseFloat(document.getElementById('rentalMonths')?.value) || 0;
  const total = monthly * months;
  const el = document.getElementById('rentalTotal');
  if (el) el.value = total > 0 ? total : '';
}

// ====== NAVIGATION ======
function goToStep(n) {
  if (n < 1 || n > totalSteps) return;
  if (n === totalSteps) buildReport();
  // Auto-fill eventBrief when moving to step 2 (event type)
  if (n === 2) {
    const ta = document.getElementById('eventBrief');
    if (!ta?.value || ta.value.startsWith('××Ÿ ×”×¤×¨×˜×™×')) autoFillFromInsured();
  }
  // Auto-fill damage description when moving to step 5
  if (n === 5) {
    const ta = document.getElementById('damageDescription');
    if (ta && (!ta.value || ta.value.startsWith('××Ÿ ×”×¤×¨×˜×™×'))) refreshDamageTemplate();
  }
  // Init BOQ when moving to step 6
  if (n === 6) {
    initBoq();
  }
  // Auto-fill declaration when moving to step 8
  if (n === 8) {
    const ta = document.getElementById('appraisalDeclaration');
    if (!ta?.value || ta.value.startsWith('×”×¦×”×¨×ª ×©×××™')) refreshDeclaration();
  }

  document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('step' + n).classList.remove('hidden');

  document.querySelectorAll('.step-pill').forEach(pill => {
    const s = parseInt(pill.dataset.step);
    pill.classList.remove('active','done');
    if (s === n) pill.classList.add('active');
    else if (s < n) pill.classList.add('done');
  });

  const pct = Math.round((n / totalSteps) * 100);
  document.getElementById('progBar').style.width = pct + '%';
  document.getElementById('progPct').textContent = pct + '%';
  document.getElementById('progLabel').textContent = '×©×œ×‘ ' + n + ' ××ª×•×š ' + totalSteps;

  currentStep = n;
  updateNav();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function updateNav() {
  const prev = document.getElementById('prevBtn');
  const next = document.getElementById('nextBtn');
  const hNext = document.getElementById('headerNextBtn');
  prev.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
  if (currentStep === totalSteps) {
    next.textContent = 'âœ… ×¡×™×•×';
    next.onclick = () => showToast('âœ… ×”×“×•×— ××•×›×Ÿ ×œ×”×“×¤×¡×”!', 'success');
    hNext.textContent = 'âœ… ×¡×™×•×';
  } else if (currentStep === totalSteps - 1) {
    next.textContent = 'ğŸ‘ï¸ ×”×¦×’ ×“×•×— â†’';
    hNext.textContent = 'ğŸ‘ï¸ ×”×¦×’ ×“×•×— â†’';
    next.onclick = () => goToStep(currentStep + 1);
    hNext.onclick = () => goToStep(currentStep + 1);
  } else {
    next.textContent = '×”××©×š â†’';
    hNext.textContent = '×”××©×š â†’';
    next.onclick = () => goToStep(currentStep + 1);
    hNext.onclick = () => goToStep(currentStep + 1);
  }
}

// ====== EVENT SELECTION ======
function selectEvent(type, el) {
  document.querySelectorAll('.event-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedEvent = type;

  document.getElementById('eventTypeDetails').classList.remove('hidden');
  document.querySelectorAll('.event-specific').forEach(s => s.classList.add('hidden'));

  const spec = document.getElementById(type + 'Specific');
  if (spec) spec.classList.remove('hidden');

  const icons = {fire:'ğŸ”¥',water:'ğŸ’§',break_in:'ğŸ”“',earthquake:'ğŸŒ',other:'ğŸ“‹'};
  const titles = {fire:'×¤×¨×˜×™ ××™×¨×•×¢ ×”×©×¨×™×¤×”',water:'×¤×¨×˜×™ × ×–×§×™ ×”××™×',break_in:'×¤×¨×˜×™ ××™×¨×•×¢ ×”×¤×¨×™×¦×”',earthquake:'×¤×¨×˜×™ ×¨×¢×™×“×ª ×”××“××”',other:'×¤×¨×˜×™ ×”××™×¨×•×¢'};
  document.getElementById('evDetailIcon').textContent = icons[type];
  document.getElementById('evDetailTitle').textContent = titles[type];
}

// ====== RADIO BUTTONS ======
function selectRadio(el, groupId) {
  document.querySelectorAll('#' + groupId + ' .radio-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  // Check if this is the propUsable group to show/hide rental card
  if (groupId === 'propUsable') checkRentalVisibility();
}

// ====== SECTION TOGGLE ======
function toggleSection(trigger) {
  const section = trigger.closest('.section');
  section.classList.toggle('open');
}

// ====== BOQ ENGINE â€“ BILL OF QUANTITIES ======

// Full catalog of work items organized by damage type and section
const BOQ_CATALOG = {

  // â”€â”€â”€ SECTIONS TRIGGERED BY DAMAGE TYPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  '× ×–×§ ×œ×¨×™×¦×•×£ ×•××¨×™×—×™×': [
    {
      title: '×¢×‘×•×“×•×ª ×¤×™×¨×•×§ ×•×”×›× ×”',
      items: [
        { desc: '×¤×™×¨×•×§ ×¨×™×¦×•×£ ×§×™×™×',             unit: '×"×¨',    qty: 0, price: 85   },
        { desc: '×¤×™× ×•×™ ×¤×¡×•×œ×ª ×œ××ª×¨ ××•×¨×©×”',        unit: "×§×•××¤'",  qty: 1, price: 1800 },
        { desc: '× ×™×§×•×™ ×•×—×™×˜×•×™ ×ª×©×ª×™×ª',            unit: '×"×¨',    qty: 0, price: 65   },
      ]
    },
    {
      title: '×¢×‘×•×“×•×ª ×ª×©×ª×™×ª ×•×¨×™×¦×•×£',
      items: [
        { desc: '×”×›× ×ª ×•×™×™×©×•×¨ ×ª×©×ª×™×ª',             unit: '×"×¨',    qty: 0, price: 55   },
        { desc: '×¨×™×¦×•×£ ×—×“×© ×›×•×œ×œ ×¨×•×‘×”',            unit: '×"×¨',    qty: 0, price: 260  },
        { desc: '×¤×¡×™ ×—×™×‘×•×¨ ×•×¤×™× ×•×ª',              unit: "×™×—'",    qty: 0, price: 120  },
      ]
    }
  ],

  '× ×–×§ ×œ×—×™×¤×•×™×™ ×§×™×¨': [
    {
      title: '×¢×‘×•×“×•×ª ×˜×™×—, ×©×¤×›×˜×œ ×•×¦×‘×¢',
      items: [
        { desc: '×§×™×œ×•×£ ××–×•×¨×™× ×¤×’×•×¢×™×',           unit: '×"×¨',    qty: 0, price: 25   },
        { desc: '×ª×™×§×•× ×™ ×˜×™×—',                    unit: '×"×¨',    qty: 0, price: 75   },
        { desc: '×©×¤×›×˜×œ ××œ×',                     unit: '×"×¨',    qty: 0, price: 65   },
        { desc: '×¤×¨×™×™××¨ ××•×˜×',                   unit: '×"×¨',    qty: 0, price: 18   },
        { desc: '×¦×‘×¢ ××§×¨×™×œ×™ â€“ 2 ×©×›×‘×•×ª',          unit: '×"×¨',    qty: 0, price: 42   },
      ]
    }
  ],

  '× ×–×§ ×œ××™× ×¡×˜×œ×¦×™×”': [
    {
      title: '×¢×‘×•×“×•×ª ××™× ×¡×˜×œ×¦×™×”',
      items: [
        { desc: '×¤×™×¨×•×§ ×¦× ×¨×ª ×¤×’×•××”',              unit: "×§×•××¤'",  qty: 1, price: 750  },
        { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ×¦× ×¨×ª ×—×“×©×”',        unit: "×§×•××¤'",  qty: 1, price: 1900 },
        { desc: '×‘×“×™×§×ª ××˜×™××•×ª',                  unit: "×§×•××¤'",  qty: 1, price: 400  },
        { desc: '×¡×’×™×¨×ª ×§×™×¨/×¨×™×¦×•×£ ×•×ª×™×§×•× ×™ ×’××¨',   unit: "×§×•××¤'",  qty: 1, price: 1200 },
      ]
    }
  ],

  '× ×–×§ ×œ× ×’×¨×™×™×” ×•×¦×™×¨×•×¤×™×': [
    {
      title: '×¢×‘×•×“×•×ª × ×’×¨×•×ª ×•××¡×’×¨×•×ª',
      items: [
        { desc: '×¤×™×¨×•×§ ×“×œ×ª×•×ª / ×—×œ×•× ×•×ª ×§×™×™××™×',  unit: "×™×—'",    qty: 0, price: 450  },
        { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ×“×œ×ª ×—×“×©×”',        unit: "×™×—'",    qty: 0, price: 2800 },
        { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ××©×§×•×£',            unit: "×™×—'",    qty: 0, price: 1450 },
        { desc: '×ª×™×§×•× ×™ ×˜×™×— ×•×¦×‘×¢ ×”×™×§×¤×™',        unit: "×™×—'",    qty: 0, price: 300  },
        { desc: '×”×—×œ×¤×ª ×™×“×™×•×ª ×•××‘×™×–×¨×™×',          unit: "×™×—'",    qty: 0, price: 180  },
        { desc: '×”×—×œ×¤×ª ×“×œ×ª×•×ª ××˜×‘×—',              unit: "×™×—'",    qty: 0, price: 450  },
        { desc: '×”×—×œ×¤×ª ×’×‘ ××˜×‘×— ×§×¨××™',            unit: "×'",     qty: 0, price: 180  },
        { desc: '×”×—×œ×¤×ª ××©×˜×— ×¢×‘×•×“×” (×©×™×©/×§×•×¨×™××Ÿ)', unit: "×'",     qty: 0, price: 650  },
        { desc: '×ª×™×§×•×Ÿ ×¦×™×¨×™×™× ×•×× ×’× ×•× ×™×',        unit: "×§×•××¤'",  qty: 1, price: 450  },
      ]
    }
  ],

  '× ×–×§ ×œ××¢×¨×›×•×ª ×—×©××œ': [
    {
      title: '×¢×‘×•×“×•×ª ×—×©××œ',
      items: [
        { desc: '×‘×“×™×§×ª ××¢×¨×›×ª ×—×©××œ',             unit: "×§×•××¤'",  qty: 1, price: 600  },
        { desc: '×”×—×œ×¤×ª ×œ×•×— ×—×©××œ',               unit: "×§×•××¤'",  qty: 1, price: 3500 },
        { desc: '×”×—×œ×¤×ª ×›×‘×œ×™× ×©× ×¤×’×¢×•',            unit: '×"×¨',    qty: 0, price: 85   },
        { desc: '×”×—×œ×¤×ª ×©×§×¢×™× ×•××¤×¡×§×™×',           unit: "×™×—'",    qty: 0, price: 120  },
        { desc: '×‘×“×™×§×ª ×ª×§×™× ×•×ª ×•××™×©×•×¨ ×—×©××œ××™',   unit: "×§×•××¤'",  qty: 1, price: 450  },
      ]
    }
  ],

  '× ×–×§ ××‘× ×™': [
    {
      title: '×¢×‘×•×“×•×ª ××‘× ×” ×•×©×™×§×•× ×§×•× ×¡×˜×¨×•×§×¦×™×”',
      items: [
        { desc: '×—×™×–×•×§ ×¡×“×§×™× ×§×•× ×¡×˜×¨×•×§×˜×™×‘×™×™×',   unit: '×"×¨',    qty: 0, price: 350  },
        { desc: '×¦×™×¤×•×™ ×•××™×˜×•× ×§×™×¨×•×ª',            unit: '×"×¨',    qty: 0, price: 180  },
        { desc: '×©×™×§×•× ×ª×§×¨×” / ×§××¨×•×Ÿ',            unit: '×"×¨',    qty: 0, price: 420  },
        { desc: '×¢×‘×•×“×•×ª ×¤×™×’×•×',                  unit: "×§×•××¤'",  qty: 1, price: 2200 },
      ]
    }
  ],

  '× ×–×§ ×œ×ª×›×•×œ×” ×•×¨×”×™×˜×™×': [
    {
      title: '× ×–×§×™ ×ª×›×•×œ×”',
      items: [
        { desc: '× ×™×§×•×™ / ×©×—×–×•×¨ ×¨×™×”×•×˜',          unit: "×™×—'",    qty: 0, price: 600  },
        { desc: '×¤×™× ×•×™ ×¨×™×”×•×˜ ×¤×’×•×',              unit: "×§×•××¤'",  qty: 1, price: 800  },
        { desc: '× ×™×§×•×™ ××§×¦×•×¢×™ ×©×˜×™×—×™×/×¨×¦×¤×•×ª',    unit: '×"×¨',    qty: 0, price: 45   },
      ]
    }
  ],

  // Shared section appended to ALL
  '_general': {
    title: '×¢×‘×•×“×•×ª × ×™×§×•×™, ×¤×™× ×•×™ ×•×¤×™×§×•×—',
    items: [
      { desc: '× ×™×§×•×™ ××ª×¨ ×‘×¡×™×•× ×¢×‘×•×“×•×ª',         unit: "×§×•××¤'",  qty: 1, price: 900  },
      { desc: '×¤×™×§×•×— ×”× ×“×¡×™ (5% ××¡×›×•× ×”×¢×‘×•×“×•×ª)', unit: '%',      qty: 5, price: 0, isPct: true },
    ]
  }
};

// All available single items for adding manually to any section
const BOQ_ALL_ITEMS = [
  // ×¤×™×¨×•×§
  { desc: '×¤×™×¨×•×§ ×¨×™×¦×•×£ ×§×™×™×',             unit: '×"×¨',    price: 85   },
  { desc: '×¤×™×¨×•×§ ××¨×™×—×™ ×§×™×¨',              unit: '×"×¨',    price: 75   },
  { desc: '×¤×™× ×•×™ ×¤×¡×•×œ×ª ×œ××ª×¨ ××•×¨×©×”',        unit: "×§×•××¤'",  price: 1800 },
  { desc: '× ×™×§×•×™ ×•×—×™×˜×•×™ ×ª×©×ª×™×ª',            unit: '×"×¨',    price: 65   },
  { desc: '×¤×™×¨×•×§ ×“×œ×ª×•×ª / ×—×œ×•× ×•×ª ×§×™×™××™×',  unit: "×™×—'",    price: 450  },
  { desc: '×¤×™×¨×•×§ ××¨×•× ×•×ª ×§×™×™××™×',           unit: "×™×—'",    price: 380  },
  { desc: '×¤×™×¨×•×§ ×¦× ×¨×ª ×¤×’×•××”',              unit: "×§×•××¤'",  price: 750  },
  { desc: '×¤×™×¨×•×§ ×’×‘×¡ / ×¤×× ×œ×™×',            unit: '×"×¨',    price: 45   },
  // ×ª×©×ª×™×ª
  { desc: '×”×—×œ×¤×ª ××¦×¢ ××–×•×”×',               unit: '×"×¨',    price: 120  },
  { desc: '×”×›× ×ª ×•×™×™×©×•×¨ ×ª×©×ª×™×ª',             unit: '×"×¨',    price: 55   },
  { desc: '×™×¦×™×§×ª ××¨×¦×¤×ª ×‘×˜×•×Ÿ',              unit: '×"×¨',    price: 145  },
  // ×¨×™×¦×•×£
  { desc: '×¨×™×¦×•×£ ×—×“×© ×›×•×œ×œ ×¨×•×‘×”',            unit: '×"×¨',    price: 260  },
  { desc: '×¨×™×¦×•×£ ×¤×¨×§×˜ ×œ××™× ×¦×™×”',            unit: '×"×¨',    price: 220  },
  { desc: '××¨×™×—×™ ×§×™×¨ â€“ ××¡×¤×§×” ×•×”× ×—×”',       unit: '×"×¨',    price: 320  },
  { desc: '×¤×¡×™ ×—×™×‘×•×¨ ×•×¤×™× ×•×ª',              unit: "×™×—'",    price: 120  },
  // ×˜×™×— ×•×¦×‘×¢
  { desc: '×§×™×œ×•×£ ××–×•×¨×™× ×¤×’×•×¢×™×',           unit: '×"×¨',    price: 25   },
  { desc: '×ª×™×§×•× ×™ ×˜×™×—',                    unit: '×"×¨',    price: 75   },
  { desc: '×˜×™×— ×¦×× ×˜×™ ××œ×',                 unit: '×"×¨',    price: 110  },
  { desc: '×©×¤×›×˜×œ ××œ×',                     unit: '×"×¨',    price: 65   },
  { desc: '×¤×¨×™×™××¨ ××•×˜×',                   unit: '×"×¨',    price: 18   },
  { desc: '×¦×‘×¢ ××§×¨×™×œ×™ â€“ 2 ×©×›×‘×•×ª',          unit: '×"×¨',    price: 42   },
  { desc: '×¦×‘×¢ ×¢××™×“ ×œ×—×•×ª',                 unit: '×"×¨',    price: 58   },
  { desc: '×˜×™×¤×•×œ ×‘×¢×•×‘×©',                   unit: '×"×¨',    price: 95   },
  // ××™× ×¡×˜×œ×¦×™×”
  { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ×¦× ×¨×ª ×—×“×©×”',        unit: "×§×•××¤'",  price: 1900 },
  { desc: '×”×—×œ×¤×ª ×¡×™×¤×•×Ÿ / × ×™×§×•×–',           unit: "×™×—'",    price: 550  },
  { desc: '×‘×“×™×§×ª ××˜×™××•×ª',                  unit: "×§×•××¤'",  price: 400  },
  { desc: '×¡×’×™×¨×ª ×§×™×¨/×¨×™×¦×•×£ ×•×ª×™×§×•× ×™ ×’××¨',   unit: "×§×•××¤'",  price: 1200 },
  { desc: '×”×—×œ×¤×ª ×‘×¨×–×™× ×•××‘×™×–×¨×™×',          unit: "×™×—'",    price: 280  },
  // × ×’×¨×•×ª
  { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ×“×œ×ª ×—×“×©×”',        unit: "×™×—'",    price: 2800 },
  { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ××©×§×•×£',            unit: "×™×—'",    price: 1450 },
  { desc: '×ª×™×§×•× ×™ ×˜×™×— ×•×¦×‘×¢ ×”×™×§×¤×™',        unit: "×™×—'",    price: 300  },
  { desc: '××¡×¤×§×” ×•×”×ª×§× ×ª ×—×œ×•×Ÿ ×—×“×©',         unit: "×™×—'",    price: 2200 },
  { desc: '×”×—×œ×¤×ª ×™×“×™×•×ª ×•××‘×™×–×¨×™×',          unit: "×™×—'",    price: 180  },
  { desc: '×”×—×œ×¤×ª ××¨×•×Ÿ ××˜×‘×—',               unit: '×"×¨',    price: 1800 },
  // ×—×©××œ
  { desc: '×‘×“×™×§×ª ××¢×¨×›×ª ×—×©××œ',             unit: "×§×•××¤'",  price: 600  },
  { desc: '×”×—×œ×¤×ª ×œ×•×— ×—×©××œ',               unit: "×§×•××¤'",  price: 3500 },
  { desc: '×”×—×œ×¤×ª ×›×‘×œ×™× ×©× ×¤×’×¢×•',            unit: '×"×¨',    price: 85   },
  { desc: '×”×—×œ×¤×ª ×©×§×¢×™× ×•××¤×¡×§×™×',           unit: "×™×—'",    price: 120  },
  { desc: '×‘×“×™×§×ª ×ª×§×™× ×•×ª ×•××™×©×•×¨ ×—×©××œ××™',   unit: "×§×•××¤'",  price: 450  },
  // ××‘× ×”
  { desc: '×—×™×–×•×§ ×¡×“×§×™× ×§×•× ×¡×˜×¨×•×§×˜×™×‘×™×™×',   unit: '×"×¨',    price: 350  },
  { desc: '×¦×™×¤×•×™ ×•××™×˜×•× ×§×™×¨×•×ª',            unit: '×"×¨',    price: 180  },
  { desc: '×©×™×§×•× ×ª×§×¨×” / ×§××¨×•×Ÿ',            unit: '×"×¨',    price: 420  },
  { desc: '×¢×‘×•×“×•×ª ×¤×™×’×•×',                  unit: "×§×•××¤'",  price: 2200 },
  // ×›×œ×œ×™
  { desc: '× ×™×§×•×™ ××ª×¨ ×‘×¡×™×•× ×¢×‘×•×“×•×ª',         unit: "×§×•××¤'",  price: 900  },
  { desc: '×¤×™×§×•×— ×”× ×“×¡×™ (5% ××¡×”"×› ×¢×‘×•×“×•×ª)',   unit: '%',      price: 0, isPct: true  },
  { desc: '×¤×¨×™×˜ ××•×ª×× ××™×©×™×ª',               unit: "×™×—'",    price: 0    },
];

// â”€â”€â”€ BOQ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let boqSections = []; // [{id, title, rows:[{desc,unit,qty,price}]}]
let boqSectionCounter = 0;

// â”€â”€â”€ INIT BOQ from damage types selected in step 4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBoq() {
  // Read checked damage types from step 4
  const checkedTypes = Array.from(
    document.querySelectorAll('#step5 .checkbox-item.checked .cb-label')
  ).map(el => el.textContent.trim());

  // Show suggestion bar
  const bar = document.getElementById('boqSuggestionBar');
  const tagsEl = document.getElementById('boqSuggestionTags');
  const suggestedSections = [];

  checkedTypes.forEach(type => {
    const sections = BOQ_CATALOG[type];
    if (sections) sections.forEach(s => suggestedSections.push({...s, fromType: type}));
  });
  // Always suggest general at end
  suggestedSections.push({...BOQ_CATALOG['_general'], fromType: '×›×œ×œ×™'});

  if (suggestedSections.length > 1) {
    bar.style.display = 'block';
    tagsEl.innerHTML = '';
    suggestedSections.forEach((sec, i) => {
      const tag = document.createElement('span');
      tag.className = 'boq-suggestion-tag';
      tag.dataset.idx = i;
      tag.innerHTML = `<span>+</span> ${sec.title}`;
      tag.onclick = () => {
        if (tag.classList.contains('added')) return;
        addBoqSectionFromTemplate(sec);
        tag.classList.add('added');
        tag.innerHTML = `âœ“ ${sec.title}`;
      };
      tagsEl.appendChild(tag);
    });
    // Store for apply-all
    window._boqSuggested = suggestedSections;
  }

  // If no sections yet, auto-add suggested ones
  if (boqSections.length === 0 && suggestedSections.length > 0) {
    suggestedSections.forEach(s => addBoqSectionFromTemplate(s));
    // Mark all tags as added
    document.querySelectorAll('.boq-suggestion-tag').forEach(t => {
      t.classList.add('added');
      t.innerHTML = 'âœ“ ' + t.innerHTML.replace('<span>+</span> ','');
    });
  }
}

function applyAllSuggested() {
  const sug = window._boqSuggested || [];
  const existingTitles = boqSections.map(s => s.title);
  sug.forEach(s => {
    if (!existingTitles.includes(s.title)) addBoqSectionFromTemplate(s);
  });
  document.querySelectorAll('.boq-suggestion-tag').forEach(t => {
    t.classList.add('added');
    t.innerHTML = 'âœ“ ' + t.textContent.replace('+ ','').replace('âœ“ ','');
  });
}

// â”€â”€â”€ ADD SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addBoqSectionFromTemplate(template) {
  const id = ++boqSectionCounter;
  const section = {
    id,
    title: template.title || `×¡×¢×™×£ ${id}`,
    rows: (template.items || []).map((item, i) => ({
      id: `${id}_${i}`,
      desc: item.desc,
      unit: item.unit,
      qty: item.qty || 0,
      price: item.price || 0,
      isPct: item.isPct || false
    }))
  };
  boqSections.push(section);
  renderBoq();
}

function addBoqSection() {
  const id = ++boqSectionCounter;
  boqSections.push({ id, title: `×¡×¢×™×£ ×—×“×© ${id}`, rows: [] });
  renderBoq();
  // Focus on the new section title
  setTimeout(() => {
    const inputs = document.querySelectorAll('.boq-section-title');
    const last = inputs[inputs.length - 1];
    if (last) { last.focus(); last.select(); }
  }, 100);
}

function removeBoqSection(id) {
  boqSections = boqSections.filter(s => s.id !== id);
  renderBoq();
}

// â”€â”€â”€ ADD ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addBoqRow(sectionId, itemData) {
  const sec = boqSections.find(s => s.id === sectionId);
  if (!sec) return;
  const rowId = `${sectionId}_${Date.now()}`;
  sec.rows.push({
    id: rowId,
    desc: itemData?.desc || '',
    unit: itemData?.unit || "×™×—'",
    qty: itemData?.qty || 0,
    price: itemData?.price || 0,
    isPct: itemData?.isPct || false
  });
  renderBoq();
  // Reset the add-row select
  const sel = document.getElementById(`addrow_${sectionId}`);
  if (sel) sel.value = '';
}

function removeBoqRow(sectionId, rowId) {
  const sec = boqSections.find(s => s.id === sectionId);
  if (!sec) return;
  sec.rows = sec.rows.filter(r => r.id !== rowId);
  renderBoq();
}

// â”€â”€â”€ SYNC FROM DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncBoqFromDom() {
  boqSections.forEach(sec => {
    const titleEl = document.getElementById(`boq_title_${sec.id}`);
    if (titleEl) sec.title = titleEl.value;
    sec.rows.forEach(row => {
      const desc  = document.getElementById(`boq_desc_${row.id}`);
      const unit  = document.getElementById(`boq_unit_${row.id}`);
      const qty   = document.getElementById(`boq_qty_${row.id}`);
      const price = document.getElementById(`boq_price_${row.id}`);
      if (desc)  row.desc  = desc.value;
      if (unit)  row.unit  = unit.value;
      if (qty)   row.qty   = parseFloat(qty.value) || 0;
      if (price) row.price = parseFloat(price.value) || 0;
    });
  });
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoq() {
  syncBoqFromDom();
  const container = document.getElementById('boqSections');
  if (!container) return;

  container.innerHTML = boqSections.map((sec, si) => {
    const secTotal = sec.rows.reduce((s, r) => s + (r.qty * r.price), 0);
    const rowsHtml = sec.rows.map((row, ri) => {
      const rowTotal = (row.qty * row.price).toLocaleString('he-IL');
      const subNum = `${si + 1}.${ri + 1}`;
      const isPct = row.isPct;
      const qtyReadOnly  = isPct ? 'readonly style="opacity:0.6;text-align:center"' : 'min="0" step="0.1"';
      const priceReadOnly = isPct ? 'readonly style="opacity:0.6;text-align:left" placeholder="×—×™×©×•×‘ ××•×˜×•××˜×™"' : 'min="0"';
      return `<tr ${isPct ? 'style="background:rgba(212,168,83,0.04)"' : ''}>
        <td class="num-col">${subNum}</td>
        <td><input type="text" id="boq_desc_${row.id}" value="${esc(row.desc)}" placeholder="×ª×™××•×¨ ×¢×‘×•×“×”" oninput="updateBoqTotal()" ${isPct ? 'readonly style="opacity:0.7"' : ''}></td>
        <td><input type="text" id="boq_unit_${row.id}" value="${esc(row.unit)}" style="text-align:center" ${isPct ? 'readonly style="opacity:0.6;text-align:center"' : ''} oninput="updateBoqTotal()"></td>
        <td><input type="number" id="boq_qty_${row.id}" value="${row.qty || ''}" placeholder="${isPct ? '%' : '0'}" ${qtyReadOnly} oninput="updateBoqTotal()"></td>
        <td><input type="number" id="boq_price_${row.id}" value="${row.price || ''}" placeholder="â‚ª" ${priceReadOnly} oninput="updateBoqTotal()"></td>
        <td class="total-cell" id="boq_total_${row.id}">â‚ª0</td>
        <td><button class="del-row" onclick="removeBoqRow(${sec.id},'${row.id}')" title="××—×§ ×©×•×¨×”">âœ•</button></td>
      </tr>`;
    }).join('');

    // Build add-row dropdown
    const itemOpts = BOQ_ALL_ITEMS.map((item, i) =>
      `<option value="${i}">${item.desc}</option>`
    ).join('');

    return `
    <div class="boq-section" id="boq_sec_${sec.id}">
      <div class="boq-section-header">
        <div class="boq-section-num">${si + 1}</div>
        <input class="boq-section-title" id="boq_title_${sec.id}" value="${esc(sec.title)}" placeholder="×©× ×”×¤×¨×§...">
        <span class="boq-section-total">â‚ª${secTotal.toLocaleString('he-IL')}</span>
        <button class="boq-delete-section" onclick="removeBoqSection(${sec.id})" title="××—×§ ×¤×¨×§">ğŸ—‘</button>
      </div>
      <table class="boq-table">
        <thead>
          <tr>
            <th class="num-col">×¡×¢×™×£</th>
            <th>×ª×™××•×¨ ×¢×‘×•×“×”</th>
            <th class="unit-col">×™×—'</th>
            <th class="qty-col">×›××•×ª</th>
            <th class="price-col">××—×™×¨ ×™×—'</th>
            <th class="total-col">×¡×”"×› (â‚ª)</th>
            <th class="act-col"></th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <div class="boq-add-row">
        <select id="addrow_${sec.id}" onchange="onAddRowSelect(${sec.id},this)">
          <option value="">+ ×‘×—×¨ ×¢×‘×•×“×” ×œ×”×•×¡×¤×”...</option>
          ${itemOpts}
          <option value="custom">âœï¸ ×©×•×¨×” ×¨×™×§×” (××•×ª×× ××™×©×™×ª)</option>
        </select>
      </div>
    </div>`;
  }).join('');

  updateBoqTotal();
}

function onAddRowSelect(secId, sel) {
  const val = sel.value;
  if (!val) return;
  if (val === 'custom') {
    addBoqRow(secId, { desc: '', unit: "×™×—'", qty: 0, price: 0 });
  } else {
    const item = BOQ_ALL_ITEMS[parseInt(val)];
    if (item) addBoqRow(secId, { ...item, qty: 0 });
  }
}

function esc(str) {
  return String(str||'').replace(/"/g, '&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBoqTotal() {
  syncBoqFromDom();

  // First pass: subtotal of non-pct rows (for calculating 5% supervision)
  let grandSubtotal = 0;
  boqSections.forEach(sec => {
    sec.rows.forEach(row => {
      if (row.isPct) return;
      const qty   = parseFloat(document.getElementById(`boq_qty_${row.id}`)?.value   || row.qty   || 0);
      const price = parseFloat(document.getElementById(`boq_price_${row.id}`)?.value || row.price || 0);
      grandSubtotal += qty * price;
    });
  });

  // Second pass: update pct rows & section totals & row cells
  boqSections.forEach(sec => {
    let secTotal = 0;
    sec.rows.forEach((row, idx) => {
      const qty   = parseFloat(document.getElementById(`boq_qty_${row.id}`)?.value || row.qty || 0);
      let price   = parseFloat(document.getElementById(`boq_price_${row.id}`)?.value || row.price || 0);
      let rowTotal;
      if (row.isPct) {
        price = Math.round(grandSubtotal * (qty / 100));
        const pel = document.getElementById(`boq_price_${row.id}`);
        if (pel) { pel.value = price; pel.readOnly = true; pel.style.opacity='0.6'; }
        rowTotal = price;
      } else {
        rowTotal = qty * price;
      }
      secTotal += rowTotal;
      const cells = document.querySelectorAll(`#boq_sec_${sec.id} tbody tr`);
      if (cells[idx]) {
        const tc = cells[idx].querySelector('.total-cell');
        if (tc) tc.textContent = 'â‚ª' + rowTotal.toLocaleString('he-IL');
      }
    });
    const totEl = document.querySelector(`#boq_sec_${sec.id} .boq-section-total`);
    if (totEl) totEl.textContent = 'â‚ª' + secTotal.toLocaleString('he-IL');
  });

  // Grand total
  let grandTotal = 0;
  boqSections.forEach(sec => {
    sec.rows.forEach(row => {
      const qty   = parseFloat(document.getElementById(`boq_qty_${row.id}`)?.value   || row.qty   || 0);
      const price = parseFloat(document.getElementById(`boq_price_${row.id}`)?.value || row.price || 0);
      grandTotal += row.isPct ? price : qty * price;
    });
  });

  const vatActive = document.querySelector('#vatCalc .radio-btn.active')?.textContent?.includes('18%') ||
                    document.querySelector('#vatCalc .radio-btn.active')?.textContent?.includes('×›×•×œ×œ');
  const withVat = vatActive ? grandTotal * 1.18 : grandTotal;

  const deductible  = parseFloat(document.getElementById('deductible')?.value)   || 0;
  const depreciation= parseFloat(document.getElementById('depreciation')?.value) || 0;
  const extra       = parseFloat(document.getElementById('extraCosts')?.value)    || 0;
  const rental      = parseFloat(document.getElementById('rentalTotal')?.value)   || 0;
  const net         = Math.max(0, withVat - deductible - depreciation + extra + rental);

  const fmtN = n => 'â‚ª' + Math.round(n).toLocaleString('he-IL');

  // Summary rows
  const summaryEl = document.getElementById('boqSummaryRows');
  if (summaryEl) {
    let html = '';
    boqSections.forEach(sec => {
      const secTotal = sec.rows.reduce((s, r) => {
        const qty   = parseFloat(document.getElementById(`boq_qty_${r.id}`)?.value   || r.qty   || 0);
        const price = parseFloat(document.getElementById(`boq_price_${r.id}`)?.value || r.price || 0);
        return s + qty * price;
      }, 0);
      if (secTotal > 0) {
        html += `<div class="boq-sum-row"><span class="sr-label">${sec.title}</span><span class="sr-amount">${fmtN(secTotal)}</span></div>`;
      }
    });
    html += `<div class="boq-sum-row grand"><span class="sr-label">×¡×”"×› ×œ×¤× ×™ ××¢"×</span><span class="sr-amount">${fmtN(grandTotal)}</span></div>`;
    if (vatActive) html += `<div class="boq-sum-row"><span class="sr-label">××¢"× 18%</span><span class="sr-amount">${fmtN(grandTotal * 0.18)}</span></div>`;
    summaryEl.innerHTML = html;
  }

  const bv = document.getElementById('totalBeforeVat');
  const tg = document.getElementById('totalGross');
  const tn = document.getElementById('totalNet');
  if (bv) bv.textContent = fmtN(grandTotal);
  if (tg) tg.textContent = fmtN(withVat);
  if (tn) tn.textContent = fmtN(net);

  // Also update legacy damageTotal if it exists
  const dt = document.getElementById('damageTotal');
  if (dt) dt.innerHTML = `×¡×”"×› ×”× ×–×§ ×”××•×¢×¨×š: <span>${fmtN(withVat)}</span>`;
}

// â”€â”€â”€ GET BOQ DATA FOR REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getBoqData() {
  syncBoqFromDom();
  return boqSections.map((sec, si) => {
    const rows = sec.rows.map((row, ri) => {
      const qty   = parseFloat(document.getElementById(`boq_qty_${row.id}`)?.value   || row.qty   || 0);
      const price = parseFloat(document.getElementById(`boq_price_${row.id}`)?.value || row.price || 0);
      return { ...row, qty, price, total: qty * price, subNum: `${si+1}.${ri+1}` };
    });
    const secTotal = rows.reduce((s, r) => s + r.total, 0);
    return { ...sec, rows, secTotal, sectionNum: si + 1 };
  });
}

// ====== POLICY TYPE ======
let selectedPolicyType = null;

const POLICY_CONFIG = {
  structure_mortgage: {
    label: '××‘× ×” ×“×¨×š ××©×›× ×ª×',
    structure: true,
    contents: false,
    alert: { type: 'warning', msg: 'âš ï¸ ×¤×•×œ×™×¡×ª ××©×›× ×ª× â€” <strong>××™×Ÿ ×›×™×¡×•×™ ×œ×ª×›×•×œ×”.</strong> ×¤×¨×™×˜×™ ×ª×›×•×œ×” ×™×¡×•×× ×• ×›"×œ× ××›×•×¡×”" ×•×œ× ×™×›×œ×œ×• ×‘×¡×›×•× ×”×ª×‘×™×¢×”.' }
  },
  structure_only: {
    label: '××‘× ×” ×‘×œ×‘×“',
    structure: true,
    contents: false,
    alert: { type: 'info', msg: 'â„¹ï¸ ×¤×•×œ×™×¡×ª ××‘× ×” ×‘×œ×‘×“ â€” × ×–×§×™ ×ª×›×•×œ×” <strong>××™× × ××›×•×¡×™×</strong> ×‘×¤×•×œ×™×¡×” ×–×•.' }
  },
  structure_contents: {
    label: '××‘× ×” + ×ª×›×•×œ×”',
    structure: true,
    contents: true,
    alert: { type: 'success', msg: 'âœ… ×¤×•×œ×™×¡×” ××œ××” â€” ×›×™×¡×•×™ ××‘× ×” ×•×ª×›×•×œ×” ×¤×¢×™×œ.' }
  },
  contents_only: {
    label: '×ª×›×•×œ×” ×‘×œ×‘×“',
    structure: false,
    contents: true,
    alert: { type: 'info', msg: 'â„¹ï¸ ×¤×•×œ×™×¡×ª ×ª×›×•×œ×” ×‘×œ×‘×“ â€” × ×–×§×™ ××‘× ×” <strong>××™× × ××›×•×¡×™×</strong> ×‘×¤×•×œ×™×¡×” ×–×•.' }
  },
  comprehensive: {
    label: '×›×œ ×”×¡×™×›×•× ×™×',
    structure: true,
    contents: true,
    alert: { type: 'success', msg: 'âœ… ×¤×•×œ×™×¡×ª ×›×œ ×”×¡×™×›×•× ×™× â€” ×›×™×¡×•×™ ××§×™×£ ×œ××‘× ×”, ×ª×›×•×œ×” ×•×”×¨×—×‘×•×ª.' }
  },
  other_policy: {
    label: '×¤×•×œ×™×¡×” ××—×¨×ª',
    structure: true,
    contents: true,
    alert: { type: 'info', msg: 'â„¹ï¸ ×‘×“×•×§ ××ª ×¤×¨×˜×™ ×”×¤×•×œ×™×¡×” ×”×¡×¤×¦×™×¤×™×ª ×œ×§×‘×™×¢×ª ×’×‘×•×œ×•×ª ×”×›×™×¡×•×™.' }
  }
};

function selectPolicyType(el) {
  document.querySelectorAll('.policy-type-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedPolicyType = el.dataset.type;
  const cfg = POLICY_CONFIG[selectedPolicyType];

  // Show/hide alert
  const alertEl = document.getElementById('policyAlert');
  if (cfg.alert) {
    alertEl.style.display = 'flex';
    const colors = {
      warning: { bg: 'rgba(245,158,11,0.1)', border: 'rgba(245,158,11,0.3)', color: '#d97706' },
      info:    { bg: 'rgba(59,130,246,0.08)', border: 'rgba(59,130,246,0.25)', color: '#3b82f6' },
      success: { bg: 'rgba(34,197,94,0.08)', border: 'rgba(34,197,94,0.25)', color: '#22c55e' }
    };
    const c = colors[cfg.alert.type] || colors.info;
    alertEl.style.cssText = `display:flex;border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:1.25rem;font-size:0.87rem;font-weight:500;align-items:center;gap:10px;background:${c.bg};border:1px solid ${c.border};color:${c.color}`;
    alertEl.innerHTML = cfg.alert.msg;
  }

  // Show/hide coverage sections
  document.getElementById('structureCoverageSection').style.display = cfg.structure ? 'block' : 'none';
  document.getElementById('contentsCoverageSection').style.display = cfg.contents ? 'block' : 'none';
  document.getElementById('extensionsSection').style.display = 'block';
  document.getElementById('policyDeductiblesSection').style.display = 'block';
  document.getElementById('contentsDeductibleGroup').style.display = cfg.contents ? 'block' : 'none';

  // Update damage table category options
  updateDamageCategories();
  calcInsuranceAdequacy();
  updateTotal();
}

// ====== DAMAGE ITEMS ======
function addDamageItem(desc='', qty='', price='', cat='') {
  const container = document.getElementById('damageItems');
  if (!container) return; // element no longer exists in BOQ-based step 5
  const div = document.createElement('div');
  div.className = 'damage-item';

  const catOptions = buildCategoryOptions(cat);
  div.innerHTML = `
    <input type="text" placeholder="×ª×™××•×¨ × ×–×§ / ×¢×‘×•×“×”" value="${desc}" oninput="updateTotal()">
    <input type="text" placeholder="×›××•×ª / ×©×˜×—" value="${qty}">
    <select class="dmg-category" onchange="updateTotal()" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:9px 10px;color:var(--text-primary);font-family:inherit;font-size:0.85rem;width:100%">${catOptions}</select>
    <input type="number" placeholder="0" min="0" value="${price}" oninput="updateTotal()" style="min-width:90px">
    <button class="remove-btn" onclick="removeDamageItem(this)" title="×”×¡×¨">âœ•</button>
  `;
  container.appendChild(div);

  // Update header
  const header = document.getElementById('damageTableHeader');
  if (header) header.style.gridTemplateColumns = '2fr 1fr 1fr 1fr auto';

  updateTotal();
}

function buildCategoryOptions(selected='') {
  const cfg = selectedPolicyType ? POLICY_CONFIG[selectedPolicyType] : null;

  const opts = [
    { value: 'structure', label: 'ğŸ—ï¸ ××‘× ×”', covered: cfg ? cfg.structure : true },
    { value: 'contents',  label: 'ğŸ“¦ ×ª×›×•×œ×”', covered: cfg ? cfg.contents : true },
    { value: 'both',      label: 'ğŸ”€ ××‘× ×” + ×ª×›×•×œ×”', covered: true },
  ];

  return opts.map(o => {
    const suffix = o.covered ? '' : ' â›” ×œ× ××›×•×¡×”';
    return `<option value="${o.value}" ${selected === o.value ? 'selected' : ''}>${o.label}${suffix}</option>`;
  }).join('');
}

function updateDamageCategories() {
  document.querySelectorAll('.dmg-category').forEach(sel => {
    const current = sel.value;
    sel.innerHTML = buildCategoryOptions(current);
  });
}

function removeDamageItem(btn) {
  btn.closest('.damage-item').remove();
  updateTotal();
}

function updateTotal() {
  const cfg = selectedPolicyType ? POLICY_CONFIG[selectedPolicyType] : null;
  let coveredGross = 0;
  let uncoveredGross = 0;

  document.querySelectorAll('.damage-item').forEach(row => {
    const price = parseFloat(row.querySelector('input[type="number"]')?.value) || 0;
    const cat = row.querySelector('.dmg-category')?.value || 'structure';

    let isCovered = true;
    if (cfg) {
      if (cat === 'structure') isCovered = cfg.structure;
      else if (cat === 'contents') isCovered = cfg.contents;
      else if (cat === 'both') isCovered = cfg.structure || cfg.contents;
    }

    // Visual feedback on row
    row.style.borderColor = isCovered ? 'var(--border)' : 'rgba(239,68,68,0.3)';
    row.style.opacity = isCovered ? '1' : '0.65';

    if (isCovered) coveredGross += price;
    else uncoveredGross += price;
  });

  const deductible = parseFloat(document.getElementById('deductible')?.value) || 0;
  const depreciation = parseFloat(document.getElementById('depreciation')?.value) || 0;
  const extra = parseFloat(document.getElementById('extraCosts')?.value) || 0;
  const rental = parseFloat(document.getElementById('rentalTotal')?.value) || 0;

  const vatActive = document.querySelector('#vatCalc .radio-btn.active')?.textContent === '×›×œ×•×œ';
  const coveredWithVat = vatActive ? coveredGross * 1.18 : coveredGross;
  const uncoveredWithVat = vatActive ? uncoveredGross * 1.18 : uncoveredGross;
  const totalWithVat = coveredWithVat + uncoveredWithVat;
  const net = coveredWithVat - deductible - depreciation + extra + rental;

  const fmtN = n => 'â‚ª' + Math.max(0, Math.round(n)).toLocaleString('he-IL');

  const totalEl = document.getElementById('damageTotal');
  if (totalEl) {
    if (cfg && !cfg.contents && !cfg.structure) {
      totalEl.innerHTML = `×¡×”"×› × ×–×§ ××•×¢×¨×š: <span>${fmtN(totalWithVat)}</span>`;
    } else if (cfg && uncoveredGross > 0) {
      totalEl.innerHTML = `×¡×”"×› × ×–×§: <span>${fmtN(totalWithVat)}</span> &nbsp;|&nbsp; <span style="color:#22c55e">××›×•×¡×”: ${fmtN(coveredWithVat)}</span> &nbsp;|&nbsp; <span style="color:#ef4444">×œ× ××›×•×¡×”: ${fmtN(uncoveredWithVat)}</span>`;
    } else {
      totalEl.innerHTML = `×¡×”"×› ×”× ×–×§ ×”××•×¢×¨×š: <span>${fmtN(totalWithVat)}</span>`;
    }
  }

  const tg = document.getElementById('totalGross');
  const tn = document.getElementById('totalNet');
  if (tg) tg.textContent = fmtN(coveredWithVat);
  if (tn) tn.textContent = fmtN(Math.max(0, net));

  // Update summary labels
  const sgLabel = document.querySelector('#totalGross')?.previousElementSibling;
  if (sgLabel) sgLabel.textContent = cfg && uncoveredGross > 0 ? '×¡×”"×› × ×–×§ ××›×•×¡×”' : '×¡×”"×› × ×–×§ ×’×•×œ××™';
}

// ====== NUMBER FORMATTER ======
function formatCurrency(input) {
  let val = input.value.replace(/[^\d]/g, ''); // remove all non-digits
  if (val === '') {
    input.value = '';
    return;
  }
  const num = parseInt(val);
  input.value = num.toLocaleString('he-IL');
}

// ====== INSURANCE ADEQUACY ======
function calcBuildingCost() {
  const sqm = parseFloat(document.getElementById('propArea')?.value) || 0;
  const costPerSqm = parseFloat((document.getElementById('buildingCostPerSqm')?.value || '').replace(/,/g, '')) || 0;
  if (sqm && costPerSqm) {
    const calc = sqm * costPerSqm;
    const appraised = document.getElementById('structureAppraisedValue');
    if (appraised && !appraised.value) appraised.value = Math.round(calc);
    calcInsuranceAdequacy();
  }
}

function calcInsuranceAdequacy() {
  const cfg = selectedPolicyType ? POLICY_CONFIG[selectedPolicyType] : null;
  if (!cfg) return;

  const fmtN = n => 'â‚ª' + Math.round(n).toLocaleString('he-IL');
  const pct  = (a, b) => b > 0 ? Math.round((a / b) * 100) : 0;
  let showSummary = false;

  // â”€â”€ STRUCTURE COVERAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (cfg.structure) {
    const limit     = parseFloat((document.getElementById('structureCoverageLimit')?.value || '').replace(/,/g, ''))    || 0;
    const appraised = parseFloat((document.getElementById('structureAppraisedValue')?.value || '').replace(/,/g, ''))   || 0;
    const structBox = document.getElementById('structureAdequacyBox');

    if (limit > 0 && appraised > 0) {
      showSummary = true;
      const ratio = pct(limit, appraised);
      const isMortgage = selectedPolicyType === 'structure_mortgage';

      let statusClass = ratio >= 100 ? 'success' : ratio >= 80 ? 'warning' : 'danger';
      let statusLabel, ruleHtml = '';

      if (isMortgage) {
        // â”€â”€ MORTGAGE: no underinsurance rule. Just max coverage gap.
        if (ratio >= 100) {
          statusLabel = 'âœ… ×›×™×¡×•×™ ××œ×';
        } else {
          statusLabel = 'âš ï¸ ×—×•×¡×¨ ×›×™×¡×•×™';
          ruleHtml = `<div class="underins-rule">
            <strong>ğŸ¦ ×‘×™×˜×•×— ××‘× ×” â€“ ×›×™×¡×•×™ ××§×¡×™××œ×™</strong>
            ×’×‘×•×œ ×”×›×™×¡×•×™ ×”×•× <strong>${fmtN(limit)}</strong>. ×× ×”× ×–×§ ×¢×•×œ×” ×¢×œ ×¡×›×•× ×–×” â€” ×”×—×œ×§ ×”×¢×•×“×£ <span style="color:var(--danger)">××™× ×• ××›×•×¡×”</span>.
            ×—×•×¡×¨ ×›×™×¡×•×™: <span style="color:var(--danger)">${fmtN(appraised - limit)}</span> &nbsp;(×”×¤×¨×© ×‘×™×Ÿ ×”×©×•×•×™ ×œ×’×‘×•×œ ×”×¤×•×œ×™×¡×”)
          </div>`;
        }
      } else {
        // â”€â”€ OTHER POLICIES: underinsurance Coinsurance Rule
        // Formula: insurer pays = (limit / appraised) Ã— damage
        // Example: limit=100, appraised=200, damage=200 â†’ pays = (100/200)Ã—200 = 100 â†’ but capped at limit
        // Example: limit=100, appraised=200, damage=100 â†’ pays = (100/200)Ã—100 = 50
        if (ratio >= 100) {
          statusLabel = 'âœ… ×›×™×¡×•×™ ××œ×';
        } else {
          statusLabel = 'âŒ ×ª×ª-×‘×™×˜×•×—';
          const exampleDamage = Math.round(appraised * 0.3); // 30% damage example
          const paidByInsurer = Math.round((limit / appraised) * exampleDamage);
          ruleHtml = `<div class="underins-rule">
            <strong>âš–ï¸ ×›×œ×œ ×ª×ª-×”×‘×™×˜×•×— â€“ ×”× ×•×¡×—×”</strong>
            ×©×™×¢×•×¨ ×›×™×¡×•×™: <strong>${ratio}%</strong> &nbsp;(×’×‘×•×œ Ã· ×©×•×•×™ ×××™×ª×™)<br>
            ×”×‘×™×˜×•×— ×™×©×œ×: <strong>(×’×‘×•×œ ×›×™×¡×•×™ Ã· ×©×•×•×™ ×××™×ª×™) Ã— ×¡×›×•× ×”× ×–×§</strong><br>
            <span style="font-size:0.8rem;color:var(--text-muted)">×“×•×’××”: × ×–×§ ×©×œ ${fmtN(exampleDamage)} â€” ×”×‘×™×˜×•×— ×™×©×œ× <strong>${fmtN(paidByInsurer)}</strong> (${ratio}% ××”× ×–×§)</span><br>
            <span style="font-size:0.8rem;color:var(--text-muted)">× ×–×§ ×©×œ ${fmtN(limit)} â€” ×”×‘×™×˜×•×— ×™×©×œ× <strong>${fmtN(Math.round((limit/appraised)*limit))}</strong> ×•×œ× ${fmtN(limit)}</span><br>
            ×—×•×¡×¨ ×›×™×¡×•×™: <span style="color:var(--danger)">${fmtN(appraised - limit)}</span>
          </div>`;
        }
      }

      structBox.style.display = 'block';
      structBox.innerHTML = `
        <div class="adequacy-box" style="margin-bottom:8px">
          <div class="adequacy-item">
            <div class="ai-label">×’×‘×•×œ ×›×™×¡×•×™</div>
            <div class="ai-value">${fmtN(limit)}</div>
          </div>
          <div class="adequacy-item">
            <div class="ai-label">×©×•×•×™ ${isMortgage ? '× ×›×¡' : '×©×××™'}</div>
            <div class="ai-value">${fmtN(appraised)}</div>
          </div>
          <div class="adequacy-item ${statusClass}">
            <div class="ai-label">×©×™×¢×•×¨ ×›×™×¡×•×™</div>
            <div class="ai-value">${ratio}% â€” ${statusLabel}</div>
          </div>
        </div>
        ${ruleHtml}`;
    } else {
      if (structBox) structBox.style.display = 'none';
    }
  }

  // â”€â”€ CONTENTS COVERAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (cfg.contents) {
    const limit     = parseFloat((document.getElementById('contentsCoverageLimit')?.value || '').replace(/,/g, ''))    || 0;
    const appraised = parseFloat((document.getElementById('contentsAppraisedValue')?.value || '').replace(/,/g, ''))   || 0;
    const contBox   = document.getElementById('contentsAdequacyBox');

    if (limit > 0 && appraised > 0) {
      showSummary = true;
      const ratio = pct(limit, appraised);
      let statusClass = ratio >= 100 ? 'success' : ratio >= 80 ? 'warning' : 'danger';
      let statusLabel = ratio >= 100 ? 'âœ… ×›×™×¡×•×™ ××œ×' : 'âŒ ×ª×ª-×‘×™×˜×•×—';

      let ruleHtml = '';
      if (ratio < 100) {
        const exDmg = Math.round(appraised * 0.5);
        const exPaid = Math.round((limit / appraised) * exDmg);
        ruleHtml = `<div class="underins-rule" style="margin-top:8px">
          <strong>âš–ï¸ ×ª×ª-×‘×™×˜×•×— ×‘×ª×›×•×œ×”</strong>
          ×”×‘×™×˜×•×— ×™×©×œ×: <strong>(${fmtN(limit)} Ã· ${fmtN(appraised)}) Ã— × ×–×§</strong><br>
          <span style="font-size:0.8rem;color:var(--text-muted)">×“×•×’××”: × ×–×§ ${fmtN(exDmg)} â†’ ×™×©×•×œ× ${fmtN(exPaid)} (${ratio}%)</span><br>
          ×—×•×¡×¨: <span style="color:var(--danger)">${fmtN(appraised - limit)}</span>
        </div>`;
      }

      contBox.style.display = 'block';
      contBox.innerHTML = `
        <div class="adequacy-box">
          <div class="adequacy-item"><div class="ai-label">×’×‘×•×œ ×›×™×¡×•×™ ×ª×›×•×œ×”</div><div class="ai-value">${fmtN(limit)}</div></div>
          <div class="adequacy-item"><div class="ai-label">×©×•×•×™ ×ª×›×•×œ×”</div><div class="ai-value">${fmtN(appraised)}</div></div>
          <div class="adequacy-item ${statusClass}"><div class="ai-label">×©×™×¢×•×¨ ×›×™×¡×•×™</div><div class="ai-value">${ratio}% â€” ${statusLabel}</div></div>
        </div>${ruleHtml}`;
    } else {
      if (contBox) contBox.style.display = 'none';
    }
  }

  document.getElementById('underinsuranceSummary').style.display = showSummary ? 'block' : 'none';
}

// ====== PHOTOS ======
function handlePhotos(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      photos.push({src: e.target.result, name: file.name, caption: ''});
      renderPhotos();
    };
    reader.readAsDataURL(file);
  });
}

function renderPhotos() {
  const grid = document.getElementById('photoGrid');
  grid.innerHTML = '';
  photos.forEach((p, i) => {
    const div = document.createElement('div');
    div.className = 'photo-thumb';
    div.innerHTML = `
      <img src="${p.src}" alt="${p.name}">
      <button class="rm-photo" onclick="removePhoto(${i})">âœ•</button>
      <input class="caption-input" placeholder="×ª×™××•×¨..." value="${p.caption}"
        oninput="photos[${i}].caption=this.value">
    `;
    grid.appendChild(div);
  });
}

function removePhoto(i) {
  photos.splice(i, 1);
  renderPhotos();
}

// ====== HELPERS ======
function getRadioValue(groupId) {
  const el = document.querySelector(`#${groupId} .radio-btn.active`);
  return el ? el.textContent.trim() : '';
}

function getCheckedLabels(groupId) {
  const items = document.querySelectorAll(`#${groupId} .checkbox-item.checked .cb-label`);
  return Array.from(items).map(i => i.textContent.trim()).filter(Boolean);
}

function getCheckedLabelsAll(selector) {
  const items = document.querySelectorAll(selector + ' .checkbox-item.checked .cb-label');
  return Array.from(items).map(i => i.textContent.trim()).filter(Boolean);
}

function val(id) {
  const el = document.getElementById(id);
  return el ? (el.value || '').trim() : '';
}

function fmt(n) {
  return 'â‚ª' + Math.round(parseFloat(n) || 0).toLocaleString('he-IL');
}

function calcTotal() {
  let gross = 0;
  document.querySelectorAll('.damage-item input[type="number"]').forEach(inp => {
    gross += parseFloat(inp.value) || 0;
  });
  const vatActive = document.querySelector('#vatCalc .radio-btn.active')?.textContent === '×›×œ×•×œ';
  return vatActive ? gross * 1.18 : gross;
}

function getDamageRows() {
  const rows = [];
  const cfg = selectedPolicyType ? POLICY_CONFIG[selectedPolicyType] : null;
  document.querySelectorAll('.damage-item').forEach(row => {
    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
    const desc = row.querySelector('input[type="text"]')?.value.trim();
    const qty = row.querySelectorAll('input[type="text"]')[1]?.value.trim();
    const cat = row.querySelector('.dmg-category')?.value || 'structure';
    const price = parseFloat(row.querySelector('input[type="number"]')?.value) || 0;

    let isCovered = true;
    if (cfg) {
      if (cat === 'structure') isCovered = cfg.structure;
      else if (cat === 'contents') isCovered = cfg.contents;
    }

    const catLabel = { structure: '××‘× ×”', contents: '×ª×›×•×œ×”', both: '××‘× ×” + ×ª×›×•×œ×”' }[cat] || cat;
    if (desc) rows.push({ desc, qty, cat, catLabel, price, isCovered });
  });
  return rows;
}

// ====== AUTO-GENERATE RECOMMENDATIONS ======
function generateRecommendations() {
  const boqData = getBoqData();
  let recs = [];
  
  // Opening - always first
  recs.push('ğŸ”§ ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª ××•××œ×¥ ×œ×©×™×§×•× ×”× ×›×¡:\n');
  
  // Critical first steps
  const hasDemolition = boqData.some(sec => 
    sec.rows.some(r => r.desc.includes('×¤×™×¨×•×§') || r.desc.includes('×¤×™× ×•×™'))
  );
  const hasWaterproofing = boqData.some(sec =>
    sec.rows.some(r => r.desc.includes('××™×˜×•×') || r.desc.includes('××™× ×¡×˜×œ×¦×™×”'))
  );
  const hasElectrical = boqData.some(sec =>
    sec.rows.some(r => r.desc.includes('×—×©××œ') || r.desc.includes('×œ×•×— ×—×©××œ'))
  );
  
  if (selectedEvent === 'water' || hasWaterproofing) {
    recs.push('1ï¸âƒ£ ×˜×™×¤×•×œ ××™×™×“×™ ×‘××§×•×¨ ×”× ×–×™×œ×” - ×ª×™×§×•×Ÿ ××¢×¨×›×ª ×”××™× ×¡×˜×œ×¦×™×” ×•×‘×™×¦×•×¢ ××™×˜×•× ××§×¦×•×¢×™.');
  } else if (selectedEvent === 'fire') {
    recs.push('1ï¸âƒ£ ×‘×“×™×§×ª ×™×¦×™×‘×•×ª ××‘× ×™×ª ×•××™×©×•×¨ ××”× ×“×¡ ×§×•× ×¡×˜×¨×•×§×¦×™×” ×œ×¤× ×™ ×ª×—×™×œ×ª ×¢×‘×•×“×•×ª.');
  }
  
  if (hasDemolition) {
    recs.push('2ï¸âƒ£ ×¤×™×¨×•×§ ××‘×•×§×¨ ×©×œ ×›×œ ×”×—×•××¨×™× ×”×¤×’×•××™× ×•×¤×™× ×•×™ ×œ××ª×¨ ××•×¨×©×”.');
  }
  
  if (hasWaterproofing) {
    recs.push('3ï¸âƒ£ ×™×™×‘×•×© ×™×¡×•×“×™ ×©×œ ×›×œ ×©×›×‘×•×ª ×”××¦×¢ ×•×”×§×™×¨×•×ª (×–××Ÿ ×™×™×‘×•×© ××™× ×™××œ×™: 7-14 ×™××™×).');
  }
  
  if (hasElectrical) {
    recs.push('4ï¸âƒ£ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ××¢×¨×›×ª ×”×—×©××œ ×¢"×™ ×—×©××œ××™ ××•×¡××š ×œ×¤× ×™ ×—×™×‘×•×¨ ××—×“×©.');
  }
  
  recs.push('5ï¸âƒ£ ×‘×™×¦×•×¢ ×¢×‘×•×“×•×ª ×ª×©×ª×™×ª (×˜×™×—, ××™×˜×•×, ×¦× ×¨×ª, ×—×©××œ) ×œ×¤×™ ×›×ª×‘ ×”×›××•×™×•×ª.');
  recs.push('6ï¸âƒ£ ×¢×‘×•×“×•×ª ×’××¨ (×¨×™×¦×•×£, ×¦×‘×™×¢×”, × ×’×¨×•×ª) ×¨×§ ×œ××—×¨ ××™×©×•×¨ ×©×›×‘×•×ª ×”×ª×©×ª×™×ª.');
  recs.push('7ï¸âƒ£ × ×™×§×™×•×Ÿ ×¡×•×¤×™ ×•×‘×“×™×§×ª ×§×‘×œ×”.');
  
  recs.push('\nâš ï¸ ×”×¢×¨×•×ª ×—×©×•×‘×•×ª:');
  recs.push('â€¢ ×˜×¨× ×‘×™×¦×•×¢ ×ª×™×§×•× ×™ ×’××¨ × ×“×¨×© ×˜×™×¤×•×œ ×™×¡×•×“×™ ×‘××§×•×¨ ×”× ×–×§.');
  recs.push('â€¢ ××•××œ×¥ ×¤×™×§×•×— ×”× ×“×¡×™ ×œ××•×¨×š ×›×œ ×©×œ×‘×™ ×”×©×™×§×•×.');
  recs.push('â€¢ ×™×© ×œ×•×•×“× ×ª××™××•×ª ×”×—×•××¨×™× ×•×”×©×™×˜×•×ª ×œ×ª×§× ×™× ×”×™×©×¨××œ×™×™×.');

  const ta = document.getElementById('repairPriority');
  if (ta) ta.value = recs.join('\n');
}

// ====== AUTO-GENERATE CAUSE TEXT ======
function generateCauseText() {
  const eventType = selectedEvent; // 'water', 'fire', 'break_in', etc.
  const areas = getCheckedLabels('damagedAreas');
  const damageTypes = Array.from(document.querySelectorAll('#step5 .checkbox-item.checked .cb-label'))
    .map(el => el.textContent.trim());
  
  const templates = {
    water: {
      intro: '×‘×‘×“×™×§×” ×‘××§×•× ×•×‘×”×ª×× ×œ×“×•×— ×—×‘×¨×ª ××™×ª×•×¨ × ×–×™×œ×•×ª, × ××¦× ×›×™ ××§×•×¨ ×”× ×–×§ ×”×™× ×• ×›×©×œ ×‘××¢×¨×›×ª ×”××™× ×¡×˜×œ×¦×™×”.',
      detail: '×”×›×©×œ ×’×¨× ×œ×—×“×™×¨×ª ××™× ××ª××©×›×ª ××œ ×©×›×‘×•×ª ×”××¦×¢ ×•×œ×”×™×•×•×¦×¨×•×ª ×¢×œ×™×•×ª ×§×¤×™×œ×¨×™×•×ª ×‘×©×™×¤×•×œ×™ ×”×§×™×¨×•×ª.',
      spread: areas.length > 0 ? `×”× ×–×§ ×”×ª×¤×©×˜ ×œ${areas.join(', ')}.` : '',
      type: '××“×•×‘×¨ ×‘× ×–×§ ××ª××©×š ×”× ×•×‘×¢ ××›×©×œ ×¤× ×™××™ ×‘××¢×¨×›×ª ×”×“×œ×•×—×™×Ÿ/××™× ×¡×˜×œ×¦×™×”.'
    },
    fire: {
      intro: '×‘×‘×“×™×§×” ×‘××§×•× ×•×‘×”×ª×× ×œ×“×•×— ×—×•×§×¨ ×©×¨×™×¤×•×ª, × ××¦× ×›×™ ××§×•×¨ ×”××© ×”×™×”',
      detail: '×”×©×¨×™×¤×” ×’×¨××” ×œ× ×–×§×™ ××©, ×¢×©×Ÿ ×•×¤×™×— × ×¨×—×‘×™×.',
      spread: areas.length > 0 ? `×”×©×¨×™×¤×” ×”×ª×¤×©×˜×” ×‘${areas.join(', ')}.` : '',
      type: '××“×•×‘×¨ ×‘××™×¨×•×¢ ×—×“-×¤×¢××™ ×”× ×•×‘×¢ ×××© ×’×œ×•×™×”.'
    },
    break_in: {
      intro: '×‘×‘×“×™×§×” ×‘××§×•× ×•×‘×”×ª×× ×œ×“×•×— ××©×˜×¨×ª ×™×©×¨××œ, × ××¦××• ×¡×™×× ×™ ×¤×¨×™×¦×”.',
      detail: '×”×¤×¨×™×¦×” ×›×œ×œ×” ×¤×’×™×¢×” ×‘××©×§×•×¤×™×, ×©×‘×™×¨×ª × ×’×¨×•×ª ×•× ×–×§×™ ×•× ×“×œ×™×–×.',
      spread: areas.length > 0 ? `×”×¤×’×™×¢×” ×‘×•×¦×¢×” ×‘${areas.join(', ')}.` : '',
      type: '××“×•×‘×¨ ×‘× ×–×§ ××›×•×•×Ÿ ×”× ×•×‘×¢ ××¤×¨×™×¦×” ×œ×¨×›×•×©.'
    },
    earthquake: {
      intro: '×‘×‘×“×™×§×” ×‘××§×•× ×œ××—×¨ ×¨×¢×™×“×ª ×”××“××”, × ××¦××• × ×–×§×™× ×§×•× ×¡×˜×¨×•×§×˜×™×‘×™×™×.',
      detail: '×”×¨×¢×™×“×” ×’×¨××” ×œ×¡×“×§×™×, ×”×ª××•×˜×˜×•×ª ×—×œ×§×™×ª ×•× ×–×§×™× ××‘× ×™×™×.',
      spread: areas.length > 0 ? `×”× ×–×§×™× ×–×•×”×• ×‘${areas.join(', ')}.` : '',
      type: '××“×•×‘×¨ ×‘× ×–×§ × ×¨×—×‘ ×”× ×•×‘×¢ ××›×•×— ×˜×‘×¢.'
    },
    other: {
      intro: '×‘×‘×“×™×§×” ×‘××§×•× × ××¦× ×›×™ ×”× ×–×§ × ×’×¨× ×¢×§×‘',
      detail: '',
      spread: areas.length > 0 ? `×”× ×–×§ ×›×œ×œ ××ª ×”××–×•×¨×™×: ${areas.join(', ')}.` : '',
      type: ''
    }
  };

  const tpl = templates[eventType] || templates.other;
  let text = tpl.intro + '\n\n';
  if (tpl.detail) text += tpl.detail + '\n';
  if (tpl.spread) text += tpl.spread + '\n';
  if (damageTypes.length > 0) {
    text += `\n×”× ×–×§ ×›×œ×œ: ${damageTypes.join(', ')}.`;
  }
  if (tpl.type) text += '\n\n' + tpl.type;
  
  text += '\n\n×××¦××™ ×”×‘×“×™×§×” ×ª×•×××™× ××ª ×¡×™×× ×™ ×”× ×–×§ ×©× ×¦×¤×• ×‘××•×§×“×™ ×”××™×¨×•×¢.';

  const ta = document.getElementById('causeConclusion');
  if (ta) ta.value = text;
}

// ====== BUILD REPORT ======
function buildReport() {
  console.log('ğŸ” Building report...');
  console.log('Selected event:', selectedEvent);
  console.log('Insured name:', val('insuredName'));
  console.log('Policy num:', val('policyNum'));
  console.log('BOQ sections:', boqSections.length);
  
  const evLabels = {fire:'×©×¨×™×¤×”',water:'× ×–×§×™ ××™×',break_in:'×¤×¨×™×¦×”',earthquake:'×¨×¢×™×“×ª ××“××”',other:'××—×¨'};
  const evIcons = {fire:'ğŸ”¥',water:'ğŸ’§',break_in:'ğŸ”“',earthquake:'ğŸŒ',other:'ğŸ“‹'};

  const rows = getDamageRows();
  const cfg = selectedPolicyType ? POLICY_CONFIG[selectedPolicyType] : null;

  const vatActive = document.querySelector('#vatCalc .radio-btn.active')?.textContent === '×›×œ×•×œ';
  const mult = vatActive ? 1.18 : 1;

  let coveredGross = 0, uncoveredGross = 0;
  rows.forEach(r => { r.isCovered ? coveredGross += r.price : uncoveredGross += r.price; });
  const coveredWithVat = coveredGross * mult;
  const uncoveredWithVat = uncoveredGross * mult;
  const gross = coveredWithVat;

  const deductible = parseFloat(val('deductible')) || 0;
  const depreciation = parseFloat(val('depreciation')) || 0;
  const extra = parseFloat(val('extraCosts')) || 0;
  const rental = parseFloat(val('rentalTotal')) || 0;
  const net = Math.max(0, gross - deductible - depreciation + extra + rental);

  const areas = getCheckedLabels('damagedAreas');
  const coverageDecision = getRadioValue('coverageDecision');
  const repairTime = getRadioValue('repairTime');
  const propUsable = getRadioValue('propUsable');

  // Under-insurance calculation
  const structLimit = parseFloat(val('structureCoverageLimit')) || 0;
  const structAppraised = parseFloat(val('structureAppraisedValue')) || 0;
  const contentsLimit = parseFloat(val('contentsCoverageLimit')) || 0;
  const contentsAppraised = parseFloat(val('contentsAppraisedValue')) || 0;
  const structRatio = structAppraised > 0 ? Math.min(1, structLimit / structAppraised) : 1;
  const contentsRatio = contentsAppraised > 0 ? Math.min(1, contentsLimit / contentsAppraised) : 1;

  let eventDetails = '';
  if (selectedEvent === 'fire') {
    eventDetails = `
      <h2>ğŸ”¥ ×××¦××™ ×©×¨×™×¤×”</h2>
      <dl class="rp-meta">
        <dt>××§×•×¨ ×”×“×œ×§×”</dt><dd>${val('fireCause') || 'â€”'}</dd>
        <dt>×”×™×§×£ ×”×©×¨×™×¤×”</dt><dd>${getRadioValue('fireScope') || 'â€”'}</dd>
        <dt>× ×–×§×™ ×¢×©×Ÿ ×•×¤×™×—</dt><dd>${getRadioValue('smokeScope') || 'â€”'}</dd>
        <dt>×”×¤×¢×œ×ª ××˜×£</dt><dd>${getRadioValue('fireExtinguisher') || 'â€”'}</dd>
        <dt>×”×ª×¢×¨×‘×•×ª ××›×‘×™ ××©</dt><dd>${getRadioValue('fireFighters') || 'â€”'}</dd>
      </dl>`;
  } else if (selectedEvent === 'water') {
    eventDetails = `
      <h2>ğŸ’§ ×××¦××™ × ×–×§×™ ××™×</h2>
      <dl class="rp-meta">
        <dt>××§×•×¨ ×”× ×–×™×œ×”</dt><dd>${val('waterSource') || 'â€”'}</dd>
        <dt>××©×š ×”× ×–×™×œ×”</dt><dd>${val('waterDuration') || 'â€”'}</dd>
        <dt>×’×•×‘×” ××™×</dt><dd>${val('waterLevel') || 'â€”'}</dd>
        <dt>×¢×•×‘×© / ×œ×—×•×ª</dt><dd>${getRadioValue('moldPresent') || 'â€”'}</dd>
        <dt>×ª×™×§×•×Ÿ ×”×¦× ×¨×ª</dt><dd>${getRadioValue('waterFixed') || 'â€”'}</dd>
      </dl>`;
  } else if (selectedEvent === 'break_in') {
    eventDetails = `
      <h2>ğŸ”“ ×××¦××™ ××™×¨×•×¢ ×”×¤×¨×™×¦×”</h2>
      <dl class="rp-meta">
        <dt>× ×§×•×“×ª ×›× ×™×¡×”</dt><dd>${val('entryPoint') || 'â€”'}</dd>
        <dt>××¢×¨×›×ª ××–×¢×§×”</dt><dd>${getRadioValue('alarmSystem') || 'â€”'}</dd>
        <dt>××¦×œ××•×ª ××‘×˜×—×”</dt><dd>${getRadioValue('cctv') || 'â€”'}</dd>
        <dt>××¡×¤×¨ ×ª×™×§ ××©×˜×¨×”</dt><dd>${val('policeCase') || 'â€”'}</dd>
        <dt>×›× ×™×¡×” ×‘×›×•×—</dt><dd>${getRadioValue('forcedEntry') || 'â€”'}</dd>
        <dt>×•× ×“×œ×™×–×</dt><dd>${getRadioValue('vandalism') || 'â€”'}</dd>
      </dl>`;
  }

  // Damage rows with coverage tags
  let coveredRows = '', uncoveredRows = '';
  rows.forEach(r => {
    const catTag = `<span class="dmg-cat ${r.isCovered ? (r.cat === 'contents' ? 'contents' : 'structure') : 'excluded-tag'}">${r.catLabel}</span>`;
    const priceStr = 'â‚ª' + Math.round(r.price * mult).toLocaleString('he-IL');
    const tr = `<tr ${!r.isCovered ? 'style="opacity:0.6;text-decoration:line-through;background:#fff5f5"' : ''}>
      <td>${catTag} ${r.desc}</td>
      <td>${r.qty || 'â€”'}</td>
      <td style="text-align:left">${priceStr}</td>
    </tr>`;
    if (r.isCovered) coveredRows += tr;
    else uncoveredRows += tr;
  });

  const fmtM = n => 'â‚ª' + Math.round(n).toLocaleString('he-IL');

  // Build underinsurance section for report
  let underinsuranceHtml = '';
  if (structLimit > 0 && structAppraised > 0) {
    const sRatio = Math.round((structLimit / structAppraised) * 100);
    const sColor = sRatio >= 100 ? '#16a34a' : sRatio >= 80 ? '#d97706' : '#dc2626';
    underinsuranceHtml += `<tr><td>××‘× ×”</td><td>${fmtM(structLimit)}</td><td>${fmtM(structAppraised)}</td><td style="color:${sColor};font-weight:700">${sRatio}%</td><td style="color:${sRatio<100?'#dc2626':'#16a34a'}">${sRatio<100?fmtM(structAppraised-structLimit)+' â€” ×ª×ª ×‘×™×˜×•×—':'×›×™×¡×•×™ ××œ×'}</td></tr>`;
  }
  if (cfg?.contents && contentsLimit > 0 && contentsAppraised > 0) {
    const cRatio = Math.round((contentsLimit / contentsAppraised) * 100);
    const cColor = cRatio >= 100 ? '#16a34a' : cRatio >= 80 ? '#d97706' : '#dc2626';
    underinsuranceHtml += `<tr><td>×ª×›×•×œ×”</td><td>${fmtM(contentsLimit)}</td><td>${fmtM(contentsAppraised)}</td><td style="color:${cColor};font-weight:700">${cRatio}%</td><td style="color:${cRatio<100?'#dc2626':'#16a34a'}">${cRatio<100?fmtM(contentsAppraised-contentsLimit)+' â€” ×ª×ª ×‘×™×˜×•×—':'×›×™×¡×•×™ ××œ×'}</td></tr>`;
  }

  // Extensions list
  const extensions = Array.from(document.querySelectorAll('#extensionsGrid .checkbox-item.checked .cb-label')).map(e => e.textContent.trim());
  const extraExt = val('extraExtensions');
  if (extraExt) extensions.push(extraExt);

  const fmt = d => d ? new Date(d).toLocaleDateString('he-IL') : 'â€”';
  const reportDate = val('reportDate')
    ? new Date(val('reportDate')).toLocaleDateString('he-IL', {year:'numeric',month:'long',day:'numeric'})
    : new Date().toLocaleDateString('he-IL', {year:'numeric',month:'long',day:'numeric'});
  const visitDateFmt  = fmt(val('visitDate'));
  const eventDateFmt  = fmt(val('eventDate'));
  const lastDocFmt    = fmt(val('lastDocDate'));
  const policyFromFmt = fmt(val('policyFrom'));
  const policyToFmt   = fmt(val('policyTo'));

  // Rental section
  const rentalHTML = (propUsable === '×œ×' && rental > 0) ? `
    <h2>ğŸ˜ï¸ ×¤×™×¦×•×™ ×©×›×™×¨×•×ª ×—×œ×•×¤×™×ª</h2>
    <dl class="rp-meta">
      <dt>×©×›×¨ ×“×™×¨×” ×—×•×“×©×™</dt><dd>${fmtM(parseFloat(val('rentalMonthly'))||0)}</dd>
      <dt>××¡×¤×¨ ×—×•×“×©×™×</dt><dd>${val('rentalMonths') || 'â€”'}</dd>
      <dt>×‘×¡×™×¡ ×”×”×¢×¨×›×”</dt><dd>${val('rentalBasis') || 'â€”'}</dd>
      <dt>×¡×”"×› ×¤×™×¦×•×™ ×©×›×™×¨×•×ª</dt><dd style="font-weight:700;color:#1e40af">${fmtM(rental)}</dd>
    </dl>
    ${val('rentalNotes') ? `<p><strong>×”×¢×¨×•×ª:</strong> ${val('rentalNotes')}</p>` : ''}` : '';

  document.getElementById('reportOutput').innerHTML = `
    <div class="rp-header">
      <div class="rp-logo" style="width:56px;height:56px;background:linear-gradient(135deg,#d4a853,#b8892f);border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:'Frank Ruhl Libre',serif;font-weight:900;font-size:24px;color:#0f1419;margin:0 auto 1rem;box-shadow:0 4px 16px rgba(212,168,83,0.3)">×™×´×</div>
      <div class="rp-title">×™×¨×•×Ÿ ×××™×¨ â€“ ×©×××™ ×¨×›×•×© ××•×¡××š</div>
      <div class="rp-title" style="font-size:1.3rem;font-weight:600;margin-top:0.25rem">×—×•×•×ª ×“×¢×ª ×©×××™</div>
      <div class="rp-sub">
        ${selectedEvent ? `${evIcons[selectedEvent] || ''} ${evLabels[selectedEvent] || ''}` : '×”×¢×¨×›×ª × ×–×§'}
        &nbsp;|&nbsp; ${reportDate}
      </div>
    </div>

    <h2>ğŸ—‚ï¸ ×¤×¨×§ ××³ â€“ ×¤×¨×˜×™ ×”×¤×¨×•×™×§×˜</h2>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">

      <div>
        <h3 style="font-size:0.88rem;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">ğŸ‘¤ ×¤×¨×˜×™ ×”××‘×•×˜×—</h3>
        <dl class="rp-meta">
          <dt>×©× ××œ×</dt><dd><strong>${val('insuredName') || 'â€”'}</strong></dd>
          <dt>××¡×¤×¨ ×ª.×–. / ×—.×¤.</dt><dd>${val('insuredId') || 'â€”'}</dd>
          <dt>×˜×œ×¤×•×Ÿ</dt><dd>${val('insuredPhone') || 'â€”'}</dd>
          <dt>×“×•×"×œ</dt><dd>${val('insuredEmail') || 'â€”'}</dd>
          <dt>×›×ª×•×‘×ª ×”× ×›×¡</dt><dd>${val('propAddress') || val('propStreet') || 'â€”'}</dd>
          <dt>×§×©×¨ ×œ× ×›×¡</dt><dd>${val('insuredRelation') || 'â€”'}</dd>
        </dl>
      </div>

      <div>
        <h3 style="font-size:0.88rem;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">ğŸ›¡ï¸ ×¤×¨×˜×™ ×”×¤×•×œ×™×¡×”</h3>
        <dl class="rp-meta">
          <dt>×—×‘×¨×ª ×‘×™×˜×•×—</dt><dd><strong>${val('insuranceCompany') || 'â€”'}</strong></dd>
          <dt>××¡×¤×¨ ×¤×•×œ×™×¡×”</dt><dd>${val('policyNum') || 'â€”'}</dd>
          <dt>××¡×¤×¨ ×ª×‘×™×¢×”</dt><dd>${val('claimNum') || 'â€”'}</dd>
          <dt>×ª×§×•×¤×ª ×‘×™×˜×•×—</dt><dd>${policyFromFmt} â€“ ${policyToFmt}</dd>
          <dt>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª</dt><dd>${val('deductible') ? fmtM(parseFloat(val('deductible'))) : 'â€”'}</dd>
          <dt>×©×××™ ×××•× ×”</dt><dd>${val('adjustorName') || 'â€”'}</dd>
        </dl>
      </div>

    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">

      <div>
        <h3 style="font-size:0.88rem;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">ğŸ“… ×ª××¨×™×›×™× ××¨×›×–×™×™×</h3>
        <dl class="rp-meta">
          <dt>×ª××¨×™×š ×§×¨×•×ª ×”××§×¨×”</dt><dd><strong>${eventDateFmt}</strong></dd>
          <dt>×ª××¨×™×š ×‘×™×§×•×¨ ×‘× ×›×¡</dt><dd>${visitDateFmt}</dd>
          <dt>××¡××š ××—×¨×•×Ÿ ××”×—×‘×¨×”</dt><dd>${lastDocFmt}</dd>
          <dt>×ª××¨×™×š ×”×¤×§×ª ×”×“×•×—</dt><dd>${reportDate}</dd>
        </dl>
      </div>

      <div>
        <h3 style="font-size:0.88rem;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">ğŸ›ï¸ ×¤×¨×˜×™ ×”×©×××™ ×”××“×•×•×—</h3>
        <dl class="rp-meta">
          <dt>×©× ×”×©×××™</dt><dd><strong>${val('appraisalName') || '×™×¨×•×Ÿ ×××™×¨'}</strong></dd>
          <dt>××¡×¤×¨ ×¨×™×©×™×•×Ÿ</dt><dd>${val('appraisalLicense') || 'â€”'}</dd>
          <dt>×—×‘×¨×ª ×©×××•×ª</dt><dd>${val('appraisalFirm') || 'â€”'}</dd>
        </dl>
      </div>

    </div>

    <h2>ğŸ›¡ï¸ ×¤×¨×˜×™ ×”×¤×•×œ×™×¡×” â€“ ×›×™×¡×•×™ ×•×’×‘×•×œ×•×ª</h2>
    <dl class="rp-meta">
      <dt>×¡×•×’ ×¤×•×œ×™×¡×”</dt><dd>${cfg ? cfg.label : 'â€”'}</dd>
      <dt>×›×™×¡×•×™ ××‘× ×”</dt><dd>${cfg ? (cfg.structure ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×') : 'â€”'}</dd>
      <dt>×›×™×¡×•×™ ×ª×›×•×œ×”</dt><dd>${cfg ? (cfg.contents ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×') : 'â€”'}</dd>
      <dt>×’×‘×•×œ ×›×™×¡×•×™ ××‘× ×”</dt><dd>${val('structureCoverageLimit') ? fmtM(parseFloat(val('structureCoverageLimit'))) : 'â€”'}</dd>
      <dt>×’×‘×•×œ ×›×™×¡×•×™ ×ª×›×•×œ×”</dt><dd>${val('contentsCoverageLimit') ? fmtM(parseFloat(val('contentsCoverageLimit'))) : 'â€”'}</dd>
      <dt>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª ××‘× ×”</dt><dd>${val('policyDeductibleStructure') || 'â€”'}</dd>
      <dt>×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª ×ª×›×•×œ×”</dt><dd>${val('policyDeductibleContents') || 'â€”'}</dd>
      <dt>×‘×¡×™×¡ ×¤×™×¦×•×™ ×ª×›×•×œ×”</dt><dd>${(() => {
        const basis = val('contentsCompensationBasis');
        const map = {
          'replacement': '×¢×¨×š ×›×™× ×•×Ÿ (×—×“×© ×ª×—×ª ×™×©×Ÿ)',
          'actual': '×¢×¨×š ×‘×¤×•×¢×œ (×‘× ×™×›×•×™ ×¤×—×ª)',
          'agreed': '×¢×¨×š ××•×¡×›×'
        };
        return map[basis] || basis || 'â€”';
      })()}</dd>
    </dl>
    ${extensions.length ? `<p><strong>×”×¨×—×‘×•×ª ×¤×¢×™×œ×•×ª:</strong> ${extensions.join(' â€¢ ')}</p>` : ''}

    ${underinsuranceHtml ? `
    <h2>âš–ï¸ ×”×œ×™××•×ª ×‘×™×˜×•×— ×•×ª×ª-×‘×™×˜×•×—</h2>
    <table>
      <thead><tr><th>×¡×•×’</th><th>×’×‘×•×œ ×›×™×¡×•×™</th><th>×©×•×•×™ ×©×××™</th><th>×©×™×¢×•×¨</th><th>×”×¢×¨×”</th></tr></thead>
      <tbody>${underinsuranceHtml}</tbody>
    </table>
    ${val('underinsuranceNotes') ? `<p style="margin-top:8px"><strong>×”×¢×¨×•×ª:</strong> ${val('underinsuranceNotes')}</p>` : ''}` : ''}

    <h2>ğŸ  ×¤×¨×˜×™ ×”× ×›×¡</h2>
    <dl class="rp-meta">
      <dt>×›×ª×•×‘×ª</dt><dd>${[val('propStreet'), val('propNum'), val('propApt') ? '×“×™×¨×” ' + val('propApt') : ''].filter(Boolean).join(' ') || 'â€”'}</dd>
      <dt>×¢×™×¨</dt><dd>${val('propCity') || 'â€”'}</dd>
      <dt>×¡×•×’ × ×›×¡</dt><dd>${val('propType') || 'â€”'}</dd>
      <dt>×©×˜×— (×"×¨)</dt><dd>${val('propArea') ? val('propArea') + ' ×"×¨' : 'â€”'}</dd>
      <dt>×©× ×ª ×‘× ×™×™×”</dt><dd>${val('propYear') || 'â€”'}</dd>
      <dt>×—×•××¨ ×‘× ×™×™×”</dt><dd>${val('propMaterial') || 'â€”'}</dd>
      <dt>××¦×‘ ×œ×¤× ×™ ×”××™×¨×•×¢</dt><dd>${val('propConditionBefore') || 'â€”'}</dd>
      <dt>× ×›×¡ × ×™×ª×Ÿ ×œ×©×™××•×©</dt><dd>${propUsable || 'â€”'}</dd>
    </dl>

    <h2>${evIcons[selectedEvent] || 'ğŸ“‹'} ×¤×¨×˜×™ ×”××™×¨×•×¢</h2>
    <dl class="rp-meta">
      <dt>×ª××¨×™×š</dt><dd>${eventDateFmt}</dd>
      <dt>×©×¢×”</dt><dd>${val('eventTime') || 'â€”'}</dd>
      <dt>×›×™×¦×“ × ×ª×’×œ×”</dt><dd>${val('discoveryMethod') || 'â€”'}</dd>
      <dt>×“×•×•×— ×œ×¨×©×•×™×•×ª</dt><dd>${getRadioValue('reportedToAuth') || 'â€”'}</dd>
    </dl>
    ${val('eventBrief') ? `<p style="margin-top:8px"><strong>×ª×™××•×¨ ×”××™×¨×•×¢:</strong> ${val('eventBrief')}</p>` : ''}

    ${eventDetails}

    <h2>ğŸ” ×ª×™××•×¨ ×”× ×–×§</h2>
    ${areas.length ? `<p><strong>××–×•×¨×™× ×©× ×¤×’×¢×•:</strong> ${areas.join(', ')}</p>` : ''}
    ${getRadioValue('damageSeverity') ? `<p><strong>×—×•××¨×ª ×”× ×–×§:</strong> ${getRadioValue('damageSeverity')}</p>` : ''}
    ${val('damageDescription') ? `<p style="white-space:pre-line">${val('damageDescription')}</p>` : ''}

    ${val('causeConclusion') ? `
    <h2>ğŸ” ×§×‘×™×¢×ª ×¡×™×‘×ª ×”× ×–×§</h2>
    <p style="white-space:pre-line">${val('causeConclusion')}</p>
    ` : ''}

    <h2>ğŸ’° ×›×ª×‘ ×›××•×™×•×ª ×•×ª××—×•×¨</h2>
    ${(() => {
      const boqData = getBoqData();
      const vatActive = document.querySelector('#vatCalc .radio-btn.active')?.textContent?.includes('18%') ||
                        document.querySelector('#vatCalc .radio-btn.active')?.textContent?.includes('×›×•×œ×œ');
      const mult = vatActive ? 1.18 : 1;

      if (!boqData.length || boqData.every(s => s.rows.length === 0)) {
        return '<p style="color:#94a3b8">×œ× ×”×•×–× ×• ×¤×¨×™×˜×™ × ×–×§.</p>';
      }

      let html = '';
      let grandTotal = 0;

      boqData.forEach(sec => {
        if (sec.rows.length === 0) return;
        grandTotal += sec.secTotal;
        html += `
          <div style="margin-bottom:1.5rem">
            <div style="font-weight:700;font-size:0.95rem;color:#0f1419;background:#f1f5f9;padding:8px 14px;border-right:4px solid #d4a853;margin-bottom:0">
              ${sec.sectionNum}. ${sec.title}
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:0.84rem">
              <thead>
                <tr style="background:#f8fafc">
                  <th style="padding:6px 10px;text-align:right;border:1px solid #e2e8f0;width:52px;color:#64748b">×¡×¢×™×£</th>
                  <th style="padding:6px 10px;text-align:right;border:1px solid #e2e8f0;color:#64748b">×ª×™××•×¨ ×¢×‘×•×“×”</th>
                  <th style="padding:6px 10px;text-align:center;border:1px solid #e2e8f0;width:70px;color:#64748b">×™×—'</th>
                  <th style="padding:6px 10px;text-align:center;border:1px solid #e2e8f0;width:65px;color:#64748b">×›××•×ª</th>
                  <th style="padding:6px 10px;text-align:left;border:1px solid #e2e8f0;width:90px;color:#64748b">××—×™×¨ ×™×—'</th>
                  <th style="padding:6px 10px;text-align:left;border:1px solid #e2e8f0;width:100px;color:#64748b">×¡×”"×› (â‚ª)</th>
                </tr>
              </thead>
              <tbody>
                ${sec.rows.map(row => `
                  <tr>
                    <td style="padding:6px 10px;border:1px solid #e2e8f0;text-align:center;color:#94a3b8;font-size:0.78rem">${row.subNum}</td>
                    <td style="padding:6px 10px;border:1px solid #e2e8f0">${row.desc}</td>
                    <td style="padding:6px 10px;border:1px solid #e2e8f0;text-align:center;color:#64748b">${row.unit}</td>
                    <td style="padding:6px 10px;border:1px solid #e2e8f0;text-align:center">${row.qty}</td>
                    <td style="padding:6px 10px;border:1px solid #e2e8f0;text-align:left">â‚ª${row.price.toLocaleString('he-IL')}</td>
                    <td style="padding:6px 10px;border:1px solid #e2e8f0;text-align:left;font-weight:600">â‚ª${row.total.toLocaleString('he-IL')}</td>
                  </tr>`).join('')}
              </tbody>
              <tfoot>
                <tr style="background:#fef9ec">
                  <td colspan="5" style="padding:7px 14px;border:1px solid #e2e8f0;font-weight:700;color:#92400e;text-align:right">
                    ×¡×”"×› ${sec.title}:
                  </td>
                  <td style="padding:7px 14px;border:1px solid #e2e8f0;font-weight:800;color:#92400e;text-align:left">
                    â‚ª${sec.secTotal.toLocaleString('he-IL')}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>`;
      });

      const withVat = grandTotal * mult;
      const deductible   = parseFloat(val('deductible'))   || 0;
      const depreciation = parseFloat(val('depreciation')) || 0;
      const extra        = parseFloat(val('extraCosts'))   || 0;
      const rentalAmt    = parseFloat(val('rentalTotal'))  || 0;
      const net          = Math.max(0, withVat - deductible - depreciation + extra + rentalAmt);
      const fmtM = n => 'â‚ª' + Math.round(n).toLocaleString('he-IL');

      html += `
        <div style="margin-top:1rem;border:2px solid #d4a853;border-radius:8px;overflow:hidden">
          <div style="background:#fef9ec;padding:10px 16px;display:flex;justify-content:space-between;font-size:0.9rem">
            <span style="color:#92400e;font-weight:600">×¡×”"×› ×œ×¤× ×™ ××¢"×</span>
            <span style="font-weight:800;color:#92400e">${fmtM(grandTotal)}</span>
          </div>
          ${vatActive ? `<div style="background:#f8fafc;padding:8px 16px;display:flex;justify-content:space-between;font-size:0.87rem;border-top:1px solid #e2e8f0">
            <span style="color:#64748b">××¢"× 18%</span>
            <span style="color:#64748b">${fmtM(grandTotal * 0.18)}</span>
          </div>` : ''}
          <div style="background:#d4a853;padding:10px 16px;display:flex;justify-content:space-between">
            <span style="color:#0f1419;font-weight:700;font-size:0.95rem">×¡×”"×› ×›×•×œ×œ ××¢"×</span>
            <span style="color:#0f1419;font-weight:800;font-size:1.05rem">${fmtM(withVat)}</span>
          </div>
        </div>
        ${deductible ? `<p style="margin-top:8px;font-size:0.85rem">×‘× ×™×›×•×™ ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª: ${fmtM(deductible)}</p>` : ''}
        ${depreciation ? `<p style="font-size:0.85rem">×‘× ×™×›×•×™ ×™×¨×™×“×ª ×¢×¨×š: ${fmtM(depreciation)}</p>` : ''}
        ${rentalAmt ? `<p style="font-size:0.85rem">×¤×™×¦×•×™ ×©×›×™×¨×•×ª: + ${fmtM(rentalAmt)}</p>` : ''}
        <div style="background:#0f1419;color:white;padding:12px 18px;border-radius:8px;display:flex;justify-content:space-between;margin-top:10px">
          <span style="font-weight:700;font-size:0.95rem">ğŸ’ ×¡×›×•× ×œ×ª×©×œ×•× ××•×¦×¢</span>
          <span style="font-weight:800;color:#d4a853;font-size:1.1rem">${fmtM(net)}</span>
        </div>`;

      return html;
    })()}

    ${val('amountNotes') ? `<p style="margin-top:12px;font-size:0.85rem"><strong>×”×¢×¨×•×ª ×œ×¡×›×•×:</strong> ${val('amountNotes')}</p>` : ''}

    <h2>âš–ï¸ ××¡×§× ×•×ª ×•×©×™×§×•×œ×™×</h2>
    ${coverageDecision ? `<p><strong>×§×‘×™×¢×ª ×›×™×¡×•×™:</strong> ${coverageDecision}</p>` : ''}
    ${val('circumstances') ? `<p><strong>× ×¡×™×‘×•×ª ××—××™×¨×•×ª / ××§×œ×•×ª:</strong> ${val('circumstances')}</p>` : ''}
    ${val('repairPriority') ? `<p><strong>×”××œ×¦×•×ª ×œ×©×™×§×•×:</strong> ${val('repairPriority')}</p>` : ''}
    ${repairTime ? `<p><strong>×–××Ÿ ×©×™×§×•× ××©×•×¢×¨:</strong> ${repairTime}</p>` : ''}
    ${val('generalNotes') ? `<p><strong>×”×¢×¨×•×ª ×›×œ×œ×™×•×ª:</strong> ${val('generalNotes')}</p>` : ''}

    ${photos.length ? `
    <h2>ğŸ“¸ ×ª×™×¢×•×“ ×¦×™×œ×•××™</h2>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
      ${photos.slice(0, 9).map(p => `<div style="aspect-ratio:1;overflow:hidden;border-radius:6px;border:1px solid #e2e8f0">
        <img src="${p.src}" style="width:100%;height:100%;object-fit:cover">
        ${p.caption ? `<p style="font-size:0.7rem;color:#64748b;padding:4px">${p.caption}</p>` : ''}
      </div>`).join('')}
    </div>` : ''}

    ${val('evaluationExplanation') ? `
    <div style="margin-top:2rem;padding-top:1.5rem;border-top:2px solid #e2e8f0">
      <h2 style="margin-bottom:0.75rem">ğŸ“ ×¤×¨×§ 5 â€“ ×”×¡×‘×¨×™× ×œ×”×¢×¨×›×”</h2>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-right:4px solid #d4a853;border-radius:0 8px 8px 0;padding:1rem 1.25rem;font-size:0.9rem;color:#334155;line-height:1.9;white-space:pre-line">${val('evaluationExplanation')}</div>
    </div>` : ''}

    <div style="margin-top:2rem;padding-top:1.5rem;border-top:2px solid #e2e8f0">
      <h2 style="margin-bottom:0.75rem">ğŸ–Šï¸ ×”×¦×”×¨×ª ×©×××™</h2>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-right:4px solid #d4a853;border-radius:0 8px 8px 0;padding:1.25rem 1.5rem;font-size:0.9rem;color:#334155;line-height:2;white-space:pre-line">${val('appraisalDeclaration') || `×× ×™ ×”×—"× ××¦×”×™×¨ ×›×™ ×—×•×•×ª ×“×¢×ª ×–×• × ×¢×¨×›×” ×¢×œ ×™×“×™ ×‘××•×¤×Ÿ ××§×¦×•×¢×™, ×¢×¦×××™ ×•×‘×œ×ª×™ ×ª×œ×•×™, ×‘×”×ª×× ×œ×××¦××™× ×©× ×¦×¤×• ×‘×‘×™×§×•×¨ ×‘× ×›×¡ ×•×œ× ×ª×•× ×™× ×©×¢××“×• ×‘×¤× ×™×™ ×‘××•×¢×“ ×¢×¨×™×›×ª ×”×“×•"×—.\n×”×”×¢×¨×›×” ×‘×•×¦×¢×” ×‘×”×ª×× ×œ×›×œ×œ×™× ×”××§×•×‘×œ×™× ×‘×ª×—×•× ×©×××•×ª ×”×¨×›×•×© ×•×¢×œ ×‘×¡×™×¡ × ×™×¡×™×•×Ÿ ××§×¦×•×¢×™ ×•××§×•×¨×•×ª ×ª××—×•×¨ ××§×•×‘×œ×™×.\n×—×•×•×ª ×“×¢×ª ×–×• ××™×•×¢×“×ª ×œ×”×¢×¨×›×ª ×”× ×–×§ × ×©×•× ×”××™×¨×•×¢ ×‘×œ×‘×“.`}</div>
    </div>

    <div class="rp-signature" style="margin-top:2.5rem">
      <div class="sig-box">
        <div style="height:50px"></div>
        <div style="border-top:1px solid #94a3b8;padding-top:6px;text-align:center">×—×ª×™××ª ×”×©×××™</div>
        <div style="font-size:0.78rem;margin-top:4px;color:#475569">×™×¨×•×Ÿ ×××™×¨</div>
        <div style="font-size:0.72rem;color:#94a3b8">×©×××™ ×¨×›×•×©</div>
      </div>
      <div style="text-align:center;font-size:0.78rem;color:#94a3b8;margin-top:auto;padding-bottom:6px">
        <div style="font-size:1rem;margin-bottom:4px">ğŸ›ï¸</div>
        <div>×ª××¨×™×š ×”×¤×§×ª ×”×“×•×—:</div>
        <div style="font-weight:600;color:#475569;margin-top:2px">${reportDate}</div>
      </div>
      <div class="sig-box">
        <div style="height:50px"></div>
        <div style="border-top:1px solid #94a3b8;padding-top:6px;text-align:center">×—×ª×™××ª ×”××‘×•×˜×—</div>
        <div style="font-size:0.78rem;margin-top:4px;color:#475569">${val('insuredName') || '___________'}</div>
        <div style="font-size:0.72rem;color:#94a3b8">×ª.×–. ${val('insuredId') || '___________'}</div>
      </div>
    </div>
  `;
}
// ====== EMAIL FUNCTIONS ======
function openEmailModal() {
  const modal = document.getElementById('emailModal');
  modal.style.display = 'flex';
  // Pre-fill insured email if available
  const insuredName = document.getElementById('insuredName')?.value || '';
  const policyNum   = document.getElementById('policyNum')?.value || '';
  if (insuredName) {
    document.getElementById('emailSubject').value =
      `×—×•×•×ª ×“×¢×ª ×©×××™ ×¨×›×•×© â€“ ×™×¨×•×Ÿ ×××™×¨ | ${insuredName}${policyNum ? ' | ×¤×•×œ×™×¡×” ' + policyNum : ''}`;
    document.getElementById('emailBody').value =
      `×œ×›×‘×•×“ ${insuredName},\n\n××¦×•×¨×¤×ª ×—×•×•×ª ×”×“×¢×ª ×”×©×××™×ª ×©×”×•×›× ×” ×¢×‘×•×¨×š ×‘×’×™×Ÿ ×”××™×¨×•×¢ ×”× "×œ.\n\n×‘×›×œ ×©××œ×” × ×™×ª×Ÿ ×œ×¤× ×•×ª ××œ×™× ×•.\n\n×‘×›×‘×•×“,\n×™×¨×•×Ÿ ×××™×¨ â€“ ×©×××™ ×¨×›×•×©`;
  }
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

function sendByEmail() {
  const to      = document.getElementById('emailInsured')?.value?.trim() || '';
  const cc      = document.getElementById('emailCC')?.value?.trim()      || '';
  const subject = document.getElementById('emailSubject')?.value         || '×—×•×•×ª ×“×¢×ª ×©×××™ ×¨×›×•×©';
  const body    = document.getElementById('emailBody')?.value            || '';

  if (!to) { showToast('× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™×™×œ', 'error'); return; }

  // Build mailto link (body is plain text summary, full report via download)
  const bodyText = body + '\n\n---\n[×”×“×•×— ×”××œ× ××¦×•×¨×£ ×›×§×•×‘×¥ HTML - × ×™×ª×Ÿ ×œ×¤×ª×•×— ×‘×›×œ ×“×¤×“×¤×Ÿ]\n\n×¡×›×•× ×”×¢×¨×›×”: ' +
    (document.getElementById('totalGross')?.textContent || '') + '\n×œ×ª×©×œ×•×: ' +
    (document.getElementById('totalNet')?.textContent || '');

  const params = new URLSearchParams();
  if (cc) params.set('cc', cc);
  params.set('subject', subject);
  params.set('body', bodyText);

  const mailto = `mailto:${encodeURIComponent(to)}?${params.toString()}`;
  window.location.href = mailto;

  // Auto-download the HTML file too
  setTimeout(() => downloadHtmlReport(), 500);
  closeEmailModal();
  showToast('×¤×•×ª×— ×ª×•×›× ×ª ××™×™×œ ×•×˜×•×¢×Ÿ ×”×•×¨×“×ª ×”×§×•×‘×¥...', 'success');
}

function downloadHtmlReport() {
  const reportContent = document.getElementById('reportOutput')?.innerHTML || '';
  const insuredName = document.getElementById('insuredName')?.value || '××‘×•×˜×—';
  const dateStr = new Date().toLocaleDateString('he-IL').replace(/\//g, '-');

  const fullHtml = `<!DOCTYPE html><html lang="he" dir="rtl">
<head><meta charset="UTF-8">
<title>×—×•×•×ª ×“×¢×ª ×©×××™ â€“ ${insuredName}</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Heebo', sans-serif; direction: rtl; max-width: 900px; margin: 40px auto; padding: 20px; color: #1e293b; }
  h2 { color: #0f1419; border-bottom: 2px solid #d4a853; padding-bottom: 6px; margin-top: 2rem; }
  table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
  th { background: #f8fafc; padding: 8px 12px; border: 1px solid #e2e8f0; text-align: right; font-size: 0.85rem; color: #64748b; }
  td { padding: 7px 12px; border: 1px solid #e2e8f0; font-size: 0.87rem; }
  .rp-header { background: linear-gradient(135deg,#0f1419,#1e293b); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; }
  .rp-title { font-size: 1.6rem; font-weight: 800; margin: 0.5rem 0; }
  .rp-total { display: flex; justify-content: space-between; background: #1e293b; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; margin: 0.5rem 0; }
  dl { display: grid; grid-template-columns: 180px 1fr; gap: 4px 16px; margin: 1rem 0; }
  dt { color: #64748b; font-size: 0.85rem; padding: 4px 0; }
  dd { font-weight: 500; padding: 4px 0; border-bottom: 1px solid #f1f5f9; }
  .dmg-cat { display:inline-block;font-size:0.7rem;padding:2px 7px;border-radius:99px;font-weight:600;margin-left:4px; }
  .dmg-cat.structure { background:#dbeafe;color:#1d4ed8; }
  .dmg-cat.contents { background:#f3e8ff;color:#7e22ce; }
</style>
</head><body>${reportContent}</body></html>`;

  const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `×—×•×•×ª-×“×¢×ª-×©×××™-${insuredName}-${dateStr}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast('×”×“×•×— ×”×•×¨×“ ×‘×”×¦×œ×—×” âœ“');
}

function printReport() {
  const content = document.getElementById('reportOutput').innerHTML;
  const w = window.open('', '_blank');
  w.document.write(`
    <!DOCTYPE html><html lang="he" dir="rtl">
    <head><meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&family=Frank+Ruhl+Libre:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:'Heebo',sans-serif;direction:rtl;padding:2cm;color:#1a1a2e;line-height:1.7}
      h2{font-family:'Frank Ruhl Libre',serif;font-size:1.1rem;color:#0f1419;border-right:4px solid #d4a853;padding-right:10px;margin:1.5rem 0 0.75rem}
      .rp-header{text-align:center;border-bottom:3px solid #d4a853;padding-bottom:1.5rem;margin-bottom:2rem}
      .rp-title{font-family:'Frank Ruhl Libre',serif;font-size:1.8rem;font-weight:900}
      .rp-sub{font-size:0.9rem;color:#64748b}
      .rp-meta{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 2rem;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem 1.5rem;margin-bottom:1.5rem;font-size:0.88rem}
      dt{color:#64748b;font-weight:600}dd{color:#1a1a2e}
      table{width:100%;border-collapse:collapse;margin:0.75rem 0;font-size:0.88rem}
      th{background:#0f1419;color:white;padding:8px 12px;text-align:right;font-weight:600}
      td{padding:8px 12px;border-bottom:1px solid #e2e8f0}
      tr:nth-child(even) td{background:#f8fafc}
      .rp-total{background:#d4a853;color:white;padding:10px 14px;border-radius:6px;display:flex;justify-content:space-between;font-weight:700;margin-top:4px}
      .rp-signature{margin-top:2.5rem;padding-top:1.5rem;border-top:2px solid #e2e8f0;display:flex;justify-content:space-between;align-items:flex-end;font-size:0.85rem;color:#64748b}
      .sig-box{width:200px;text-align:center}
      p{font-size:0.9rem;color:#334155;margin-bottom:0.5rem;line-height:1.7}
      pre,div[style*="white-space:pre-line"]{white-space:pre-line;font-family:'Heebo',sans-serif}
      @media print{body{padding:1.5cm}}
    </style></head>
    <body>${content}</body></html>
  `);
  w.document.close();
  setTimeout(() => w.print(), 500);
}

function resetAll() {
  if (confirm('×”×× ×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™× ×•×œ×”×ª×—×™×œ ××—×“×©?')) {
    location.reload();
  }
}

function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 3000);
}

</script>
</body>
</html>
